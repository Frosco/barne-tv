# Test Design: Story 4.3 - Grace Video and Mascot Integration

Date: 2025-11-02
Designer: Quinn (Test Architect)
Story: 4.3 - Grace Video and Mascot Integration

## Test Strategy Overview

- **Total test scenarios:** 36
- **Unit tests:** 11 (31%)
- **Integration tests:** 15 (42%)
- **E2E tests:** 10 (28%)
- **Priority distribution:** P0: 18 (50%), P1: 13 (36%), P2: 5 (14%)

### Test Level Rationale

**Unit tests (31%)** - Focus on pure business logic that can be isolated:
- Grace state calculation logic
- Mid-video interruption decision algorithm
- Time until reset calculations
- Video duration filtering logic

**Integration tests (42%)** - Largest category due to complex state transitions and database interactions:
- Grace state machine with database queries
- API endpoint behavior in grace mode
- Grace video logging with correct flags
- Video filtering with SQL queries
- TIER 1 safety rule enforcement

**E2E tests (28%)** - Critical user journeys and UI validation:
- Complete grace flows (happy and unhappy paths)
- Mid-video interruption scenarios
- UI component rendering (mascot, countdown, Norwegian text)
- Cross-component interactions

### Priority Strategy

**P0 Critical (50%)** - TIER 1 safety rules and core grace functionality:
- Grace video exclusion from daily limits (child safety)
- Banned video filtering in grace mode (child safety)
- UTC timestamp enforcement (consistency)
- SQL injection prevention (security)
- Grace state machine correctness
- One-time grace constraint

**P1 High (36%)** - Core grace experience features:
- Duration filtering and fallback logic
- Mid-video interruption handling
- UI interaction and navigation
- Data logging accuracy

**P2 Medium (14%)** - Polish and error handling:
- Mascot image loading
- CSS animations
- Norwegian language validation
- Edge case error handling

---

## Test Scenarios by Acceptance Criteria

### AC1: Daily Limit Reached → Grace Screen Appears

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-UNIT-001 | Unit | P0 | Calculate grace state when limit reached, no grace consumed | Pure state calculation logic - test algorithm correctness in isolation |
| 4.3-UNIT-002 | Unit | P0 | Calculate locked state when grace already consumed | State machine branching logic - verify one-time grace constraint |
| 4.3-UNIT-003 | Unit | P1 | Calculate normal state on new day after grace consumed yesterday | State reset logic - verify daily reset works correctly |
| 4.3-INT-001 | Integration | P0 | GET /api/limit/status returns "grace" state when limit reached, grace not consumed | Database query + state calculation - verify correct state detection with real DB |
| 4.3-INT-002 | Integration | P0 | GET /api/limit/status returns "locked" state after grace consumed | State transition validation - ensure grace consumed blocks further access |
| 4.3-INT-003 | Integration | P1 | State resets to "normal" after midnight UTC | Date-based state logic - verify midnight rollover works correctly |
| 4.3-E2E-001 | E2E | P0 | Complete grace flow: watch videos → limit reached → grace screen appears → select grace video → goodbye screen | Critical user journey - validates entire happy path from user perspective |
| 4.3-E2E-003 | E2E | P0 | Grace consumed lockout: after grace video, no more videos until midnight | Critical constraint - ensures one-time grace enforcement works end-to-end |

**Coverage:** 8 tests across all levels ensuring grace screen appears at the right time and only once per day.

---

### AC2: Mascot Character Prominently Displayed

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-E2E-006 | E2E | P2 | Mascot images load and display throughout grace flow | Visual validation - ensure images render correctly in browser |
| 4.3-E2E-009 | E2E | P2 | Mascot displayed on grace screen with correct image (mascot-happy.png) | UI validation - verify correct mascot variant used |

**Coverage:** 2 E2E tests validating mascot display. No unit/integration tests needed (visual element only).

---

### AC3: Two Buttons Displayed ("See You Tomorrow!" / "One More Video?")

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-E2E-001 | E2E | P0 | Click "Ja, én til!" button → grace video grid appears | User interaction - validates button click triggers correct behavior |
| 4.3-E2E-002 | E2E | P0 | Click "Nei, ha det!" button → goodbye screen appears | User interaction - validates decline path works |

**Coverage:** 2 E2E tests validating button interaction. Covered in complete flow tests.

---

### AC4: "One More Video?" Allowed Once Per Day (Grace Video)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-UNIT-002 | Unit | P0 | Calculate locked state when grace already consumed | State logic - verify algorithm correctly detects grace consumed |
| 4.3-INT-002 | Integration | P0 | GET /api/limit/status returns "locked" after grace consumed | Database validation - ensure grace_play=1 count prevents second grace |
| 4.3-INT-004 | Integration | P0 | Grace consumed check queries watch_history for grace_play=1 correctly | Query correctness - verify SQL query logic for grace detection |
| 4.3-E2E-003 | E2E | P0 | After watching grace video, attempting to select another video shows goodbye screen | One-time constraint enforcement - validates lockout after grace consumed |

**Coverage:** 4 tests ensuring one-time grace constraint at all levels.

---

### AC5 & AC7: Grace Video Logged with grace_play=true Flag (TIER 1 Safety)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-INT-009 | Integration | P0 | POST /api/videos/watch with gracePlay=true sets grace_play=1 in database | API contract validation - ensure parameter correctly persisted |
| 4.3-INT-010 | Integration | P0 | Grace video logged with manual_play=0, grace_play=1, duration_watched_seconds | Data integrity - verify all required fields set correctly |
| 4.3-INT-011 | Integration | P0 | **TIER 1 SAFETY:** Grace videos excluded from daily limit calculation | Child safety critical - grace videos MUST NOT count toward next day's limit |
| 4.3-INT-012 | Integration | P0 | **TIER 1 SAFETY:** Grace video uses UTC timestamp | Time consistency - ensure UTC enforcement per TIER 1 Rule 3 |
| 4.3-INT-013 | Integration | P0 | **TIER 1 SAFETY:** Grace video logging uses SQL placeholders (no string interpolation) | SQL injection prevention - verify TIER 1 Rule 6 compliance |

**Coverage:** 5 integration tests ensuring grace video logging correctness. All P0 due to TIER 1 safety implications.

---

### AC6: After Grace Video, Only Goodbye Screen Shown

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-INT-015 | Integration | P1 | GET /goodbye renders goodbye.html template | Route validation - ensure goodbye endpoint works |
| 4.3-E2E-001 | E2E | P0 | After grace video completes, goodbye screen appears automatically | Navigation flow - validates correct screen transition |
| 4.3-E2E-002 | E2E | P0 | Declining grace video shows goodbye screen immediately | Alternative path - validates "Nei" button behavior |

**Coverage:** 3 tests ensuring goodbye screen appears after grace video or decline.

---

### AC8: Mascot Animation or Special Visual

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-E2E-006 | E2E | P2 | Mascot images render with CSS animation classes applied | Visual validation - ensure animations present (not testing smoothness) |

**Coverage:** 1 E2E test validating animation presence. P2 because animations are polish, not critical functionality.

---

### AC9: Goodbye Screen Includes Time Until Midnight UTC Reset

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-UNIT-007 | Unit | P1 | Calculate time until midnight UTC correctly (hours and minutes) | Date math logic - test calculation accuracy in isolation |
| 4.3-UNIT-008 | Unit | P1 | Calculate time until midnight handles timezone conversion correctly | UTC enforcement - ensure calculation uses UTC, not local time |
| 4.3-UNIT-009 | Unit | P1 | Time calculation at midnight boundary (23:59:59 → 00:00:00) | Edge case - verify calculation doesn't break at day boundary |
| 4.3-E2E-008 | E2E | P1 | Countdown to midnight displays on grace and goodbye screens and updates | UI validation - ensure countdown visible and formatted correctly |

**Coverage:** 4 tests (3 unit for logic, 1 E2E for display) ensuring countdown accuracy.

---

### AC10: All Text in Norwegian, Child-Friendly Language

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-E2E-009 | E2E | P2 | Norwegian messages displayed throughout grace flow | Language validation - spot-check Norwegian text rendering |

**Coverage:** 1 E2E test sampling Norwegian text. P2 because language is important but unlikely to break.

---

### AC11: Grace Video Selection Grid Shows 4-6 Videos

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-INT-006 | Integration | P1 | GET /api/videos in grace mode returns 4-6 videos (not 9) | API behavior - verify grace mode uses different grid size |
| 4.3-E2E-007 | E2E | P1 | Grace video grid displays 4-6 video cards visually | UI validation - ensure frontend renders correct number of cards |

**Coverage:** 2 tests (integration for API, E2E for UI) ensuring correct grid size.

---

### AC12: Grace Videos Filtered to Maximum 5 Minutes Duration

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-UNIT-010 | Unit | P1 | Filter videos to ≤300 seconds (5 minutes) | Filtering logic - test pure function in isolation |
| 4.3-INT-005 | Integration | P1 | GET /api/videos in grace mode filters to ≤5 minutes (300 seconds) | SQL query validation - ensure database filter works correctly |
| 4.3-E2E-001 | E2E | P1 | Grace video grid only shows videos ≤5 minutes | End-to-end validation - verify filter works from user perspective |

**Coverage:** 3 tests across all levels ensuring duration filter works correctly.

---

### AC13: Fallback to Shortest Videos if None Under 5 Minutes

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-UNIT-011 | Unit | P1 | Sort videos by duration ascending for shortest-first fallback | Sorting logic - test algorithm correctness |
| 4.3-INT-007 | Integration | P1 | When no videos ≤5 min, return shortest 6 videos sorted by duration | Fallback query - ensure SQL returns correct fallback set |
| 4.3-E2E-011 | E2E | P2 | Grace grid shows longest available videos when none under 5 minutes | Edge case validation - verify fallback works end-to-end |

**Coverage:** 3 tests ensuring fallback logic works when no short videos available.

---

### AC14: Mid-Video Limit Handling (Smart Interruption)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-UNIT-004 | Unit | P1 | should_interrupt_video returns False when video fits within 5-min grace period | Interruption logic - test decision algorithm with video fitting within grace |
| 4.3-UNIT-005 | Unit | P1 | should_interrupt_video returns True when video too long to finish | Interruption logic - test decision algorithm with video exceeding grace |
| 4.3-UNIT-006 | Unit | P1 | Edge case: video exactly at 5-minute boundary (minutes_remaining=0, video=5) | Boundary condition - verify behavior at exact threshold |
| 4.3-E2E-004 | E2E | P1 | Long video (8 min) interrupted when limit reached with 2 min remaining | User experience - validate interruption happens for long videos |
| 4.3-E2E-005 | E2E | P1 | Short video (3 min) allowed to finish when limit reached with 1 min remaining | User experience - validate video finishes when within grace period |

**Coverage:** 5 tests (3 unit for logic, 2 E2E for behavior) ensuring smart interruption works correctly.

---

### Additional TIER 1 Safety Tests

These tests validate critical child safety rules that MUST be enforced.

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-INT-008 | Integration | P0 | **TIER 1 SAFETY:** Grace mode still filters banned videos | Child safety critical - banned videos must NEVER appear, even in grace mode |

**Coverage:** 1 additional integration test ensuring banned video filtering in grace mode (TIER 1 Rule 1).

---

### Edge Cases and Error Handling

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.3-E2E-010 | E2E | P2 | Browser refresh on grace screen: state preserved and correct screen shown | Error handling - ensure refresh doesn't break grace flow |
| 4.3-E2E-011 | E2E | P2 | Grace grid fallback: when no videos under 5 min, show longest available | Edge case - verify graceful degradation when duration filter returns empty |

**Coverage:** 2 E2E tests for edge cases and error scenarios.

---

## Risk Coverage

### High-Risk Areas Addressed

**RISK-001: Grace videos incorrectly counted toward daily limits**
- Mitigated by: 4.3-INT-011 (TIER 1 test ensuring grace_play=1 excluded from calculations)
- Impact: Critical - would defeat grace video purpose
- Probability: Medium - easy to forget filter clause
- **Coverage: P0 Integration test**

**RISK-002: Banned videos shown in grace mode**
- Mitigated by: 4.3-INT-008 (TIER 1 test ensuring banned filter still applied)
- Impact: Critical - child safety violation
- Probability: Medium - grace mode might bypass filters
- **Coverage: P0 Integration test**

**RISK-003: Grace video allowed multiple times per day**
- Mitigated by: 4.3-UNIT-002, 4.3-INT-002, 4.3-INT-004, 4.3-E2E-003
- Impact: High - undermines daily limit system
- Probability: Low - state logic relatively simple
- **Coverage: P0 tests at all levels**

**RISK-004: SQL injection in grace video logging**
- Mitigated by: 4.3-INT-013 (TIER 1 test verifying SQL placeholders)
- Impact: Critical - security vulnerability
- Probability: Low - team follows TIER 1 rules
- **Coverage: P0 Integration test**

**RISK-005: UTC timezone not enforced for grace reset**
- Mitigated by: 4.3-INT-012 (TIER 1 test), 4.3-UNIT-008 (timezone handling)
- Impact: High - inconsistent reset times across users
- Probability: Medium - easy to use naive datetime
- **Coverage: P0 and P1 tests**

**RISK-006: Mid-video interruption logic incorrect**
- Mitigated by: 4.3-UNIT-004, 4.3-UNIT-005, 4.3-UNIT-006, 4.3-E2E-004, 4.3-E2E-005
- Impact: Medium - poor user experience (abrupt stops or overruns)
- Probability: Medium - logic has edge cases
- **Coverage: P1 tests at unit and E2E levels**

**RISK-007: No videos under 5 minutes causes empty grace grid**
- Mitigated by: 4.3-UNIT-011, 4.3-INT-007, 4.3-E2E-011
- Impact: High - child sees empty screen, grace video inaccessible
- Probability: Low - most content catalogs have short videos
- **Coverage: P1 and P2 tests**

---

## Recommended Execution Order

### Phase 1: TIER 1 Safety Tests (Fail Fast)
Run these P0 tests first to catch critical safety violations early:

1. **4.3-INT-011** - Grace videos excluded from daily limits (TIER 1 Rule 2)
2. **4.3-INT-008** - Banned videos filtered in grace mode (TIER 1 Rule 1)
3. **4.3-INT-012** - UTC timestamp enforcement (TIER 1 Rule 3)
4. **4.3-INT-013** - SQL injection prevention (TIER 1 Rule 6)

```bash
uv run pytest -m tier1 -v tests/backend/services/test_grace_video_logging.py
```

**Gate criteria:** All TIER 1 tests MUST pass. Do not proceed if any fail.

---

### Phase 2: P0 State Machine Tests
Verify core grace state transitions work correctly:

5. **4.3-UNIT-001** - Grace state calculation when limit reached
6. **4.3-UNIT-002** - Locked state when grace consumed
7. **4.3-INT-001** - API returns "grace" state
8. **4.3-INT-002** - API returns "locked" state after grace
9. **4.3-INT-004** - Grace consumed check query
10. **4.3-E2E-001** - Complete grace flow (happy path)
11. **4.3-E2E-003** - Grace lockout enforcement

```bash
uv run pytest tests/backend/services/test_grace_state.py -v
uv run pytest tests/backend/test_routes_grace.py::test_grace_state_* -v
npx playwright test tests/e2e/specs/grace-video-flow.spec.js::complete-grace-flow
```

---

### Phase 3: P0 Data Integrity Tests
Ensure grace video logging is correct:

12. **4.3-INT-009** - Grace video API parameter handling
13. **4.3-INT-010** - Grace video logged with correct flags

```bash
uv run pytest tests/backend/test_routes_grace.py::test_grace_video_logging* -v
```

---

### Phase 4: P1 Core Functionality Tests
Test duration filtering, interruption logic, UI components:

14. **4.3-UNIT-003** - State reset after midnight
15. **4.3-UNIT-004** to **4.3-UNIT-011** - Interruption and filtering logic
16. **4.3-INT-003** - Midnight state reset
17. **4.3-INT-005** to **4.3-INT-007** - Duration filtering and fallback
18. **4.3-INT-014** to **4.3-INT-015** - Route rendering
19. **4.3-E2E-002** - Grace declined flow
20. **4.3-E2E-004** to **4.3-E2E-005** - Mid-video interruption
21. **4.3-E2E-007** to **4.3-E2E-008** - UI components

```bash
uv run pytest tests/backend/ -v
npm test
npx playwright test tests/e2e/specs/grace-video-flow.spec.js
```

---

### Phase 5: P2 Polish and Edge Cases
Test mascot images, animations, language, error handling:

22. **4.3-E2E-006** - Mascot images
23. **4.3-E2E-009** - Norwegian language
24. **4.3-E2E-010** - Browser refresh
25. **4.3-E2E-011** - Fallback edge case

```bash
npx playwright test tests/e2e/specs/grace-video-flow.spec.js::edge-cases
```

---

## Test Execution Commands

### Backend Tests

```bash
# TIER 1 safety tests only (MUST PASS)
uv run pytest -m tier1 -v tests/backend/services/test_grace_video_logging.py

# All grace-related backend tests
uv run pytest tests/backend/services/test_grace_state.py -v
uv run pytest tests/backend/test_routes_grace.py -v

# With coverage
uv run pytest tests/backend/ -v --cov=backend.services.viewing_session --cov=backend.routes --cov-report=html
```

### Frontend Tests

```bash
# All grace screen tests
npm test -- grace-screen.test.js

# With coverage
npm run test:coverage
```

### E2E Tests

```bash
# Install Playwright if needed
npx playwright install chromium

# Run grace flow E2E tests
npx playwright test tests/e2e/specs/grace-video-flow.spec.js

# Run with UI mode for debugging
npx playwright test tests/e2e/specs/grace-video-flow.spec.js --ui

# Production environment
ENVIRONMENT=production npx playwright test tests/e2e/specs/grace-video-flow.spec.js
```

---

## Quality Checklist

Before finalizing implementation, verify:

- [x] Every AC has at least one test (14 ACs, all covered)
- [x] Test levels are appropriate (unit for logic, integration for DB, E2E for journeys)
- [x] No duplicate coverage across levels (tests cover different aspects)
- [x] Priorities align with business risk (TIER 1 safety = P0, core features = P1, polish = P2)
- [x] Test IDs follow naming convention (`4.3-{LEVEL}-{SEQ}`)
- [x] Scenarios are atomic and independent (each test can run in isolation)
- [x] TIER 1 safety tests identified and marked (5 tests with @pytest.mark.tier1)
- [x] Risk mitigations mapped to specific tests (7 risks covered)
- [x] All P0 tests have clear failure criteria
- [x] Test execution order prioritizes fast feedback (TIER 1 first, P0 before P1)

---

## Coverage Gaps

**None identified.** All 14 acceptance criteria have comprehensive test coverage at appropriate levels.

---

## Test Maintenance Considerations

### High Maintenance Risk
- **E2E tests (4.3-E2E-001 to 4.3-E2E-011):** Most brittle due to UI dependencies
  - Mitigation: Use data-testid attributes for element selection
  - Mitigation: Abstract common grace flow actions into helper functions

### Medium Maintenance Risk
- **Integration tests with time logic (4.3-INT-003, 4.3-INT-012):** Sensitive to clock changes
  - Mitigation: Use freezegun or similar time mocking
  - Mitigation: Always test with UTC timestamps

### Low Maintenance Risk
- **Unit tests (4.3-UNIT-001 to 4.3-UNIT-011):** Pure functions with no external dependencies
  - Stable and fast feedback

---

## Additional Notes

### TIER 1 Safety Test Requirements

The following tests MUST achieve 100% code coverage:

1. **4.3-INT-011** - Grace video exclusion from daily limits
   - Must cover: `WHERE grace_play = 0` clause in SQL query
   - Must cover: Sum calculation excluding grace videos
   - Must cover: Edge case where ALL videos are grace videos

2. **4.3-INT-008** - Banned video filtering in grace mode
   - Must cover: `NOT EXISTS (SELECT 1 FROM banned_videos)` clause
   - Must cover: Grace mode specifically (not just normal mode)

3. **4.3-INT-012** - UTC timestamp enforcement
   - Must cover: `datetime.now(timezone.utc)` usage
   - Must cover: Database storage as ISO 8601 UTC string

4. **4.3-INT-013** - SQL injection prevention
   - Must cover: All grace-related SQL queries use placeholders
   - Must cover: No f-strings or string concatenation in queries

### Test Data Requirements

Tests should include:
- Videos of varying durations: 1 min, 3 min, 5 min (boundary), 6 min, 10 min
- Multiple grace videos (to test count = 0 vs count >= 1)
- Mix of available and banned videos
- Watch history spanning multiple days (for UTC date handling)
- Edge timestamps: 23:59:59 UTC, 00:00:00 UTC, 00:00:01 UTC

### Performance Considerations

- Unit tests: Should complete in <100ms total
- Integration tests: Should complete in <5 seconds total (in-memory SQLite)
- E2E tests: Budget 2-3 minutes per test (full browser automation)

Total test suite execution time: ~20-25 minutes for full suite

---

## Summary

This test design provides **comprehensive coverage** of Story 4.3 with **36 test scenarios** strategically distributed across unit (31%), integration (42%), and E2E (28%) levels.

**Key Strengths:**
- **TIER 1 Safety First:** 5 critical safety tests (P0) ensure child safety rules enforced
- **Risk-Based Prioritization:** 50% P0 tests cover highest-risk areas
- **Defense in Depth:** Critical paths tested at multiple levels
- **No Coverage Gaps:** All 14 ACs have explicit test coverage
- **Clear Execution Order:** Fail-fast strategy with TIER 1 tests first

**Confidence Level:** High - This test strategy provides strong assurance that Story 4.3 will function correctly and safely in production.
