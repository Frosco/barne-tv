# Test Design: Story 1.4 - Basic Admin Authentication

**Date:** 2025-10-19
**Designer:** Quinn (Test Architect)
**Story ID:** 1.4
**Story Title:** Basic Admin Authentication
**Risk Level:** HIGH (TIER 1 security-critical)

## Executive Summary

This test design covers the implementation of secure admin authentication with bcrypt password hashing, session management, and route protection. The story implements TIER 1 security requirements (Rule 4: bcrypt passwords, Rule 3: UTC timestamps), making it predominantly P0 priority with comprehensive coverage required.

## Test Strategy Overview

- **Total test scenarios:** 42
- **Unit tests:** 13 (31%)
- **Integration tests:** 24 (57%)
- **E2E tests:** 5 (12%)
- **Priority distribution:**
  - P0: 35 scenarios (83%) - Security-critical
  - P1: 7 scenarios (17%) - Admin UX

**Rationale for distribution:**
- Heavy integration testing (57%) reflects the need to validate component interactions: auth module ↔ database ↔ API endpoints ↔ cookies
- Unit tests (31%) focus on pure logic: password hashing, session validation, timestamp handling
- Minimal E2E tests (12%) cover only critical user journeys to avoid redundancy

## Test Scenarios by Acceptance Criteria

### AC1: Admin login page created with password field

**Frontend template and UI elements**

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 1.4-E2E-001 | E2E | P1 | Login page renders with password input field | Validates complete template rendering in browser |
| 1.4-E2E-002 | E2E | P1 | Enter key submits login form | UX validation - keyboard accessibility |

**Coverage Notes:**
- Low priority (P1) as these are admin-facing UX features, not child-safety critical
- E2E level appropriate for visual/interaction validation

---

### AC2: Password authentication using bcrypt (stored hash in database)

**TIER 1 Rule 4 Compliance - Bcrypt Password Security**

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 1.4-UNIT-001 | Unit | P0 | `hash_password()` returns valid bcrypt hash | Pure function test - validates algorithm correctness |
| 1.4-UNIT-002 | Unit | P0 | `verify_password()` accepts correct password | Core security logic - password validation success path |
| 1.4-UNIT-003 | Unit | P0 | `verify_password()` rejects incorrect password | Core security logic - password validation failure path |
| 1.4-UNIT-004 | Unit | P0 | Bcrypt hash format validation (starts with `$2b$`, length 60) | TIER 1 Rule 4 compliance verification |
| 1.4-INT-001 | Integration | P0 | Admin password hash stored in database settings table as JSON | Validates persistence layer integration |
| 1.4-INT-002 | Integration | P0 | Password hash retrieved and parsed correctly from JSON | Validates database read + JSON deserialization |
| 1.4-INT-003 | Integration | P0 | Plain text password never stored anywhere | TIER 1 safety check - scans all storage layers |

**Coverage Notes:**
- All P0 due to TIER 1 Rule 4 requirements
- 100% coverage required for auth.py password functions
- Both unit (logic) and integration (persistence) levels needed for defense in depth

---

### AC3: Session management with secure cookies (httpOnly, secure in production)

**Session Token Generation and Cookie Security**

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 1.4-UNIT-005 | Unit | P0 | `create_session()` generates 32-byte cryptographically random token | Pure function - token generation algorithm |
| 1.4-UNIT-006 | Unit | P0 | `create_session()` sets 24-hour expiry using UTC timezone | TIER 1 Rule 3 compliance - UTC timestamps |
| 1.4-UNIT-007 | Unit | P0 | Session data stored in memory dict with correct structure | Pure logic - data structure validation |
| 1.4-INT-004 | Integration | P0 | Session cookie has `httpOnly=True` attribute | Security attribute - prevents XSS cookie theft |
| 1.4-INT-005 | Integration | P0 | Session cookie has `secure=True` attribute | Security attribute - HTTPS-only in production |
| 1.4-INT-006 | Integration | P0 | Session cookie has `samesite="lax"` attribute | Security attribute - CSRF protection |
| 1.4-INT-007 | Integration | P0 | Session cookie has `max_age=86400` (24 hours) | Cookie expiry matches session expiry |

**Coverage Notes:**
- All P0 due to security-critical session management
- Unit tests validate token generation logic
- Integration tests validate cookie middleware configuration
- No E2E needed - integration tests fully cover cookie attributes

---

### AC4: Login redirects to admin dashboard on success

**Successful Authentication Flow**

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 1.4-INT-008 | Integration | P0 | POST `/admin/login` with valid password returns 200 | API contract validation - success response |
| 1.4-INT-009 | Integration | P0 | Login success response includes `redirect` field with dashboard URL | Response structure validation |
| 1.4-E2E-003 | E2E | P0 | Complete login flow: submit password → redirect to dashboard | Critical admin path validation |

**Coverage Notes:**
- P0 priority - core admin authentication flow
- Integration tests cover API contract
- Single E2E test validates end-to-end browser behavior

---

### AC5: Invalid password shows clear error message

**Authentication Failure Handling**

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 1.4-INT-010 | Integration | P0 | POST `/admin/login` with invalid password returns 401 | Security - proper error status code |
| 1.4-INT-011 | Integration | P1 | Invalid login returns Norwegian error message "Feil passord" | TIER 3 Rule 14 - Norwegian user messages |
| 1.4-INT-012 | Integration | P0 | Invalid login does not set session cookie | Security - no session on failed auth |
| 1.4-E2E-004 | E2E | P1 | Login form displays Norwegian error message in UI | UX validation - error visibility |

**Coverage Notes:**
- P0 for security aspects (status code, no cookie set)
- P1 for UX aspects (Norwegian message display)
- Integration + E2E combination validates both API and browser behavior

---

### AC6: Session timeout after 24 hours of inactivity

**Session Expiry Logic**

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 1.4-UNIT-008 | Unit | P0 | `validate_session()` returns True for valid non-expired session | Pure logic - validation success path |
| 1.4-UNIT-009 | Unit | P0 | `validate_session()` returns False for expired session | Pure logic - expiry detection |
| 1.4-UNIT-010 | Unit | P0 | `validate_session()` removes expired session from memory | Pure logic - cleanup behavior |
| 1.4-INT-013 | Integration | P0 | Access protected route with expired session returns 401 | End-to-end expiry enforcement |
| 1.4-INT-014 | Integration | P0 | Session expiry calculation uses UTC timestamps | TIER 1 Rule 3 compliance verification |

**Coverage Notes:**
- All P0 due to security-critical session timeout
- Unit tests validate core expiry logic with mocked time
- Integration test validates real-world timeout enforcement
- UTC timestamp compliance (TIER 1 Rule 3) verified at integration level

---

### AC7: Logout functionality clears session

**Session Invalidation**

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 1.4-UNIT-011 | Unit | P0 | `invalidate_session()` removes session from memory dict | Pure logic - session cleanup |
| 1.4-INT-015 | Integration | P0 | POST `/admin/logout` clears session cookie | API endpoint cookie handling |
| 1.4-INT-016 | Integration | P1 | POST `/admin/logout` returns redirect to login page | UX - post-logout navigation |
| 1.4-INT-017 | Integration | P0 | Access protected route after logout returns 401 | Security - validates logout effectiveness |
| 1.4-E2E-005 | E2E | P0 | Complete logout flow: login → access admin → logout → verify locked out | Critical path - logout security validation |

**Coverage Notes:**
- P0 for security aspects (session cleared, access denied)
- P1 for UX (redirect URL)
- E2E test provides defense in depth for logout security

---

### AC8: All admin routes protected (redirect to login if not authenticated)

**Authentication Middleware and Route Protection**

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 1.4-UNIT-012 | Unit | P0 | `require_auth()` raises 401 for missing session cookie | Pure logic - dependency function behavior |
| 1.4-UNIT-013 | Unit | P0 | `require_auth()` raises 401 for invalid/expired session | Pure logic - validation enforcement |
| 1.4-INT-018 | Integration | P0 | Access protected route without session returns 401 | Middleware integration - authentication gate |
| 1.4-INT-019 | Integration | P0 | Access protected route with valid session returns 200 | Middleware integration - authorized access |
| 1.4-INT-020 | Integration | P0 | All admin routes enforce authentication (spot check 3-5 routes) | Comprehensive middleware application |

**Coverage Notes:**
- All P0 - authentication bypass would be critical security failure
- Unit tests validate middleware logic
- Integration tests validate middleware applied to all routes
- Spot checking 3-5 admin routes is sufficient (exhaustive testing not needed)

---

### Additional Security Scenarios

**Defense-in-Depth Security Validations**

| ID | Level | Priority | Test Scenario | Justification |
|----|-------|----------|---------------|---------------|
| 1.4-INT-021 | Integration | P0 | Session token entropy validation (32 bytes = 256 bits) | Security - token unpredictability |
| 1.4-INT-022 | Integration | P0 | Session isolation: one user cannot access another's session | Security - session hijacking prevention |
| 1.4-INT-023 | Integration | P0 | Password hash never appears in logs or error messages | Security - information disclosure prevention |
| 1.4-INT-024 | Integration | P0 | Login timing consistency (brute force protection) | Security - timing attack prevention |

**Coverage Notes:**
- All P0 - these are security best practices
- Marked with `@pytest.mark.security` for filtering
- Validates security beyond functional requirements

---

## Test Scenarios by Level

### Unit Tests (13 scenarios, 31%)

**Focus:** Pure logic, algorithms, data transformations

1. 1.4-UNIT-001: hash_password() returns bcrypt hash
2. 1.4-UNIT-002: verify_password() accepts correct password
3. 1.4-UNIT-003: verify_password() rejects incorrect password
4. 1.4-UNIT-004: Bcrypt hash format validation
5. 1.4-UNIT-005: create_session() generates 32-byte token
6. 1.4-UNIT-006: create_session() sets 24h UTC expiry
7. 1.4-UNIT-007: Session stored in memory dict
8. 1.4-UNIT-008: validate_session() returns True for valid session
9. 1.4-UNIT-009: validate_session() returns False for expired session
10. 1.4-UNIT-010: validate_session() removes expired session
11. 1.4-UNIT-011: invalidate_session() removes session
12. 1.4-UNIT-012: require_auth() raises 401 for missing session
13. 1.4-UNIT-013: require_auth() raises 401 for invalid session

**Characteristics:**
- Fast execution (< 1 second total)
- No database, no HTTP requests, no cookies
- Easy to debug, highly maintainable
- Can use mocked time for expiry testing

---

### Integration Tests (24 scenarios, 57%)

**Focus:** Component interactions, API contracts, middleware

1. 1.4-INT-001: Password hash in database
2. 1.4-INT-002: Password hash retrieval/parsing
3. 1.4-INT-003: No plain text password storage
4. 1.4-INT-004: Cookie httpOnly=True
5. 1.4-INT-005: Cookie secure=True
6. 1.4-INT-006: Cookie samesite="lax"
7. 1.4-INT-007: Cookie max_age=86400
8. 1.4-INT-008: POST /admin/login valid password → 200
9. 1.4-INT-009: Login response includes redirect
10. 1.4-INT-010: POST /admin/login invalid password → 401
11. 1.4-INT-011: Invalid login Norwegian error
12. 1.4-INT-012: Invalid login no cookie
13. 1.4-INT-013: Expired session → 401
14. 1.4-INT-014: Session expiry uses UTC
15. 1.4-INT-015: Logout clears cookie
16. 1.4-INT-016: Logout redirect to login
17. 1.4-INT-017: Access after logout → 401
18. 1.4-INT-018: Protected route without session → 401
19. 1.4-INT-019: Protected route with session → 200
20. 1.4-INT-020: All admin routes protected
21. 1.4-INT-021: Session token entropy
22. 1.4-INT-022: Session isolation
23. 1.4-INT-023: Password hash not in logs
24. 1.4-INT-024: Login timing consistency

**Characteristics:**
- Moderate execution time (2-5 seconds total)
- Uses test database, FastAPI TestClient
- Validates API contracts and middleware
- Tests component boundaries

---

### E2E Tests (5 scenarios, 12%)

**Focus:** Critical user journeys, browser behavior

1. 1.4-E2E-001: Login page renders with password field
2. 1.4-E2E-002: Enter key submits form
3. 1.4-E2E-003: Complete login flow → dashboard
4. 1.4-E2E-004: Login error message display
5. 1.4-E2E-005: Complete logout flow with lockout

**Characteristics:**
- Slower execution (10-20 seconds total)
- Uses Playwright for browser automation
- Validates complete workflows
- Most realistic but most brittle

**Note:** E2E tests minimal because integration tests provide sufficient coverage. E2E only validates browser-specific behavior (rendering, redirects, JavaScript execution).

---

## Risk Coverage Analysis

### TIER 1 Safety Rules Validated

| Rule | Description | Test Coverage |
|------|-------------|---------------|
| Rule 3 | UTC timestamps always | 1.4-UNIT-006, 1.4-INT-014 |
| Rule 4 | Bcrypt for passwords | 1.4-UNIT-001-004, 1.4-INT-001-003 |
| Rule 5 | Input validation | Covered by Pydantic models in implementation |
| Rule 6 | SQL placeholders | Covered by existing db/queries.py tests |

**TIER 1 Coverage Requirements:**
- **100% coverage** required for `backend/auth.py` module
- All TIER 1 tests marked with `@pytest.mark.tier1`
- TIER 1 tests MUST pass before story completion

---

### Security Risk Mitigation

| Risk | Probability | Impact | Mitigation Tests |
|------|-------------|--------|------------------|
| Weak password hashing | Low | Critical | 1.4-UNIT-001-004 (bcrypt validation) |
| Session hijacking | Medium | High | 1.4-INT-021-022 (token entropy, isolation) |
| Authentication bypass | Low | Critical | 1.4-INT-018-020 (route protection) |
| Timing attacks | Medium | Medium | 1.4-INT-024 (timing consistency) |
| Cookie theft (XSS) | Medium | High | 1.4-INT-004-006 (cookie attributes) |
| Session fixation | Low | Medium | New token on each login (implicit in create_session) |
| Information disclosure | Low | High | 1.4-INT-023 (password hash in logs) |

**Risk Assessment:**
- Overall risk: **MEDIUM** (after mitigation)
- Critical vulnerabilities: **NONE** (all mitigated)
- Residual risk: Session storage lost on restart (acceptable per architecture)

---

## Coverage Validation

### Acceptance Criteria Coverage

| AC | Description | Test Count | Coverage |
|----|-------------|------------|----------|
| AC1 | Login page with password field | 2 | ✅ Complete |
| AC2 | Bcrypt password authentication | 7 | ✅ Complete |
| AC3 | Session management + cookies | 7 | ✅ Complete |
| AC4 | Login success redirect | 3 | ✅ Complete |
| AC5 | Invalid password error | 4 | ✅ Complete |
| AC6 | Session timeout (24h) | 5 | ✅ Complete |
| AC7 | Logout functionality | 5 | ✅ Complete |
| AC8 | Protected admin routes | 5 | ✅ Complete |
| Additional | Security best practices | 4 | ✅ Complete |

**Total:** 42 test scenarios, 8 ACs + security extras
**Coverage Gaps:** None identified

---

### Test Task Mapping

This test design maps to existing test tasks in Story 1.4:

| Story Task | Test Scenarios | Coverage |
|------------|----------------|----------|
| Task 7: TIER 1 safety tests | 1.4-UNIT-001-004, 1.4-INT-001-003, 1.4-INT-014 | Password security, UTC timestamps |
| Task 8: Unit tests for auth module | 1.4-UNIT-001-013 (all unit tests) | 100% coverage of auth.py |
| Task 9: Integration tests (auth flow) | 1.4-INT-001-020 | API endpoints, middleware, database |
| Task 10: Security tests | 1.4-INT-021-024 | Defense-in-depth security |

**Implementation Notes:**
- Task 7 tests MUST be marked with `@pytest.mark.tier1`
- Task 8 requires 100% coverage for auth.py (TIER 1 requirement)
- Task 10 tests MUST be marked with `@pytest.mark.security`
- All tests should use in-memory SQLite database via pytest fixtures

---

## Recommended Test Execution Order

### Phase 1: Fail Fast (P0 Unit Tests)
**Time:** ~1 second
**Goal:** Validate core logic before integration

1. Run all unit tests (1.4-UNIT-001 through 1.4-UNIT-013)
2. Stop if any TIER 1 test fails

### Phase 2: Integration Validation (P0 Integration)
**Time:** ~3-5 seconds
**Goal:** Validate component interactions

1. Run all integration tests (1.4-INT-001 through 1.4-INT-024)
2. Verify cookie attributes, middleware, database operations

### Phase 3: Critical Paths (P0 E2E)
**Time:** ~10-15 seconds
**Goal:** Validate complete user journeys

1. Run P0 E2E tests (1.4-E2E-003, 1.4-E2E-005)
2. Validate login → dashboard and logout flows

### Phase 4: UX Validation (P1)
**Time:** ~5-8 seconds
**Goal:** Validate admin user experience

1. Run P1 E2E tests (1.4-E2E-001, 1.4-E2E-002, 1.4-E2E-004)
2. Run P1 integration test (1.4-INT-011, 1.4-INT-016)

### Total Estimated Execution Time: ~20-30 seconds

---

## Test Data Requirements

### Fixtures Needed

```python
# In tests/backend/conftest.py

@pytest.fixture
def admin_password():
    """Test admin password"""
    return "test_admin_password_123"

@pytest.fixture
def admin_password_hash(admin_password):
    """Bcrypt hash of admin password"""
    from backend.auth import hash_password
    return hash_password(admin_password)

@pytest.fixture
def test_db_with_admin(test_db, admin_password_hash):
    """Database with admin password set"""
    import json
    with get_connection() as conn:
        conn.execute(
            "UPDATE settings SET value = ? WHERE key = 'admin_password_hash'",
            (json.dumps(admin_password_hash),)
        )
    return test_db

@pytest.fixture
def valid_session():
    """Create valid admin session"""
    from backend.auth import create_session
    return create_session()

@pytest.fixture
def expired_session():
    """Create expired session for testing"""
    from backend.auth import sessions
    from datetime import datetime, timezone, timedelta
    session_id = "expired_test_session"
    sessions[session_id] = {
        'created_at': datetime.now(timezone.utc) - timedelta(hours=25),
        'expires_at': datetime.now(timezone.utc) - timedelta(hours=1)
    }
    return session_id
```

---

## Known Testing Limitations

### Acceptable Limitations

1. **Session restart behavior:** Cannot test session loss on application restart (sessions are in-memory by design)
2. **Production HTTPS:** Cannot test `secure=True` cookie in local dev (would need staging environment)
3. **Brute force rate limiting:** Not implemented in this story (future enhancement)

### Future Test Enhancements

1. **Load testing:** Session creation performance under concurrent load
2. **Penetration testing:** Professional security audit of authentication system
3. **Accessibility testing:** WCAG compliance for login page

---

## Quality Gate Recommendation

Based on this test design:

**Criteria for PASS:**
- All 42 test scenarios implemented
- All TIER 1 tests (marked `@pytest.mark.tier1`) pass 100%
- Auth.py coverage ≥ 100%
- Overall backend coverage ≥ 85%
- All security tests (marked `@pytest.mark.security`) pass
- No linting errors (black, ruff, mypy)
- Norwegian error messages validated

**Criteria for CONCERNS:**
- Auth.py coverage 95-99% (minor gaps acceptable with justification)
- 1-2 non-critical test failures (P1/P2 tests only)
- Minor linting warnings

**Criteria for FAIL:**
- Any TIER 1 test failure
- Auth.py coverage < 95%
- Any P0 security test failure
- Authentication bypass possible
- Plain text password storage found

**Criteria for WAIVED:**
- Not applicable - security-critical story cannot be waived

---

## Test Maintenance Notes

### Long-term Stability

**Low-risk tests (stable):**
- Unit tests: Pure logic, unlikely to change
- Integration tests: API contracts are stable
- TIER 1 safety tests: Never change (compliance requirement)

**Medium-risk tests (may need updates):**
- E2E tests: Sensitive to UI changes
- Cookie attribute tests: May change with security updates

**Maintenance Recommendations:**
1. Review test design when adding new admin routes
2. Re-run security tests (`pytest -m security`) after any auth.py changes
3. Update E2E tests if frontend templates change
4. Keep TIER 1 tests unchanged (compliance requirement)

---

## Conclusion

This test design provides comprehensive coverage of Story 1.4 with 42 test scenarios across all levels:

- **Defense in depth:** Unit + Integration + E2E coverage for critical paths
- **TIER 1 compliance:** 100% coverage of security-critical code
- **Risk-based priorities:** 83% P0 scenarios (security focus)
- **Efficient testing:** Right test at right level (no duplicate coverage)
- **Fast feedback:** Unit tests run in < 1 second

**Recommendation:** Implement all 42 scenarios as specified in Tasks 7-10. This test suite provides the quality assurance needed for production deployment of admin authentication.

---

## Appendices

### Appendix A: Test Scenario Quick Reference

```
UNIT (13):   001-004 (password), 005-007 (session create), 008-010 (session validate),
             011 (session invalidate), 012-013 (require_auth)

INT (24):    001-003 (db storage), 004-007 (cookies), 008-009 (login success),
             010-012 (login failure), 013-014 (expiry), 015-017 (logout),
             018-020 (route protection), 021-024 (security extras)

E2E (5):     001-002 (UI/UX), 003 (login flow), 004 (error display), 005 (logout flow)
```

### Appendix B: pytest Marker Usage

```bash
# Run all tests for Story 1.4
pytest tests/backend/ -k "auth" -v

# Run only TIER 1 safety tests
pytest -m tier1 -v

# Run only security tests
pytest -m security -v

# Run unit tests only
pytest tests/backend/test_auth.py -v

# Run with coverage report
pytest tests/backend/test_auth.py --cov=backend.auth --cov-report=html
```

### Appendix C: Test Design Metadata

```yaml
test_design:
  story_id: "1.4"
  story_slug: "basic-admin-authentication"
  designer: "Quinn (Test Architect)"
  date: "2025-10-19"
  scenarios_total: 42
  by_level:
    unit: 13
    integration: 24
    e2e: 5
  by_priority:
    p0: 35
    p1: 7
    p2: 0
    p3: 0
  coverage_gaps: []
  tier1_tests: 8
  security_tests: 4
  estimated_execution_time_seconds: 25
```

---

**Document Status:** Final
**Next Steps:** Implement test scenarios as per Tasks 7-10 in Story 1.4
**Questions/Concerns:** Contact Quinn (QA Agent) for clarifications
