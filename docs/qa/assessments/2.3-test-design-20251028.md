# Test Design: Story 2.3 - Security and SEO Prevention

**Date:** 2025-10-28
**Designer:** Quinn (Test Architect)
**Story:** 2.3 - Security and SEO Prevention
**Epic:** 2 - Child Viewing Experience

---

## Executive Summary

This test design covers security headers, SEO prevention mechanisms, and FastAPI security middleware for the Safe YouTube Viewer for Kids application. Given the **child safety and privacy focus** of this application, all security controls are treated as P0 (critical) priority.

### Test Strategy Overview

- **Total test scenarios:** 20
- **Unit tests:** 4 (20%)
- **Integration tests:** 16 (80%)
- **E2E tests:** 0 (0%)
- **Priority distribution:**
  - P0 (Critical): 12 scenarios (60%) - Security headers, middleware, host validation
  - P1 (High): 7 scenarios (35%) - Meta tags, configuration, template validation
  - P2 (Medium): 1 scenario (5%) - YouTube player audit

### Key Testing Principles

1. **Defense-in-Depth:** Test both Nginx (primary) and FastAPI (backup) security layers
2. **Child Safety First:** All privacy and indexing prevention mechanisms are P0
3. **No E2E Required:** Security headers don't require user journey testing
4. **Integration-Heavy:** Most tests verify HTTP responses and middleware behavior
5. **Documentation Gaps:** Nginx-only features (CSP, HSTS, Permissions-Policy) documented but not unit-testable

---

## Test Scenarios by Acceptance Criteria

### AC1: robots.txt File

**Requirement:** robots.txt file created blocking all crawlers (User-agent: *, Disallow: /)

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 2.3-INT-001 | Integration | P0 | Verify robots.txt content matches spec (User-agent: *, Disallow: /) | Privacy-critical: prevents search engine indexing of child content |
| 2.3-INT-002 | Integration | P0 | Verify robots.txt served at /robots.txt endpoint with 200 status | Privacy-critical: ensures crawlers can find the file |
| 2.3-INT-003 | Integration | P1 | Verify robots.txt file has correct permissions (644) | Security best practice, not critical to functionality |

**Risk Coverage:** Mitigates RISK-001 (Search engine indexing of child viewing data), RISK-002 (Privacy violation via public search results)

---

### AC2 & AC4: Security Meta Tags

**Requirement:** Meta tags added to all pages (noindex, nofollow, noarchive) + Google-specific tags

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 2.3-INT-004 | Integration | P0 | Verify `<meta name="robots">` tag in child interface HTML | Privacy-critical: backup SEO prevention if robots.txt ignored |
| 2.3-INT-005 | Integration | P1 | Verify `<meta name="robots">` tag in admin interface HTML | Important but admin is already auth-protected |
| 2.3-INT-006 | Integration | P0 | Verify `<meta name="googlebot">` tag in child interface HTML | Privacy-critical: explicit Google bot blocking |
| 2.3-INT-020 | Integration | P1 | Verify all child/admin templates inherit meta tags from base.html | Ensures consistent coverage across all pages |

**Risk Coverage:** Mitigates RISK-001 (Search engine indexing), RISK-002 (Privacy violation)

---

### AC3: X-Robots-Tag HTTP Header

**Requirement:** X-Robots-Tag HTTP header added to all responses (noindex, nofollow)

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 2.3-INT-007 | Integration | P0 | Verify X-Robots-Tag header present on child endpoints (/child/*) | Privacy-critical: HTTP-level SEO prevention |
| 2.3-INT-008 | Integration | P1 | Verify X-Robots-Tag header present on admin endpoints (/admin/*) | Important for consistency, admin already auth-protected |
| 2.3-INT-019 | Integration | P0 | Verify X-Robots-Tag header present on error responses (404, 500) | Privacy-critical: even error pages should not be indexed |

**Risk Coverage:** Mitigates RISK-001 (Search engine indexing), RISK-002 (Privacy violation)

**Note:** X-Robots-Tag is set by Nginx in production, but FastAPI middleware can add it for defense-in-depth. Test verifies header presence regardless of source.

---

### AC5: No External Analytics or Tracking

**Requirement:** No external analytics or tracking scripts included

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 2.3-INT-009 | Integration | P1 | Audit base.html and child templates for analytics scripts (manual inspection + automated HTML parsing) | Privacy verification, manual audit acceptable |

**Risk Coverage:** Mitigates RISK-003 (Third-party tracking of child behavior), RISK-004 (Data leakage to external services)

**Implementation:** Automated test parses rendered HTML for common analytics patterns (google-analytics.com, gtag, ga.js, etc.)

---

### AC6: Content Security Policy (CSP)

**Requirement:** CSP header configured with YouTube allowances

**Test Scenario:** N/A - Documentation only

**Rationale:** CSP is configured in Nginx (production reverse proxy). FastAPI cannot reliably test Nginx configuration. This is documented as a **coverage gap** requiring manual verification during deployment.

**Manual Verification Checklist:**
- [ ] Nginx config includes CSP header
- [ ] CSP allows YouTube domains (www.youtube.com, s.ytimg.com, i.ytimg.com)
- [ ] CSP includes 'unsafe-inline' for style-src (required for dynamic child UI)
- [ ] Development CSP relaxed for Vite (allows 'unsafe-eval', WebSocket)

**Risk Coverage:** Mitigates RISK-005 (XSS attacks), RISK-006 (External resource injection)

---

### AC7: Child Interface External Links

**Requirement:** Child interface has no external links or navigation away from application

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 2.3-INT-010 | Integration | P1 | Audit child templates for external links (href not starting with /, #, or same domain) | Child safety verification, expected to pass from Story 2.1 |

**Risk Coverage:** Mitigates RISK-007 (Child navigates away from safe environment), RISK-008 (Exposure to inappropriate content via links)

**Implementation:** Automated test parses rendered HTML for `<a>` tags with external href values

---

### AC8: YouTube Player Minimal Components

**Requirement:** YouTube player API only loads necessary components

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 2.3-INT-011 | Integration | P2 | Verify YouTube IFrame Player API configuration uses minimal parameters | Performance and privacy, not critical to child safety |

**Risk Coverage:** Minor mitigation of RISK-009 (Excessive external resource loading)

**Implementation:** Inspect player initialization code for unnecessary API features (annotations, related videos, etc.)

---

### AC9: HTTPS/TLS Configuration

**Requirement:** HTTPS enforced with Let's Encrypt, TLS 1.2+, strong ciphers

**Test Scenario:** N/A - Documentation only

**Rationale:** HTTPS/TLS configuration is Nginx and Certbot infrastructure setup (Epic 5 deployment). Not testable in FastAPI unit/integration tests. Documented as **coverage gap** requiring manual verification during production deployment.

**Manual Verification Checklist:**
- [ ] Let's Encrypt certificates installed via Certbot
- [ ] HTTP (port 80) redirects to HTTPS (port 443)
- [ ] TLS 1.2 and 1.3 enabled, older versions disabled
- [ ] Strong cipher suites configured (ECDHE-ECDSA-AES128-GCM-SHA256, etc.)
- [ ] Automatic certificate renewal via systemd timer

**Risk Coverage:** Mitigates RISK-010 (Man-in-the-middle attacks), RISK-011 (Credential interception)

---

### AC10: Admin Authentication

**Requirement:** Admin interface behind authentication (no anonymous access)

**Test Scenario:** Already covered by existing authentication tests in test suite

**Rationale:** Admin authentication was implemented in Story 1.1 and tested in Story 1.X. No new test scenarios needed.

**Existing Coverage:**
- `tests/backend/test_auth.py::test_admin_endpoints_require_authentication`
- `tests/backend/test_auth.py::test_admin_login_with_valid_credentials`
- `tests/backend/test_auth.py::test_admin_login_with_invalid_credentials`

---

### AC11, AC12, AC13: Security Headers (X-Frame-Options, X-Content-Type-Options, X-XSS-Protection)

**Requirement:** Security headers set via FastAPI middleware (defense-in-depth)

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 2.3-INT-012 | Integration | P0 | Verify X-Frame-Options: SAMEORIGIN header on all endpoints | Security-critical: prevents clickjacking attacks |
| 2.3-INT-013 | Integration | P0 | Verify X-Content-Type-Options: nosniff header on all endpoints | Security-critical: prevents MIME type sniffing attacks |
| 2.3-INT-014 | Integration | P0 | Verify X-XSS-Protection: 1; mode=block header on all endpoints | Security-critical: legacy browser XSS protection |
| 2.3-INT-017 | Integration | P0 | Verify security headers added by FastAPI middleware to all response types (JSON, HTML, static) | Security-critical: comprehensive coverage |
| 2.3-INT-018 | Integration | P1 | Verify security headers present on static file responses | Important for defense-in-depth completeness |
| 2.3-UNIT-004 | Unit | P1 | Verify security headers middleware error handling (middleware exception doesn't break app) | Important for reliability, not security-critical |

**Risk Coverage:** Mitigates RISK-012 (Clickjacking), RISK-013 (MIME sniffing attacks), RISK-014 (XSS attacks in legacy browsers)

---

### AC14, AC15, AC16: Nginx-Only Headers (HSTS, Referrer-Policy, Permissions-Policy)

**Requirement:** HSTS, Referrer-Policy, and Permissions-Policy configured in Nginx

**Test Scenario:** N/A - Documentation only

**Rationale:** These headers are Nginx-only:
- **HSTS:** Should only be set by TLS termination point (Nginx), not by application
- **Referrer-Policy:** Complex, best managed in Nginx configuration
- **Permissions-Policy:** Complex feature policy, best in Nginx

Documented as **coverage gap** requiring manual verification during deployment.

**Manual Verification Checklist:**
- [ ] HSTS header: max-age=31536000, includeSubDomains
- [ ] Referrer-Policy header: strict-origin-when-cross-origin
- [ ] Permissions-Policy header disables geolocation, microphone, camera, payment, usb, magnetometer, gyroscope, accelerometer

**Risk Coverage:** Mitigates RISK-015 (SSL stripping attacks), RISK-016 (Referrer leakage), RISK-017 (Unwanted browser feature access)

---

### AC17: TrustedHostMiddleware Configuration

**Requirement:** FastAPI TrustedHostMiddleware with ALLOWED_HOSTS from environment

| ID | Level | Priority | Test Scenario | Justification |
|---|---|---|---|---|
| 2.3-UNIT-001 | Unit | P0 | Verify ALLOWED_HOSTS environment variable parsing (valid comma-separated list) | Security-critical: configuration must be correct |
| 2.3-UNIT-002 | Unit | P0 | Verify ALLOWED_HOSTS validation with empty value (should use default: localhost,127.0.0.1) | Security-critical: safe defaults required |
| 2.3-UNIT-003 | Unit | P0 | Verify ALLOWED_HOSTS validation with malformed values (spaces, special chars, trailing commas) | Security-critical: prevent misconfiguration |
| 2.3-INT-015 | Integration | P0 | Verify TrustedHostMiddleware accepts requests with valid Host header | Security-critical: legitimate traffic must work |
| 2.3-INT-016 | Integration | P0 | Verify TrustedHostMiddleware rejects requests with invalid Host header (returns 400 Bad Request) | Security-critical: prevents host header injection attacks |

**Risk Coverage:** Mitigates RISK-018 (Host header injection attacks), RISK-019 (DNS rebinding attacks)

---

### AC18: FastAPI Security Headers Middleware

**Requirement:** Custom middleware adds security headers (redundant with Nginx for defense-in-depth)

**Coverage:** See AC11, AC12, AC13 scenarios above (2.3-INT-012 through 2.3-INT-018)

**Rationale:** FastAPI middleware provides backup security headers if Nginx is bypassed or misconfigured. Integration tests verify headers are present regardless of source (Nginx or FastAPI).

---

## Risk Coverage Matrix

| Risk ID | Risk Description | Mitigating Test Scenarios | Priority |
|---|---|---|---|
| RISK-001 | Search engine indexing of child viewing data | 2.3-INT-001, 2.3-INT-002, 2.3-INT-004, 2.3-INT-006, 2.3-INT-007 | P0 |
| RISK-002 | Privacy violation via public search results | 2.3-INT-001, 2.3-INT-002, 2.3-INT-004, 2.3-INT-006, 2.3-INT-007 | P0 |
| RISK-003 | Third-party tracking of child behavior | 2.3-INT-009 | P1 |
| RISK-004 | Data leakage to external services | 2.3-INT-009, 2.3-INT-010 | P1 |
| RISK-005 | XSS attacks | Manual CSP verification, 2.3-INT-014 | P0 |
| RISK-006 | External resource injection | Manual CSP verification | P0 |
| RISK-007 | Child navigates away from safe environment | 2.3-INT-010 | P1 |
| RISK-008 | Exposure to inappropriate content via links | 2.3-INT-010 | P1 |
| RISK-009 | Excessive external resource loading | 2.3-INT-011 | P2 |
| RISK-010 | Man-in-the-middle attacks | Manual HTTPS/TLS verification | P0 |
| RISK-011 | Credential interception | Manual HTTPS/TLS verification | P0 |
| RISK-012 | Clickjacking attacks | 2.3-INT-012 | P0 |
| RISK-013 | MIME type sniffing attacks | 2.3-INT-013 | P0 |
| RISK-014 | XSS attacks (legacy browsers) | 2.3-INT-014 | P0 |
| RISK-015 | SSL stripping attacks | Manual HSTS verification | P0 |
| RISK-016 | Referrer information leakage | Manual Referrer-Policy verification | P1 |
| RISK-017 | Unwanted browser feature access | Manual Permissions-Policy verification | P1 |
| RISK-018 | Host header injection attacks | 2.3-INT-015, 2.3-INT-016 | P0 |
| RISK-019 | DNS rebinding attacks | 2.3-INT-015, 2.3-INT-016 | P0 |

---

## Coverage Gaps and Manual Verification

### Coverage Gaps (Infrastructure-Level)

The following security controls **cannot be tested** via backend unit/integration tests and require manual verification during production deployment:

1. **Content Security Policy (CSP)** - Nginx configuration only
2. **HTTPS/TLS Configuration** - Let's Encrypt, Nginx, infrastructure
3. **HSTS Header** - Nginx configuration only (must be set at TLS termination point)
4. **Referrer-Policy Header** - Nginx configuration only
5. **Permissions-Policy Header** - Nginx configuration only

**Rationale:** These are infrastructure-level configurations managed by Nginx reverse proxy. Testing them requires E2E tests against a full production-like environment (Nginx + FastAPI + Let's Encrypt), which is out of scope for Story 2.3 unit/integration tests.

**Mitigation:** Comprehensive documentation in `docs/architecture/infrastructure-and-deployment.md` with manual verification checklist for deployment (Epic 5).

### Manual Verification Checklist

During Epic 5 deployment, verify the following manually:

- [ ] robots.txt accessible at https://yourdomain.com/robots.txt
- [ ] All security headers present in production responses (use browser dev tools or curl)
- [ ] CSP header configured with YouTube allowances
- [ ] HTTPS enforced (HTTP redirects to HTTPS)
- [ ] TLS 1.2/1.3 only (verify with SSL Labs or testssl.sh)
- [ ] HSTS header present (max-age=31536000)
- [ ] Permissions-Policy header disables unnecessary features
- [ ] Let's Encrypt certificate valid and auto-renewal configured

---

## Recommended Test Execution Order

### Phase 1: Unit Tests (Fast Feedback - ~5 seconds)

Run first to catch configuration and validation errors:

1. 2.3-UNIT-001: ALLOWED_HOSTS environment variable parsing
2. 2.3-UNIT-002: ALLOWED_HOSTS empty value handling
3. 2.3-UNIT-003: ALLOWED_HOSTS malformed value validation
4. 2.3-UNIT-004: Security headers middleware error handling

**Command:** `uv run pytest tests/backend/security/test_config.py -v`

---

### Phase 2: Integration Tests - P0 Security Critical (~30 seconds)

Run P0 tests to verify all security-critical controls:

1. 2.3-INT-001: robots.txt content verification
2. 2.3-INT-002: robots.txt endpoint serving
3. 2.3-INT-004: Meta robots tag (child interface)
4. 2.3-INT-006: Meta googlebot tag
5. 2.3-INT-007: X-Robots-Tag header (child endpoints)
6. 2.3-INT-012: X-Frame-Options header
7. 2.3-INT-013: X-Content-Type-Options header
8. 2.3-INT-014: X-XSS-Protection header
9. 2.3-INT-015: TrustedHostMiddleware accepts valid hosts
10. 2.3-INT-016: TrustedHostMiddleware rejects invalid hosts
11. 2.3-INT-017: Security headers on all response types
12. 2.3-INT-019: Security headers on error responses

**Command:** `uv run pytest tests/backend/security/test_security_headers.py::test_p0* -v`

---

### Phase 3: Integration Tests - P1 Important (~20 seconds)

Run P1 tests for comprehensive coverage:

1. 2.3-INT-003: robots.txt file permissions
2. 2.3-INT-005: Meta robots tag (admin interface)
3. 2.3-INT-008: X-Robots-Tag header (admin endpoints)
4. 2.3-INT-009: Analytics scripts audit
5. 2.3-INT-010: External links audit
6. 2.3-INT-018: Security headers on static files
7. 2.3-INT-020: Template inheritance verification

**Command:** `uv run pytest tests/backend/security/test_security_headers.py::test_p1* -v`

---

### Phase 4: Integration Tests - P2 Nice-to-Have (~10 seconds)

Run P2 tests if time permits:

1. 2.3-INT-011: YouTube player minimal configuration audit

**Command:** `uv run pytest tests/backend/security/test_security_headers.py::test_p2* -v`

---

### Full Test Suite

Run all security tests:

```bash
# All security tests
uv run pytest tests/backend/security/ -v

# With coverage report
uv run pytest tests/backend/security/ -v --cov=backend.main --cov=backend.config --cov-report=html

# Only P0 critical tests
uv run pytest tests/backend/security/ -m p0 -v
```

**Expected Execution Time:** ~65 seconds for full suite

---

## Test Implementation Notes

### Test File Organization

```
tests/backend/security/
├── __init__.py
├── test_config.py              # Unit tests for config loading (ALLOWED_HOSTS)
├── test_security_headers.py    # Integration tests for HTTP headers
├── test_robots.py              # Integration tests for robots.txt
├── test_middleware.py          # Integration tests for TrustedHostMiddleware
└── test_template_audit.py      # Integration tests for meta tags and external links
```

### Test Markers

Use pytest markers for priority-based execution:

```python
@pytest.mark.security  # All security tests
@pytest.mark.p0        # P0 critical tests
@pytest.mark.p1        # P1 important tests
@pytest.mark.p2        # P2 nice-to-have tests
```

### FastAPI TestClient Usage

All integration tests use FastAPI TestClient:

```python
from fastapi.testclient import TestClient
from backend.main import app

@pytest.fixture
def client():
    return TestClient(app)

def test_security_headers_present(client):
    response = client.get('/health')
    assert response.headers['X-Content-Type-Options'] == 'nosniff'
    assert response.headers['X-Frame-Options'] == 'SAMEORIGIN'
    assert response.headers['X-XSS-Protection'] == '1; mode=block'
```

### Mock Environment Variables

Use pytest monkeypatch for environment variable testing:

```python
def test_allowed_hosts_parsing(monkeypatch):
    monkeypatch.setenv('ALLOWED_HOSTS', 'example.com,www.example.com')
    # Reimport config to pick up new environment variable
    import importlib
    import backend.config
    importlib.reload(backend.config)

    assert 'example.com' in backend.config.ALLOWED_HOSTS
    assert 'www.example.com' in backend.config.ALLOWED_HOSTS
```

### HTML Parsing for Audits

Use BeautifulSoup for template audits:

```python
from bs4 import BeautifulSoup

def test_no_external_links_in_child_interface(client):
    response = client.get('/child')
    soup = BeautifulSoup(response.text, 'html.parser')

    for link in soup.find_all('a', href=True):
        href = link['href']
        # Allow internal links (/, #, relative paths)
        assert href.startswith('/') or href.startswith('#') or not href.startswith('http'), \
            f"External link found: {href}"
```

---

## Quality Checklist

Before finalizing this test design, verify:

- [x] Every AC has test coverage (ACs 6, 9, 14, 15, 16 documented as coverage gaps)
- [x] Test levels are appropriate (unit for config, integration for HTTP responses)
- [x] No duplicate coverage across levels
- [x] Priorities align with child safety risk (all security controls P0)
- [x] Test IDs follow naming convention (2.3-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent
- [x] Risks mapped to test scenarios
- [x] Coverage gaps identified and documented
- [x] Manual verification checklist provided for infrastructure-level gaps

---

## Success Criteria

This test design is successful if:

1. **All P0 tests pass** - Security-critical controls verified
2. **>=85% code coverage** - Security middleware and config modules
3. **Zero coverage gaps in testable code** - Only infrastructure gaps documented
4. **Fast execution** - Full suite runs in <90 seconds
5. **Clear risk traceability** - Every identified risk has test coverage or manual verification

---

## References

- Story 2.3: `docs/stories/2.3.security-and-seo-prevention.md`
- Architecture: `docs/architecture/security-implementation.md`
- Test Strategy: `docs/architecture/test-strategy-and-standards.md`
- Test Levels Framework: `.bmad-core/data/test-levels-framework.md`
- Test Priorities Matrix: `.bmad-core/data/test-priorities-matrix.md`
