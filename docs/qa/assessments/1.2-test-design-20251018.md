# Test Design: Story 1.2 - YouTube API Setup

**Date:** 2025-10-18
**Designer:** Quinn (Test Architect)
**Story:** 1.2 - YouTube API Setup

## Test Strategy Overview

- **Total test scenarios:** 30
- **Unit tests:** 18 (60%)
- **Integration tests:** 8 (27%)
- **E2E tests:** 4 (13%)
- **Priority distribution:** P0: 15, P1: 10, P2: 5

### Strategy Rationale

Story 1.2 focuses on YouTube API configuration, quota tracking, and validation. The test strategy emphasizes:

1. **Heavy unit test coverage (60%)** for quota tracking and validation logic - these are pure functions with clear inputs/outputs
2. **Targeted integration tests (27%)** for database operations and real API calls - validates component boundaries
3. **Minimal E2E tests (13%)** for critical startup flow only - most expensive, reserved for full system validation

**Safety-Critical Areas (P0):**
- Quota tracking (prevents API overuse and service disruption)
- API validation (prevents runtime failures)
- Error handling (ensures graceful degradation)

**Target Coverage:**
- Quota tracking functions: 100% (safety-critical)
- API validation functions: 100% (safety-critical)
- Error handling: 100% (critical error paths)
- Overall backend: 85%

## Test Scenarios by Acceptance Criteria

### AC1 & AC2: Google Cloud Console Setup

**Status:** Manual verification only (no automated tests)

**Verification Checklist:**
- [ ] YouTube Data API v3 enabled in Google Cloud Console
- [ ] API key generated via Credentials page
- [ ] API key restrictions applied (IP whitelist or HTTP referrer)
- [ ] API key saved securely (not committed to git)

---

### AC3: API Key Stored in .env File

#### Scenarios

| ID           | Level | Priority | Test Description                           | Justification                          | Mock Requirements |
|--------------|-------|----------|-------------------------------------------|----------------------------------------|-------------------|
| 1.2-UNIT-001 | Unit  | P1       | Config loads YOUTUBE_API_KEY from env     | Pure config logic, fast feedback       | Mock os.getenv    |
| 1.2-UNIT-002 | Unit  | P0       | Config raises error if key missing        | Critical startup failure path          | Mock os.getenv    |
| 1.2-UNIT-003 | Unit  | P1       | Config handles empty YOUTUBE_API_KEY      | Edge case validation                   | Mock os.getenv    |

**Coverage:** 3 unit tests, no integration needed (config loading is isolated)

---

### AC4: API Key Never Committed to Version Control

#### Scenarios

| ID           | Level       | Priority | Test Description                         | Justification                          | Mock Requirements |
|--------------|-------------|----------|------------------------------------------|----------------------------------------|-------------------|
| 1.2-INT-001  | Integration | P1       | Verify .env is in .gitignore            | File system verification               | None              |
| 1.2-INT-002  | Integration | P1       | Verify .env.example has placeholder only | Security validation                    | None              |

**Coverage:** 2 integration tests (requires file system access)

---

### AC5: google-api-python-client Installed and Verified

#### Scenarios

| ID           | Level       | Priority | Test Description                              | Justification                          | Mock Requirements |
|--------------|-------------|----------|-----------------------------------------------|----------------------------------------|-------------------|
| 1.2-INT-003  | Integration | P1       | Import googleapiclient.discovery succeeds     | Dependency verification                | None              |
| 1.2-INT-004  | Integration | P1       | Instantiate YouTube client with test key      | Client creation validation             | Test API key      |

**Coverage:** 2 integration tests (requires actual package import)

---

### AC6: API Quota Monitoring Setup (Database Tracking)

#### Scenarios - log_api_call()

| ID           | Level | Priority | Test Description                              | Justification                          | Mock Requirements    |
|--------------|-------|----------|-----------------------------------------------|----------------------------------------|---------------------|
| 1.2-UNIT-004 | Unit  | P0       | log_api_call() inserts correct data           | Safety-critical quota tracking         | Test database       |
| 1.2-UNIT-005 | Unit  | P0       | log_api_call() uses UTC timestamps            | TIER 1 requirement                     | Test database       |
| 1.2-UNIT-006 | Unit  | P0       | log_api_call() handles NULL error_message     | Error handling validation              | Test database       |
| 1.2-UNIT-007 | Unit  | P0       | log_api_call() uses SQL placeholders          | SQL injection prevention (TIER 1)      | Test database       |

#### Scenarios - get_daily_quota_usage()

| ID           | Level | Priority | Test Description                              | Justification                          | Mock Requirements    |
|--------------|-------|----------|-----------------------------------------------|----------------------------------------|---------------------|
| 1.2-UNIT-008 | Unit  | P0       | Returns correct sum for single day            | Safety-critical quota calculation      | Test database       |
| 1.2-UNIT-009 | Unit  | P0       | Excludes previous days from calculation       | Prevents incorrect quota enforcement   | Test database       |
| 1.2-UNIT-010 | Unit  | P1       | Returns 0 for day with no usage               | Edge case handling                     | Test database       |
| 1.2-UNIT-011 | Unit  | P0       | Handles multiple API calls same day           | Real-world scenario                    | Test database       |

#### Scenarios - is_quota_exceeded()

| ID           | Level | Priority | Test Description                              | Justification                          | Mock Requirements    |
|--------------|-------|----------|-----------------------------------------------|----------------------------------------|---------------------|
| 1.2-UNIT-012 | Unit  | P0       | Returns True when usage >= 9500               | Critical quota threshold enforcement   | Mock get_daily_quota |
| 1.2-UNIT-013 | Unit  | P0       | Returns False when usage < 9500               | Allows continued API usage             | Mock get_daily_quota |
| 1.2-UNIT-014 | Unit  | P1       | Returns False when no usage (0)               | Edge case - startup scenario           | Mock get_daily_quota |
| 1.2-UNIT-015 | Unit  | P2       | Handles edge case at exactly 9500             | Boundary condition validation          | Mock get_daily_quota |

#### Integration Scenarios

| ID           | Level       | Priority | Test Description                              | Justification                          | Mock Requirements |
|--------------|-------------|----------|-----------------------------------------------|----------------------------------------|-------------------|
| 1.2-INT-005  | Integration | P0       | Full workflow: log + query + check            | Multi-component integration            | Test database     |
| 1.2-INT-006  | Integration | P1       | Database schema has correct indexes           | Performance validation                 | Test database     |
| 1.2-INT-007  | Integration | P1       | Context manager closes connections            | Resource management (TIER 2)           | Test database     |

**Coverage:** 12 unit tests, 3 integration tests (100% coverage for safety-critical quota functions)

---

### AC7: Error Handling for Quota Exceeded

#### Scenarios

| ID           | Level       | Priority | Test Description                              | Justification                          | Mock Requirements       |
|--------------|-------------|----------|-----------------------------------------------|----------------------------------------|------------------------|
| 1.2-UNIT-016 | Unit        | P0       | QuotaExceededError can be raised              | Error handling validation              | None                   |
| 1.2-UNIT-017 | Unit        | P0       | Error has Norwegian message                   | TIER 3 requirement                     | None                   |
| 1.2-UNIT-018 | Unit        | P0       | HTTP 403 quotaExceeded triggers error         | API error mapping                      | Mock HttpError         |
| 1.2-INT-008  | Integration | P0       | Error response has correct JSON format        | API contract validation (TIER 2)       | Test API endpoint      |

**Coverage:** 3 unit tests, 1 integration test (100% coverage for error handling)

---

### AC8: Documentation Created

**Status:** Manual review only (no automated tests)

**Verification Checklist:**
- [ ] docs/youtube-api-setup.md created with all sections
- [ ] README.md updated with API setup section
- [ ] All steps are clear and complete
- [ ] Screenshots or detailed instructions included
- [ ] Troubleshooting section included

---

### AC9: API Key Validation Function

#### Unit Test Scenarios (with mocks)

| ID           | Level | Priority | Test Description                              | Justification                          | Mock Requirements       |
|--------------|-------|----------|-----------------------------------------------|----------------------------------------|------------------------|
| 1.2-UNIT-019 | Unit  | P0       | Returns True for successful API response      | Happy path validation                  | Mock youtube.search()  |
| 1.2-UNIT-020 | Unit  | P0       | Returns False for HTTP 400 (bad request)      | Invalid key detection                  | Mock HttpError 400     |
| 1.2-UNIT-021 | Unit  | P0       | Returns False for HTTP 403 (forbidden)        | Invalid key detection                  | Mock HttpError 403     |
| 1.2-UNIT-022 | Unit  | P1       | Raises exception for network errors           | Error propagation                      | Mock network error     |
| 1.2-UNIT-023 | Unit  | P0       | Logs validation result to database            | Audit trail requirement                | Mock log_api_call      |

#### Integration Test Scenarios

| ID           | Level       | Priority | Test Description                              | Justification                          | Mock Requirements |
|--------------|-------------|----------|-----------------------------------------------|----------------------------------------|-------------------|
| 1.2-INT-009  | Integration | P0       | Real API call with valid key returns True     | End-to-end validation with real API    | Valid API key     |
| 1.2-INT-010  | Integration | P1       | Real API call with invalid key returns False  | Invalid key detection with real API    | Invalid API key   |
| 1.2-INT-011  | Integration | P2       | Validation uses minimal quota (1 unit)        | Quota efficiency verification          | Valid API key     |

#### E2E Test Scenarios

| ID          | Level | Priority | Test Description                              | Justification                          | Environment       |
|-------------|-------|----------|-----------------------------------------------|----------------------------------------|-------------------|
| 1.2-E2E-001 | E2E   | P0       | Application starts successfully with valid key| Critical startup path                  | Full environment  |
| 1.2-E2E-002 | E2E   | P0       | Application logs error with invalid key       | Startup failure handling               | Full environment  |
| 1.2-E2E-003 | E2E   | P1       | Application logs error with missing key       | Configuration error handling           | Full environment  |
| 1.2-E2E-004 | E2E   | P2       | Startup validation logs to database           | Audit trail verification               | Full environment  |

**Coverage:** 5 unit tests, 3 integration tests, 4 E2E tests (100% coverage for validation logic)

---

## Risk Coverage Analysis

### High-Risk Scenarios Addressed

1. **API quota overuse (RISK: Service disruption)**
   - Covered by: 1.2-UNIT-004 through 1.2-UNIT-015, 1.2-INT-005
   - Mitigation: 100% coverage of quota tracking and threshold enforcement

2. **Invalid API key at runtime (RISK: Application failure)**
   - Covered by: 1.2-UNIT-019 through 1.2-UNIT-023, 1.2-INT-009, 1.2-E2E-001, 1.2-E2E-002
   - Mitigation: Validation at startup prevents runtime failures

3. **SQL injection in quota logging (RISK: Security vulnerability)**
   - Covered by: 1.2-UNIT-007
   - Mitigation: TIER 1 safety rule enforcement

4. **API key exposure (RISK: Security breach)**
   - Covered by: 1.2-INT-001, 1.2-INT-002
   - Mitigation: .gitignore verification

5. **Incorrect quota calculation (RISK: Wrong limit enforcement)**
   - Covered by: 1.2-UNIT-008, 1.2-UNIT-009, 1.2-UNIT-011
   - Mitigation: Multi-day and multi-call scenarios

### Low-Risk Scenarios Deferred

- Advanced quota prediction algorithms (not required for Story 1.2)
- Quota reset at midnight Pacific Time (handled by YouTube, not testable)
- Multiple API key rotation (not in requirements)

---

## Test Execution Strategy

### Recommended Execution Order

1. **Phase 1: P0 Unit Tests (critical path, fast feedback)**
   - 1.2-UNIT-002 (Config error on missing key)
   - 1.2-UNIT-004 through 1.2-UNIT-015 (Quota tracking)
   - 1.2-UNIT-016 through 1.2-UNIT-018 (Error handling)
   - 1.2-UNIT-019 through 1.2-UNIT-023 (Validation logic)
   - **Expected duration:** 5-10 seconds
   - **Fail fast:** Stop if any P0 unit test fails

2. **Phase 2: P0 Integration Tests**
   - 1.2-INT-005 (Full quota workflow)
   - 1.2-INT-008 (Error response format)
   - 1.2-INT-009 (Real API validation)
   - **Expected duration:** 10-20 seconds
   - **Requires:** Valid test API key

3. **Phase 3: P0 E2E Tests**
   - 1.2-E2E-001 (Startup with valid key)
   - 1.2-E2E-002 (Startup with invalid key)
   - **Expected duration:** 30-60 seconds
   - **Requires:** Full application environment

4. **Phase 4: P1 Tests (all levels)**
   - All P1 unit, integration, and E2E tests
   - **Expected duration:** 20-40 seconds

5. **Phase 5: P2 Tests (if time permits)**
   - All P2 tests
   - **Expected duration:** 10-20 seconds

### Total Estimated Execution Time

- **P0 tests only:** 45-90 seconds
- **P0 + P1 tests:** 65-130 seconds
- **All tests (P0 + P1 + P2):** 75-150 seconds

---

## Test Implementation Guidelines

### Unit Test Structure

```python
# tests/backend/db/test_queries.py

import pytest
from datetime import datetime, timezone, timedelta
from backend.db.queries import log_api_call, get_daily_quota_usage

def test_log_api_call_inserts_correct_data(test_db):
    """Test that log_api_call() inserts data correctly (1.2-UNIT-004)."""
    # Arrange
    api_name = "youtube_search"
    quota_cost = 100
    success = True

    # Act
    log_api_call(api_name, quota_cost, success)

    # Assert
    today = datetime.now(timezone.utc).date().isoformat()
    usage = get_daily_quota_usage(today)
    assert usage == 100

def test_get_daily_quota_usage_excludes_previous_days(test_db):
    """Test that quota calculation excludes previous days (1.2-UNIT-009)."""
    # Arrange
    today = datetime.now(timezone.utc).date().isoformat()
    yesterday = (datetime.now(timezone.utc).date() - timedelta(days=1)).isoformat()

    # Insert yesterday's usage (should be excluded)
    with get_connection() as conn:
        conn.execute(
            "INSERT INTO api_usage_log (api_name, quota_cost, timestamp, success) VALUES (?, ?, ?, ?)",
            ("youtube_search", 5000, f"{yesterday}T12:00:00Z", True)
        )

    # Insert today's usage
    log_api_call("youtube_search", 100, True)

    # Act
    usage = get_daily_quota_usage(today)

    # Assert
    assert usage == 100  # Only today's usage
```

### Integration Test Structure

```python
# tests/integration/test_youtube_api.py

import pytest
from backend.services.content_source import validate_youtube_api_key

@pytest.mark.integration
def test_validate_youtube_api_key_with_real_api(test_db):
    """
    Integration test: Validate API key with real YouTube API (1.2-INT-009).

    REQUIRES: Valid YOUTUBE_API_KEY in .env
    """
    # Act
    result = validate_youtube_api_key()

    # Assert
    assert result is True, "YouTube API key validation failed"
```

### E2E Test Structure

```python
# tests/e2e/test_application_startup.py

import pytest
from fastapi.testclient import TestClient

@pytest.mark.e2e
def test_application_starts_with_valid_api_key(monkeypatch):
    """
    E2E test: Application starts successfully with valid API key (1.2-E2E-001).

    REQUIRES: Valid YOUTUBE_API_KEY
    """
    # Arrange
    monkeypatch.setenv('YOUTUBE_API_KEY', 'valid_test_key')

    # Act
    from backend.main import app
    client = TestClient(app)
    response = client.get("/health")

    # Assert
    assert response.status_code == 200
```

---

## Coverage Gaps and Mitigation

### No Coverage Gaps Identified

All 9 acceptance criteria have appropriate test coverage:

- **AC1, AC2:** Manual verification (appropriate for one-time setup)
- **AC3:** 3 unit tests (config loading)
- **AC4:** 2 integration tests (security verification)
- **AC5:** 2 integration tests (dependency verification)
- **AC6:** 15 tests (12 unit, 3 integration) - 100% coverage for safety-critical quota tracking
- **AC7:** 4 tests (3 unit, 1 integration) - 100% coverage for error handling
- **AC8:** Manual review (appropriate for documentation)
- **AC9:** 12 tests (5 unit, 3 integration, 4 E2E) - 100% coverage for validation

**Total automated test coverage:** 30 tests across 7/9 ACs (78% of ACs, appropriate given 2 ACs are manual-only)

---

## Test Maintenance Considerations

### Tests Most Likely to Require Updates

1. **1.2-UNIT-012, 1.2-UNIT-013** (is_quota_exceeded threshold)
   - **If:** Quota threshold changes from 9500
   - **Update:** Test assertions to match new threshold

2. **1.2-UNIT-017** (Norwegian error message)
   - **If:** Error message wording changes
   - **Update:** Expected message string

3. **1.2-INT-009, 1.2-INT-010** (Real API validation)
   - **If:** YouTube API response format changes
   - **Update:** Response parsing logic

### Stable Tests (Low Maintenance)

- All quota calculation tests (SQL logic unlikely to change)
- Config loading tests (environment pattern stable)
- Database schema tests (schema defined in Story 1.1)

---

## Quality Gate YAML

```yaml
test_design:
  date: 2025-10-18
  story: "1.2"
  title: "YouTube API Setup"
  scenarios_total: 30
  by_level:
    unit: 18
    integration: 8
    e2e: 4
  by_priority:
    p0: 15
    p1: 10
    p2: 5
  coverage_gaps: []
  safety_critical_coverage: 100%
  overall_coverage_target: 85%
  estimated_execution_time: "75-150 seconds"
  test_files_required:
    - "tests/backend/db/test_queries.py"
    - "tests/backend/services/test_content_source.py"
    - "tests/integration/test_youtube_api.py"
    - "tests/e2e/test_application_startup.py"
```

---

## Sign-Off

**Test Architect:** Quinn
**Date:** 2025-10-18
**Status:** Test design complete and ready for implementation

**Recommendations:**
1. Implement P0 tests first (critical for quota safety)
2. Use test fixtures from conftest.py for database setup
3. Mock google-api-python-client for unit tests to avoid quota usage
4. Reserve integration tests with real API for CI/CD only (quota preservation)
5. Aim for 100% coverage on quota tracking and validation (safety-critical)

**Next Steps:**
- Review with development team
- Implement tests following the execution order
- Integrate into CI/CD pipeline with P0 tests as gate
