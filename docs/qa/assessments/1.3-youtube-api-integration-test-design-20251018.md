# Test Design: Story 1.3 - YouTube API Integration for Video Fetching

**Date:** 2025-10-18
**Designer:** Quinn (Test Architect)
**Story:** 1.3
**Story Title:** YouTube API Integration for Video Fetching

---

## Test Strategy Overview

### Summary Statistics

- **Total Test Scenarios:** 73
- **Unit Tests:** 45 (62%)
- **Integration Tests:** 25 (34%)
- **E2E Tests:** 3 (4%)
- **Priority Distribution:**
  - P0 (Critical): 28 scenarios (38%)
  - P1 (High): 25 scenarios (34%)
  - P2 (Medium): 15 scenarios (21%)
  - P3 (Low): 5 scenarios (7%)

### Test Level Distribution Rationale

**Unit Tests (62%):** Favored for pure logic, validation, parsing, and calculations. Fast feedback, easy to maintain, no external dependencies.

**Integration Tests (34%):** Required for database operations, API client interactions, multi-component flows. Tests actual integration points.

**E2E Tests (4%):** Reserved for critical user journeys in admin UI (Story 1.4). Minimal E2E in backend-only story.

### Risk Coverage Summary

| Risk ID   | Severity | Test Scenarios | Priority | Coverage Target |
|-----------|----------|----------------|----------|-----------------|
| PERF-002  | Critical | 8 scenarios    | P0       | 100%            |
| DATA-002  | High     | 6 scenarios    | P0       | 100%            |
| SEC-001   | High     | 5 scenarios    | P0       | 100%            |
| BUS-001   | High     | 4 scenarios    | P1       | 90%             |
| TECH-001  | Medium   | 8 scenarios    | P0       | 95%             |
| SEC-002   | Medium   | 6 scenarios    | P0       | 100%            |
| PERF-001  | Medium   | 4 scenarios    | P1       | 90%             |
| PERF-003  | Medium   | 3 scenarios    | P1       | 85%             |
| TECH-002  | Low      | 3 scenarios    | P2       | 80%             |
| DATA-001  | Low      | 3 scenarios    | P2       | 80%             |
| SEC-003   | Low      | 2 scenarios    | P2       | 70%             |
| DATA-003  | Low      | 3 scenarios    | P2       | 80%             |
| OPS-002   | Medium   | 4 scenarios    | P1       | 80%             |

**All 14 identified risks have dedicated test coverage.**

---

## Test Scenarios by Acceptance Criteria

### AC1: YouTube Data API v3 Client Configured with API Key

**Risk Coverage:** SEC-001 (High), PERF-002 (Critical)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-UNIT-001 | Unit        | P0       | Load API key from environment variable           | Pure config logic, no dependencies     | SEC-001        |
| 1.3-UNIT-002 | Unit        | P0       | Validate API key format (length, charset)        | Input validation, TIER 1 Rule 5        | SEC-001        |
| 1.3-UNIT-003 | Unit        | P0       | Reject empty/null API key                        | Input validation, TIER 1 Rule 5        | SEC-001        |
| 1.3-INT-001  | Integration | P0       | Create YouTube client with valid API key         | Tests actual API client instantiation  | SEC-001        |
| 1.3-INT-002  | Integration | P0       | Validate API key at startup with test request    | Early failure detection, Story 1.2     | SEC-001        |
| 1.3-INT-003  | Integration | P0       | Handle invalid API key with Norwegian error      | Error handling, TIER 2 Rule 14         | SEC-001        |

**Coverage Target:** 100% (Security critical, TIER 1)

---

### AC2: Function to Fetch All Videos from Channel (Fully Paginated)

**Risk Coverage:** DATA-002 (High), TECH-001 (Medium), PERF-001 (Medium)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-UNIT-004 | Unit        | P0       | Parse single-page channel response (≤50 videos)  | Pure logic, no API needed              | TECH-001       |
| 1.3-UNIT-005 | Unit        | P0       | Parse multi-page channel response (>50 videos)   | Pagination logic, no API needed        | TECH-001       |
| 1.3-UNIT-006 | Unit        | P0       | Handle nextPageToken correctly                   | Pagination state management            | TECH-001       |
| 1.3-UNIT-007 | Unit        | P0       | Detect end of pagination (no nextPageToken)      | Loop termination logic                 | TECH-001       |
| 1.3-UNIT-008 | Unit        | P0       | Extract video IDs from search response           | Data extraction logic                  | -              |
| 1.3-INT-004  | Integration | P0       | Fetch channel with 0 videos (empty channel)      | Edge case, boundary validation         | TECH-001       |
| 1.3-INT-005  | Integration | P0       | Fetch channel with 1 video                       | Minimal success case                   | TECH-001       |
| 1.3-INT-006  | Integration | P0       | Fetch channel with exactly 50 videos             | Page boundary edge case                | TECH-001       |
| 1.3-INT-007  | Integration | P0       | Fetch channel with 51 videos (2 pages)           | Pagination trigger validation          | TECH-001       |
| 1.3-INT-008  | Integration | P1       | Fetch channel with 500+ videos (10+ pages)       | Large channel performance              | PERF-001       |
| 1.3-INT-009  | Integration | P0       | Network failure on page 3 of 5 returns partial   | Partial fetch handling, Story design   | DATA-002       |
| 1.3-INT-010  | Integration | P0       | Network failure sets fetch_complete=False        | Data integrity flag                    | DATA-002       |
| 1.3-INT-011  | Integration | P1       | Measure fetch time for 2000-video channel        | Performance validation                 | PERF-001       |
| 1.3-INT-012  | Integration | P0       | Log quota usage after each search page (100)     | Quota tracking, PERF-002               | PERF-002       |

**Coverage Target:** 100% for pagination logic, 90% for performance scenarios

---

### AC3: Function to Fetch All Videos from Playlist (Fully Paginated)

**Risk Coverage:** DATA-002 (High), TECH-001 (Medium)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-UNIT-009 | Unit        | P0       | Parse single-page playlist response (≤50 videos) | Pure logic, no API needed              | TECH-001       |
| 1.3-UNIT-010 | Unit        | P0       | Parse multi-page playlist response (>50 videos)  | Pagination logic                       | TECH-001       |
| 1.3-UNIT-011 | Unit        | P0       | Extract video ID from playlist item              | Data extraction from nested structure  | -              |
| 1.3-INT-013  | Integration | P0       | Fetch playlist with 0 videos (empty playlist)    | Edge case, boundary validation         | TECH-001       |
| 1.3-INT-014  | Integration | P0       | Fetch playlist with 1 video                      | Minimal success case                   | TECH-001       |
| 1.3-INT-015  | Integration | P0       | Fetch playlist with exactly 50 videos            | Page boundary edge case                | TECH-001       |
| 1.3-INT-016  | Integration | P0       | Fetch playlist with 150 videos (3 pages)         | Multi-page validation                  | TECH-001       |
| 1.3-INT-017  | Integration | P0       | Network failure on playlist fetch returns partial| Partial fetch handling                 | DATA-002       |
| 1.3-INT-018  | Integration | P0       | Log quota usage after each playlistItems page (1)| Quota tracking                         | PERF-002       |

**Coverage Target:** 100% for pagination logic, 100% for error handling

---

### AC4: Extract Video ID, Title, Thumbnail URL, Duration, Publish Date

**Risk Coverage:** TECH-002 (Low), DATA-003 (Low)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-UNIT-012 | Unit        | P0       | Extract video_id from API response               | Pure data extraction                   | DATA-003       |
| 1.3-UNIT-013 | Unit        | P0       | Extract title from API response                  | Pure data extraction                   | DATA-003       |
| 1.3-UNIT-014 | Unit        | P0       | Extract youtube_channel_id from API response     | Pure data extraction                   | DATA-003       |
| 1.3-UNIT-015 | Unit        | P0       | Extract youtube_channel_name from API response   | Pure data extraction                   | DATA-003       |
| 1.3-UNIT-016 | Unit        | P0       | Extract thumbnail_url from API response          | Pure data extraction                   | DATA-003       |
| 1.3-UNIT-017 | Unit        | P0       | Extract published_at from API response           | Pure data extraction                   | DATA-003       |
| 1.3-UNIT-018 | Unit        | P0       | Parse standard ISO 8601 duration (PT4M5S→245s)   | Duration parsing, isodate library      | TECH-002       |
| 1.3-UNIT-019 | Unit        | P2       | Parse edge case: livestream duration (P0D→0s)    | Edge case handling                     | TECH-002       |
| 1.3-UNIT-020 | Unit        | P2       | Parse edge case: very long video (PT10H30M)      | Edge case handling                     | TECH-002       |
| 1.3-UNIT-021 | Unit        | P0       | Set fetched_at with UTC timezone                 | TIER 1 Rule 3 compliance               | -              |
| 1.3-UNIT-022 | Unit        | P2       | Handle missing optional fields gracefully        | Defensive programming                  | DATA-003       |
| 1.3-INT-019  | Integration | P0       | Batch video details fetch (50 IDs per request)   | Batching logic validation              | -              |
| 1.3-INT-020  | Integration | P0       | Log quota usage after video details batch (1)    | Quota tracking                         | PERF-002       |

**Coverage Target:** 100% for required fields, 80% for edge cases

---

### AC5: Handle Pagination for Channels with Many Videos

**Risk Coverage:** TECH-001 (Medium), PERF-001 (Medium), PERF-002 (Critical)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-UNIT-023 | Unit        | P0       | Safety valve triggers at 100 pages (5000 videos) | Infinite loop prevention               | TECH-001       |
| 1.3-UNIT-024 | Unit        | P0       | Log warning when safety valve triggered          | Observability                          | TECH-001       |
| 1.3-INT-021  | Integration | P1       | Fetch channel with 5000+ videos successfully     | Stress test pagination                 | PERF-001       |
| 1.3-INT-022  | Integration | P1       | Verify fetch completes within 5 minutes          | Timeout validation                     | PERF-001       |
| 1.3-INT-023  | Integration | P0       | Check is_quota_exceeded() before each API call   | Quota enforcement, PERF-002            | PERF-002       |
| 1.3-INT-024  | Integration | P0       | Stop fetching if quota exceeded mid-operation    | Quota enforcement                      | PERF-002       |

**Coverage Target:** 95% (safety valve and quota critical)

---

### AC6: Cache Video Metadata in SQLite Database

**Risk Coverage:** PERF-003 (Medium), DATA-002 (High)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-UNIT-025 | Unit        | P0       | Use SQL placeholders in bulk insert (TIER 1)     | SQL injection prevention               | -              |
| 1.3-UNIT-026 | Unit        | P0       | Prepare video tuples for executemany()           | Data transformation logic              | -              |
| 1.3-INT-025  | Integration | P0       | Bulk insert 10 videos successfully               | Basic persistence validation           | -              |
| 1.3-INT-026  | Integration | P0       | Bulk insert 500 videos successfully              | Batch operation validation             | PERF-003       |
| 1.3-INT-027  | Integration | P1       | Bulk insert 2000 videos within 10 seconds        | Performance validation                 | PERF-003       |
| 1.3-INT-028  | Integration | P1       | Read operations succeed during bulk insert       | Concurrency validation (WAL mode)      | PERF-003       |
| 1.3-INT-029  | Integration | P0       | Insert content_source with UTC timestamps        | TIER 1 Rule 3 compliance               | -              |
| 1.3-INT-030  | Integration | P0       | Verify foreign key constraint on CASCADE DELETE  | Database integrity                     | -              |
| 1.3-INT-031  | Integration | P0       | Use context manager for all DB operations        | TIER 2 Rule 7 compliance               | -              |
| 1.3-INT-032  | Integration | P0       | Rollback on error during insert                  | Transaction integrity                  | DATA-002       |

**Coverage Target:** 100% for data integrity, 85% for performance

---

### AC7: Gracefully Handle API Quota Limits with Error Messages

**Risk Coverage:** PERF-002 (Critical), BUS-001 (High), OPS-002 (Medium)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-UNIT-027 | Unit        | P0       | Detect quota exceeded (usage ≥ 9500 units)       | Pure logic, threshold validation       | PERF-002       |
| 1.3-UNIT-028 | Unit        | P0       | Calculate remaining quota correctly              | Quota math validation                  | PERF-002       |
| 1.3-UNIT-029 | Unit        | P0       | Reserve 2000 units for weekly refresh            | Budget allocation logic                | PERF-002       |
| 1.3-INT-033  | Integration | P0       | Reject add_source() when quota at 9400 units     | Quota enforcement before operation     | PERF-002       |
| 1.3-INT-034  | Integration | P0       | Allow add_source() when quota at 1000 units      | Quota enforcement boundary             | PERF-002       |
| 1.3-INT-035  | Integration | P0       | Raise QuotaExceededError with Norwegian message  | TIER 2 Rule 14 compliance              | OPS-002        |
| 1.3-INT-036  | Integration | P1       | Error message includes quota reset time          | User guidance improvement              | OPS-002, BUS-001|
| 1.3-INT-037  | Integration | P0       | Handle HttpError 403 quotaExceeded from API      | Actual API error handling              | PERF-002       |
| 1.3-INT-038  | Integration | P1       | Log quota exceeded events to api_usage_log       | Observability                          | PERF-002       |
| 1.3-UNIT-030 | Unit        | P1       | Estimate quota cost for small channel (<100)     | Pre-operation estimation               | BUS-001        |
| 1.3-UNIT-031 | Unit        | P1       | Estimate quota cost for large channel (2000+)    | Pre-operation estimation               | BUS-001        |

**Coverage Target:** 100% (TIER 1 safety critical, Critical Risk)

---

### AC8: Track API Quota Usage and Display in Admin Interface

**Risk Coverage:** PERF-002 (Critical), BUS-001 (High)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-UNIT-032 | Unit        | P1       | Format quota usage for display (X/10,000 units)  | Pure formatting logic                  | -              |
| 1.3-UNIT-033 | Unit        | P1       | Calculate quota percentage (X%)                  | Pure calculation logic                 | -              |
| 1.3-INT-039  | Integration | P1       | Log API call to api_usage_log with context       | Logging validation (Story 1.2)         | PERF-002       |
| 1.3-INT-040  | Integration | P1       | Retrieve daily quota usage sum for today         | Query validation                       | PERF-002       |
| 1.3-INT-041  | Integration | P1       | Calculate remaining quota accurately             | Query + calculation validation         | PERF-002       |
| 1.3-E2E-001  | E2E         | P1       | Display current quota usage in admin UI          | Full user flow (Story 1.4 dependency)  | BUS-001        |
| 1.3-E2E-002  | E2E         | P1       | Display quota reset countdown in admin UI        | Full user flow (Story 1.4 dependency)  | BUS-001        |

**Coverage Target:** 90% (integration), 100% (E2E when Story 1.4 implemented)

---

### AC9: Batch API Calls Efficiently to Minimize Quota Consumption

**Risk Coverage:** PERF-002 (Critical)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-UNIT-034 | Unit        | P1       | Batch video IDs into groups of 50                | Pure batching logic                    | PERF-002       |
| 1.3-UNIT-035 | Unit        | P1       | Handle non-multiple of 50 (e.g., 130 IDs→3 batches)| Edge case batching                   | PERF-002       |
| 1.3-UNIT-036 | Unit        | P1       | Handle less than 50 IDs (single batch)           | Edge case batching                     | PERF-002       |
| 1.3-INT-042  | Integration | P1       | Fetch 150 video details in 3 batches (3 units)   | Quota efficiency validation            | PERF-002       |
| 1.3-INT-043  | Integration | P1       | Verify 1 quota unit per video details batch      | Quota cost validation                  | PERF-002       |

**Coverage Target:** 90% (quota optimization important but not blocking)

---

## Additional Critical Test Scenarios

### URL Parsing & Validation (Story Requirement)

**Risk Coverage:** SEC-002 (Medium)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-UNIT-037 | Unit        | P0       | Parse valid channel URL (youtube.com/channel/X)  | Input validation, TIER 1 Rule 5        | SEC-002        |
| 1.3-UNIT-038 | Unit        | P0       | Parse valid custom URL (youtube.com/@handle)     | Input validation, TIER 1 Rule 5        | SEC-002        |
| 1.3-UNIT-039 | Unit        | P0       | Parse valid playlist URL (youtube.com/playlist)  | Input validation, TIER 1 Rule 5        | SEC-002        |
| 1.3-UNIT-040 | Unit        | P0       | Reject invalid URL with Norwegian error          | Input validation, TIER 2 Rule 14       | SEC-002        |
| 1.3-UNIT-041 | Unit        | P0       | Reject malformed URL with Norwegian error        | Input validation                       | SEC-002        |
| 1.3-UNIT-042 | Unit        | P0       | Reject URL >500 chars (length limit)             | ReDoS prevention                       | SEC-002        |
| 1.3-UNIT-043 | Unit        | P0       | Timeout on ReDoS attack string within 2 seconds  | Security validation                    | SEC-002        |
| 1.3-UNIT-044 | Unit        | P0       | Reject empty/null input with Norwegian error     | Input validation                       | SEC-002        |

**Coverage Target:** 100% (TIER 1 input validation)

---

### Deduplication Logic

**Risk Coverage:** DATA-001 (Low)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-UNIT-045 | Unit        | P2       | Remove duplicate video IDs from list             | Pure deduplication logic               | DATA-001       |
| 1.3-UNIT-046 | Unit        | P2       | Keep first occurrence of duplicate               | Deduplication behavior validation      | DATA-001       |
| 1.3-UNIT-047 | Unit        | P2       | Log warning for each duplicate found             | Observability                          | DATA-001       |
| 1.3-INT-044  | Integration | P2       | Handle API response with duplicates              | Real-world scenario validation         | DATA-001       |

**Coverage Target:** 80% (low risk, simple logic)

---

### Retry Logic with Exponential Backoff

**Risk Coverage:** DATA-002 (High)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-UNIT-048 | Unit        | P1       | Retry network error with 0s, 1s, 2s backoff      | Pure retry logic                       | DATA-002       |
| 1.3-UNIT-049 | Unit        | P0       | Do NOT retry on 403 quota exceeded               | Error categorization logic             | DATA-002       |
| 1.3-UNIT-050 | Unit        | P0       | Do NOT retry on 404 not found                    | Error categorization logic             | DATA-002       |
| 1.3-INT-045  | Integration | P1       | Network error on attempt 1, success on attempt 2 | Retry flow validation                  | DATA-002       |
| 1.3-INT-046  | Integration | P1       | Network error all 3 attempts, return failure     | Retry exhaustion handling              | DATA-002       |
| 1.3-INT-047  | Integration | P0       | Measure backoff timing (actual 0s, 1s, 2s wait)  | Timing validation                      | DATA-002       |

**Coverage Target:** 100% (data integrity critical)

---

### API Key Security & Sanitization

**Risk Coverage:** SEC-001 (High)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-INT-048  | Integration | P0       | Invalid API key error does NOT log full key      | Security validation                    | SEC-001        |
| 1.3-INT-049  | Integration | P0       | Quota exceeded error does NOT expose key         | Security validation                    | SEC-001        |
| 1.3-INT-050  | Integration | P0       | Stack trace sanitized before logging             | Security validation                    | SEC-001        |
| 1.3-INT-051  | Integration | P0       | Search logs for 'YOUTUBE_API_KEY' pattern (none found)| Security audit                    | SEC-001        |

**Coverage Target:** 100% (security critical)

---

### Duplicate Source Detection

**Risk Coverage:** Business Logic (not explicit risk)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-INT-052  | Integration | P1       | Detect duplicate source_id in database           | Prevent duplicate content sources      | -              |
| 1.3-INT-053  | Integration | P1       | Raise error with Norwegian message on duplicate  | TIER 2 Rule 14 compliance              | -              |

**Coverage Target:** 90%

---

### Error Handling & User Messages

**Risk Coverage:** OPS-002 (Medium)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-INT-054  | Integration | P1       | 404 channel not found → "Kanal ikke funnet"      | User-facing error, Norwegian           | OPS-002        |
| 1.3-INT-055  | Integration | P1       | Network timeout → Return partial with message    | User guidance                          | OPS-002        |
| 1.3-INT-056  | Integration | P2       | Database error → Clear Norwegian message         | User guidance                          | OPS-002        |

**Coverage Target:** 80%

---

### Video Metadata Edge Cases

**Risk Coverage:** SEC-003 (Low), DATA-003 (Low)

| Test ID      | Level       | Priority | Test Scenario                                    | Justification                          | Mitigates Risk |
|--------------|-------------|----------|--------------------------------------------------|----------------------------------------|----------------|
| 1.3-UNIT-051 | Unit        | P2       | Handle title with Unicode characters             | Internationalization                   | SEC-003        |
| 1.3-UNIT-052 | Unit        | P2       | Handle very long title (>500 chars)              | Edge case handling                     | SEC-003        |
| 1.3-INT-057  | Integration | P2       | Render Unicode title safely in UI                | XSS prevention (UI context)            | SEC-003        |

**Coverage Target:** 70% (low risk, UI rendering in Story 1.4)

---

## Risk-to-Test Mapping

### Critical Risk (PERF-002): Quota Exhaustion

**Test Scenarios:** 1.3-UNIT-027 to 1.3-UNIT-031, 1.3-INT-023, 1.3-INT-024, 1.3-INT-033 to 1.3-INT-038

**Coverage:** 11 dedicated test scenarios
**Priority:** P0
**Target:** 100% pass rate (blocking requirement)

**Key Validations:**
- Quota exceeded detection at 9500 units
- Budget allocation (2000 units reserved for refresh)
- Pre-operation quota validation
- Norwegian error messages
- Logging and observability

---

### High Risk (DATA-002): Network Failure Partial Data

**Test Scenarios:** 1.3-INT-009 to 1.3-INT-012, 1.3-INT-017, 1.3-INT-032, 1.3-UNIT-048 to 1.3-UNIT-050, 1.3-INT-045 to 1.3-INT-047

**Coverage:** 10 dedicated test scenarios
**Priority:** P0
**Target:** 100% pass rate (data integrity critical)

**Key Validations:**
- Partial fetch handling with fetch_complete flag
- Retry logic with exponential backoff (0s, 1s, 2s)
- Do NOT retry on quota exceeded or not found errors
- Transaction rollback on error
- Timing validation for backoff

---

### High Risk (SEC-001): API Key Exposure

**Test Scenarios:** 1.3-UNIT-001 to 1.3-UNIT-003, 1.3-INT-001 to 1.3-INT-003, 1.3-INT-048 to 1.3-INT-051

**Coverage:** 9 dedicated test scenarios
**Priority:** P0
**Target:** 100% pass rate (security critical)

**Key Validations:**
- API key never logged in full
- Stack trace sanitization
- Error message sanitization
- Security audit of log output

---

### High Risk (BUS-001): Quota Preventing Initial Setup

**Test Scenarios:** 1.3-UNIT-030, 1.3-UNIT-031, 1.3-INT-036, 1.3-E2E-001, 1.3-E2E-002

**Coverage:** 5 dedicated test scenarios
**Priority:** P1
**Target:** 90% pass rate (UX improvement)

**Key Validations:**
- Quota estimation before operations
- Reset time in error messages
- Admin UI display (Story 1.4 dependency)

---

### Medium Risk (TECH-001): Pagination Logic Failures

**Test Scenarios:** 1.3-UNIT-004 to 1.3-UNIT-011, 1.3-INT-004 to 1.3-INT-007, 1.3-INT-013 to 1.3-INT-016, 1.3-UNIT-023, 1.3-UNIT-024

**Coverage:** 16 dedicated test scenarios
**Priority:** P0
**Target:** 95% pass rate (core functionality)

**Key Validations:**
- Single-page and multi-page responses
- Page boundary edge cases (50, 51 videos)
- Empty channels/playlists
- Safety valve at 100 pages
- nextPageToken handling

---

### Medium Risk (SEC-002): URL Parsing ReDoS

**Test Scenarios:** 1.3-UNIT-037 to 1.3-UNIT-044

**Coverage:** 8 dedicated test scenarios
**Priority:** P0
**Target:** 100% pass rate (TIER 1 input validation)

**Key Validations:**
- Valid URL formats (channel, custom, playlist)
- Invalid URL rejection
- Length limit enforcement (500 chars)
- ReDoS timeout within 2 seconds
- Norwegian error messages

---

## Test Execution Strategy

### Phase 1: Fast Feedback (P0 Unit Tests)

**Goal:** Catch logic errors immediately
**Duration:** ~2 minutes
**Tests:** 1.3-UNIT-001 to 1.3-UNIT-050 (P0 only, ~28 tests)

**Execution:**
```bash
uv run pytest -m tier1 -v
```

**Acceptance Criteria:** 100% pass rate required to proceed

---

### Phase 2: Integration Validation (P0 Integration Tests)

**Goal:** Validate component interactions
**Duration:** ~10 minutes
**Tests:** 1.3-INT-001 to 1.3-INT-051 (P0 only, ~20 tests)

**Execution:**
```bash
uv run pytest tests/backend/ -m "not integration" -v
```

**Acceptance Criteria:** 100% pass rate required to proceed

---

### Phase 3: Integration with Real API (P0 Integration Tests)

**Goal:** Validate with real YouTube API
**Duration:** ~5 minutes
**Tests:** Selected integration tests with live API (requires valid API key)

**Execution:**
```bash
uv run pytest -m integration -v
```

**Acceptance Criteria:** 100% pass rate, real quota consumption logged

---

### Phase 4: Secondary Tests (P1/P2 Tests)

**Goal:** Comprehensive coverage
**Duration:** ~15 minutes
**Tests:** All P1 and P2 tests

**Execution:**
```bash
uv run pytest tests/backend/ -v
```

**Acceptance Criteria:** ≥90% pass rate acceptable with documented exceptions

---

### Phase 5: E2E Validation (Deferred to Story 1.4)

**Goal:** Full user journey validation
**Duration:** ~10 minutes
**Tests:** 1.3-E2E-001, 1.3-E2E-002, 1.3-E2E-003

**Note:** E2E tests require admin UI implementation from Story 1.4

---

## Coverage Targets by Component

| Component                    | Unit | Integration | E2E  | Overall Target | Rationale                          |
|------------------------------|------|-------------|------|----------------|------------------------------------|
| Quota Management Functions   | 100% | 100%        | N/A  | 100%           | TIER 1 safety critical             |
| URL Parsing & Validation     | 100% | N/A         | N/A  | 100%           | TIER 1 input validation            |
| Network Failure Handling     | 100% | 100%        | N/A  | 100%           | Data integrity critical            |
| API Key Security             | 100% | 100%        | N/A  | 100%           | Security critical                  |
| Pagination Logic             | 100% | 90%         | N/A  | 95%            | Core functionality, complex logic  |
| Video Fetching Functions     | 90%  | 90%         | N/A  | 90%            | Core functionality                 |
| Database Operations          | 85%  | 85%         | N/A  | 85%            | Standard backend coverage          |
| Duration Parsing             | 80%  | N/A         | N/A  | 80%            | Low risk, mature library           |
| Deduplication Logic          | 80%  | 80%         | N/A  | 80%            | Low risk, simple logic             |
| Error Messaging              | 80%  | 80%         | N/A  | 80%            | UX quality                         |
| Admin UI Quota Display       | N/A  | N/A         | 100% | 100%           | Deferred to Story 1.4              |

**Overall Story Coverage Target:** 87% (weighted average)

---

## Test Automation Requirements

### Continuous Integration (CI) Pipeline

**Mandatory Tests (Block Merge):**
- All P0 unit tests (1.3-UNIT-001 to 1.3-UNIT-050)
- All P0 integration tests (1.3-INT-001 to 1.3-INT-051)
- Code formatting: `uv run black .`
- Linting: `uv run ruff check .`
- Type checking: `uv run mypy backend/`

**Optional Tests (Advisory):**
- P1/P2 integration tests (may require extended timeout)
- P3 tests (run nightly)

---

### Test Fixtures & Mocking Strategy

**Required Fixtures:**
- In-memory SQLite database (reset per test)
- Mock YouTube API responses (single-page, multi-page, errors)
- Sample video data (10, 50, 100, 500, 2000 videos)
- Mock quota usage scenarios (low, medium, high, exceeded)

**Mocking Strategy:**
- Mock `googleapiclient.discovery.build()` for unit/integration tests
- Use `pytest-mock` for function-level mocking
- Use real YouTube API for integration tests (mark with `@pytest.mark.integration`)

---

## Test Data Requirements

### Sample Channels

**Small Channel (10 videos):**
- Purpose: Fast validation, minimal quota
- Use: Unit and integration tests

**Medium Channel (100 videos):**
- Purpose: Multi-page validation (2 pages)
- Use: Integration tests

**Large Channel (500+ videos):**
- Purpose: Performance validation, pagination stress
- Use: Integration tests (P1 priority)

**Very Large Channel (2000+ videos):**
- Purpose: Extreme pagination, performance limits
- Use: Manual testing or nightly runs (P2 priority)

---

## Recommended Execution Order

**Development Phase (Iterative):**
1. Write P0 unit tests first (TDD approach)
2. Implement function to pass unit tests
3. Write P0 integration tests
4. Refactor for integration test passing
5. Code review and TIER 1 compliance check
6. Write P1/P2 tests as time permits

**Pre-Merge Validation:**
1. Run all P0 unit tests (must pass 100%)
2. Run all P0 integration tests (must pass 100%)
3. Run code quality tools (black, ruff, mypy)
4. Manual review of error messages (Norwegian compliance)
5. Security review of API key handling
6. Performance spot-check (2000-video channel <5 min)

**Regression Suite (Nightly):**
1. All unit tests (P0-P3)
2. All integration tests (P0-P3)
3. Integration tests with real YouTube API
4. Performance benchmarks
5. Coverage report generation

---

## Quality Gate Criteria

### Minimum Requirements for Story 1.3 Completion

**Must Pass (Blocking):**
- [ ] All P0 unit tests pass at 100% rate
- [ ] All P0 integration tests pass at 100% rate
- [ ] Quota management coverage = 100%
- [ ] URL parsing validation coverage = 100%
- [ ] Network failure handling coverage = 100%
- [ ] API key security coverage = 100%
- [ ] Overall story coverage ≥ 87%
- [ ] No TIER 1 rule violations in code review
- [ ] All error messages in Norwegian (user-facing)
- [ ] All log messages in English (developer-facing)

**Should Pass (Advisory):**
- [ ] P1 tests pass at ≥90% rate
- [ ] Performance tests meet targets (<5 min for 2000 videos)
- [ ] No high-severity linting issues
- [ ] Type checking passes with no errors

**Nice to Have:**
- [ ] P2/P3 tests pass at ≥80% rate
- [ ] Test execution time <30 minutes total
- [ ] Documentation includes test examples

---

## Test Maintenance Considerations

### Long-Term Maintainability

**Test Stability:**
- Unit tests should never fail due to external factors
- Integration tests isolated with in-memory database
- E2E tests may require maintenance with UI changes (Story 1.4+)

**Test Performance:**
- Unit test suite should complete in <5 minutes
- Integration test suite should complete in <15 minutes
- Nightly regression suite can take up to 60 minutes

**Test Documentation:**
- Each test function has clear docstring
- Complex assertions include explanatory comments
- Test IDs map to this design document

---

## Appendices

### Appendix A: Test ID Legend

**Format:** `{EPIC}.{STORY}-{LEVEL}-{SEQ}`

**Levels:**
- UNIT: Unit test (pure logic, no dependencies)
- INT: Integration test (DB, API, multi-component)
- E2E: End-to-end test (full user journey)

**Example:** `1.3-UNIT-027` = Epic 1, Story 3, Unit Test, Sequence 027

---

### Appendix B: Test Priority Rationale

**P0 (Critical):**
- Revenue-impacting: N/A (single-family deployment)
- Security-critical: API key handling, SQL injection prevention
- Data integrity: Quota management, partial fetch recovery
- Regulatory compliance: N/A (child safety via content control, not data privacy)
- Previously broken functionality: N/A (new feature)

**P1 (High):**
- Core user journeys: Adding channels/playlists
- Frequently used features: Weekly refresh (future)
- Features with complex logic: Pagination, retry, batching
- Integration points: YouTube API, SQLite database
- Features affecting UX: Error messages, quota display

**P2 (Medium):**
- Secondary features: Deduplication, duration parsing edge cases
- Admin functionality: Quota monitoring (basic)
- Reporting features: N/A
- Configuration options: N/A
- UI polish: Error message clarity

**P3 (Low):**
- Rarely used features: Very long videos, livestreams
- Nice-to-have functionality: Advanced error recovery
- Cosmetic issues: Unicode rendering
- Non-critical optimizations: Batch size tuning

---

### Appendix C: Coverage Measurement

**Coverage Tool:** pytest-cov with HTML reports

**Measurement Commands:**
```bash
# Overall coverage
uv run pytest tests/backend/ --cov=backend --cov-report=html

# Component-specific coverage
uv run pytest tests/backend/services/ --cov=backend.services.content_source --cov-report=term

# Quota management coverage
uv run pytest tests/backend/ -k "quota" --cov=backend.services.youtube_quota --cov-report=term
```

**Coverage Exclusions:**
- Type stub files (*.pyi)
- Test files themselves (tests/**)
- Configuration files (backend/config.py - trivial logic)

---

### Appendix D: Test Environment Setup

**Prerequisites:**
- Python 3.11.7
- uv package manager
- SQLite 3.45.0 (built-in)
- Valid YouTube API key (for integration tests with real API)

**Installation:**
```bash
# Install backend dependencies
uv sync --extra dev

# Initialize test database (in-memory, handled by fixtures)
# No explicit setup needed
```

**Environment Variables:**
```bash
# Required for integration tests with real API
export YOUTUBE_API_KEY="your-test-api-key"
export DATABASE_PATH=":memory:"  # Force in-memory for tests
```

---

### Appendix E: Related Documentation

**Story Specification:** `docs/stories/1.3.youtube-api-integration.md`
**Risk Profile:** `docs/qa/assessments/1.3-youtube-api-integration-risk-20251018.md`
**Architecture Standards:** `docs/architecture/coding-standards.md`
**API Documentation:** `docs/architecture/external-apis.md`
**Database Schema:** `docs/architecture/database-schema.md`
**Test Strategy:** `docs/architecture/test-strategy-and-standards.md`

---

## Revision History

| Date       | Version | Changes                                      | Author |
|------------|---------|----------------------------------------------|--------|
| 2025-10-18 | 1.0     | Initial test design for Story 1.3            | Quinn  |

---

**Document Status:** FINAL
**Approval Required:** Product Owner + Development Lead
**Next Review:** After Story 1.3 implementation OR 2025-11-18 (30 days)
