# Test Design: Story 4.5 - Audio Feedback System

**Date:** 2025-11-04
**Designer:** Quinn (Test Architect)
**Story:** Epic 4, Story 5 - Audio Feedback System

## Test Strategy Overview

- **Total test scenarios:** 20
- **Unit tests:** 8 (40%)
- **Integration tests:** 5 (25%)
- **E2E tests:** 6 (30%)
- **Static validation:** 1 (5%)
- **Priority distribution:**
  - P0: 5 scenarios (25%) - Critical stability and security
  - P1: 9 scenarios (45%) - Core functionality
  - P2: 5 scenarios (25%) - Secondary features
  - P3: 1 scenario (5%) - Nice-to-have

## Test Scenarios by Acceptance Criteria

### AC1: Playful "pop" sound on thumbnail click

**Risk:** High user impact if sounds don't play or delay interactions

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.5-UNIT-001 | Unit | P1 | playClickSound() executes when audio enabled | Pure function logic test |
| 4.5-UNIT-002 | Unit | P1 | playClickSound() skips when audio disabled | Validates enable/disable logic |
| 4.5-E2E-001 | E2E | P1 | Click thumbnail plays audible sound | Critical user journey validation |

**Coverage:** ✅ Complete - Unit tests logic, E2E validates user experience

---

### AC2: Gentle transition sound when returning to grid

**Risk:** Medium - enhances UX but not critical

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.5-UNIT-003 | Unit | P1 | playTransitionSound() executes when enabled | Pure function logic test |
| 4.5-E2E-002 | E2E | P1 | Return to grid plays transition sound | Validates navigation flow integration |

**Coverage:** ✅ Complete - Unit and E2E coverage

---

### AC3: Pleasant chime for warnings (not jarring)

**Risk:** High - poor warning sounds could distress children

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.5-UNIT-004 | Unit | P1 | playWarningChime(warningType) executes correctly | Function accepts parameter, plays sound |
| 4.5-E2E-003 | E2E | P1 | Warning display triggers chime sound | Validates integration with warning system |

**Coverage:** ✅ Complete - Function logic and integration tested
**Note:** Sound appropriateness (not jarring) validated manually in AC8

---

### AC4: Parent setting to enable/disable all sounds

**Risk:** Medium - parents need control over audio

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.5-UNIT-005 | Unit | P1 | isAudioEnabled() returns cached setting value | Tests fetch and caching logic |
| 4.5-UNIT-006 | Unit | P1 | setAudioEnabled(enabled) updates backend | Tests settings update flow |
| 4.5-INT-001 | Integration | P1 | POST /admin/settings persists audioEnabled | Validates API persistence |
| 4.5-INT-002 | Integration | P1 | GET /admin/settings returns audioEnabled | Validates API retrieval |
| 4.5-E2E-004 | E2E | P1 | Toggle audio setting prevents sound playback | Critical user control validation |

**Coverage:** ✅ Complete - Unit, integration, and E2E coverage

---

### AC5: Volume controls in parent interface

**Risk:** High - invalid volume values could cause errors

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.5-UNIT-007 | Unit | P1 | getVolumeFromSettings() returns correct value | Tests fetch and default logic |
| 4.5-UNIT-008 | Unit | P1 | Audio elements apply volume setting (0.0-1.0) | Tests volume application |
| 4.5-INT-003 | Integration | P0 | POST /admin/settings validates volume range (0.0-1.0) | **TIER 1 Rule 5** - Input validation |
| 4.5-INT-004 | Integration | P0 | POST /admin/settings rejects invalid volumes | **Security** - Prevents injection |
| 4.5-E2E-005 | E2E | P1 | Volume slider updates audio playback volume | Validates UI to audio pipeline |

**Coverage:** ✅ Complete - Strong focus on validation (P0)
**TIER 1 Requirement:** Input validation mandatory per coding standards

---

### AC6: Sounds load quickly and don't delay interactions

**Risk:** High - blocking loads degrade UX

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.5-UNIT-009 | Unit | P2 | Audio preloading is non-blocking (async) | Tests preload mechanism |
| 4.5-PERF-001 | Performance | P2 | Audio files preload in <500ms | Performance benchmark |

**Coverage:** ✅ Complete - Unit and performance validation
**Note:** Non-blocking preload critical for smooth page load

---

### AC7: All audio files optimized for web (<100KB each)

**Risk:** Low - static validation, one-time check

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.5-STATIC-001 | Static | P2 | Verify all 4 audio files are <100KB | File size validation |

**Coverage:** ✅ Complete - Static check during implementation
**Implementation:** `ls -lh frontend/public/sounds/*.mp3` validation

---

### AC8: Sounds appropriate for young children (no scary/harsh sounds)

**Risk:** High - inappropriate sounds could distress children

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.5-MANUAL-001 | Manual | P2 | Human validation of all 4 sounds | Subjective quality assessment |

**Coverage:** ✅ Manual validation required
**Process:** Developer/QA listens to all sounds at 70% volume, confirms:
- Soft, rounded tones (no harsh/sharp sounds)
- Playful, bouncy character (appropriate for ages 2-6)
- Warning chime is gentle, not jarring

---

### AC9: Fallback - application works perfectly without audio

**Risk:** CRITICAL - application stability depends on graceful degradation

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.5-UNIT-010 | Unit | P0 | playClickSound() catches audio.play() rejection | **Critical** - Browser autoplay blocks |
| 4.5-UNIT-011 | Unit | P0 | Audio loading failure logged, not thrown | **Critical** - Graceful error handling |
| 4.5-INT-005 | Integration | P0 | Settings fetch failure defaults to safe values | **Critical** - Resilient defaults |
| 4.5-E2E-006 | E2E | P0 | App functions with audio disabled (setting) | **Critical** - Validates fallback path |
| 4.5-E2E-007 | E2E | P0 | App functions with autoplay blocked (browser) | **Critical** - Real-world scenario |

**Coverage:** ✅ Comprehensive P0 coverage - This is the MOST CRITICAL AC
**Rationale:** Application must never break due to audio failures. All error paths must be tested.

**Error Scenarios Covered:**
- Audio files fail to load (network, 404, etc.)
- Browser blocks autoplay (modern browser policy)
- Audio API not supported (rare but possible)
- Settings API unavailable (defaults applied)
- Individual sound play() promise rejection

---

### AC10: Audio files stored in frontend/public/sounds/ directory

**Risk:** Low - directory structure validation

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.5-STATIC-002 | Static | P3 | Verify 4 audio files exist in correct directory | Structure validation |

**Coverage:** ✅ Complete - Static check during implementation
**Files Expected:**
- `frontend/public/sounds/click.mp3`
- `frontend/public/sounds/transition.mp3`
- `frontend/public/sounds/warning-chime.mp3`
- `frontend/public/sounds/grace-notification.mp3`

---

## Test Distribution Summary

### By Test Level

| Level | Count | Percentage | Purpose |
|-------|-------|------------|---------|
| Unit | 11 | 55% | Audio-manager.js function logic |
| Integration | 5 | 25% | Settings API persistence & validation |
| E2E | 7 | 35% | User interactions & critical journeys |
| Static | 2 | 10% | File structure & optimization validation |
| Manual | 1 | 5% | Subjective quality assessment |

**Note:** Percentages exceed 100% due to complementary coverage

### By Priority

| Priority | Count | Rationale |
|----------|-------|-----------|
| **P0** | 5 | Graceful fallback (AC9) + input validation (AC5) |
| **P1** | 12 | Core audio functions, settings, user interactions |
| **P2** | 4 | Performance, optimization, manual validation |
| **P3** | 1 | Directory structure validation |

### Critical Path Focus

**P0 Tests (Must Pass):**
1. `4.5-UNIT-010` - Audio play rejection handling
2. `4.5-UNIT-011` - Audio loading error handling
3. `4.5-INT-003` - Volume validation (0.0-1.0)
4. `4.5-INT-004` - Invalid volume rejection
5. `4.5-INT-005` - Settings fetch failure defaults
6. `4.5-E2E-006` - App works with audio disabled
7. `4.5-E2E-007` - App works with autoplay blocked

**These tests validate AC9 (graceful fallback) which is the critical stability requirement.**

---

## Risk Coverage Matrix

### Identified Risks

| Risk ID | Description | Impact | Probability | Mitigation Tests |
|---------|-------------|--------|-------------|------------------|
| RISK-4.5-001 | Audio files fail to load | High | Medium | 4.5-UNIT-011, 4.5-E2E-007 |
| RISK-4.5-002 | Browser blocks autoplay | High | High | 4.5-UNIT-010, 4.5-E2E-007 |
| RISK-4.5-003 | Invalid volume values cause errors | Medium | Low | 4.5-INT-003, 4.5-INT-004 |
| RISK-4.5-004 | Audio delays page load | High | Low | 4.5-UNIT-009, 4.5-PERF-001 |
| RISK-4.5-005 | Settings API unavailable | Medium | Low | 4.5-INT-005 |
| RISK-4.5-006 | Harsh sounds distress children | High | Low | 4.5-MANUAL-001 |

**Risk Mitigation Status:** ✅ All identified risks have test coverage

---

## Recommended Test Execution Order

### Phase 1: Critical Path (P0) - Fail Fast
1. `4.5-INT-003` - Volume validation
2. `4.5-INT-004` - Invalid volume rejection
3. `4.5-UNIT-010` - Audio play rejection handling
4. `4.5-UNIT-011` - Audio loading error handling
5. `4.5-INT-005` - Settings defaults
6. `4.5-E2E-006` - Audio disabled fallback
7. `4.5-E2E-007` - Autoplay blocked fallback

**Gate Decision:** If any P0 test fails, STOP and fix immediately

---

### Phase 2: Core Functionality (P1)
1. `4.5-UNIT-001` to `4.5-UNIT-008` - All audio-manager.js functions
2. `4.5-INT-001`, `4.5-INT-002` - Settings persistence
3. `4.5-E2E-001` to `4.5-E2E-005` - User interaction flows

---

### Phase 3: Secondary Features (P2)
1. `4.5-UNIT-009` - Preload mechanism
2. `4.5-PERF-001` - Performance benchmark
3. `4.5-STATIC-001` - File size validation
4. `4.5-MANUAL-001` - Sound quality assessment

---

### Phase 4: Validation (P3)
1. `4.5-STATIC-002` - Directory structure check

---

## Test Implementation Guide

### Unit Tests (frontend/src/child/audio-manager.test.js)

**Framework:** Vitest 3.2.4 with happy-dom 19.0.2
**Coverage Target:** 70%+ for UI components
**Test Count:** 11 scenarios

**Key Mocking Requirements:**
- Mock `Audio` constructor and elements
- Mock `fetch` for settings API calls
- Mock `console.warn` and `console.error` for error scenarios

**Example Test Structure:**
```javascript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import {
  playClickSound,
  playWarningChime,
  isAudioEnabled,
  getVolumeFromSettings
} from './audio-manager.js';

describe('audio-manager', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    // Reset module state
  });

  // 4.5-UNIT-010 (P0)
  it('catches audio.play() rejection gracefully', async () => {
    // Arrange: Mock audio.play() to reject
    const mockPlay = vi.fn().mockRejectedValue(new Error('Autoplay blocked'));

    // Act: Call playClickSound()
    await playClickSound();

    // Assert: No error thrown, warning logged
    expect(console.warn).toHaveBeenCalledWith(
      expect.stringContaining('[Audio] Failed to play'),
      expect.any(Error)
    );
  });
});
```

---

### Integration Tests (Extend existing settings tests)

**Framework:** Vitest with fetch mocking
**Test Count:** 5 scenarios
**Focus:** API contract validation, input validation, persistence

**Key Test Areas:**
- Settings API endpoints (GET/POST /admin/settings)
- Volume validation (0.0-1.0 range) - **P0**
- Error responses for invalid inputs - **P0**
- Default values when settings missing

---

### E2E Tests (tests/e2e/specs/audio-feedback.spec.js)

**Framework:** Playwright 1.40.0 (Chromium)
**Test Count:** 7 scenarios
**Focus:** User interactions, browser behavior, graceful fallback

**Key Test Areas:**
- Audio playback on user actions (clicks, navigation)
- Settings UI controls (toggle, slider)
- Browser autoplay policy handling - **P0**
- Application functionality without audio - **P0**

**Example E2E Test:**
```javascript
import { test, expect } from '@playwright/test';

// 4.5-E2E-007 (P0)
test('app functions with autoplay blocked', async ({ context, page }) => {
  // Arrange: Block autoplay
  await context.grantPermissions([], { origin: page.url() });
  await context.addInitScript(() => {
    HTMLMediaElement.prototype.play = () => Promise.reject(new Error('Blocked'));
  });

  await page.goto('/');

  // Act: Click thumbnail (audio will fail, but app should work)
  await page.click('[data-video-id]');

  // Assert: Navigation still works
  await expect(page).toHaveURL(/.*video=.*/);
  // No JavaScript errors
  const errors = await page.evaluate(() => window.errors || []);
  expect(errors).toHaveLength(0);
});
```

---

### Static Validation

**File Size Check:**
```bash
# 4.5-STATIC-001 (P2)
for file in frontend/public/sounds/*.mp3; do
  size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
  if [ $size -gt 102400 ]; then
    echo "FAIL: $file is ${size} bytes (>100KB)"
    exit 1
  fi
done
echo "PASS: All audio files <100KB"
```

**Directory Structure Check:**
```bash
# 4.5-STATIC-002 (P3)
required_files=(
  "frontend/public/sounds/click.mp3"
  "frontend/public/sounds/transition.mp3"
  "frontend/public/sounds/warning-chime.mp3"
  "frontend/public/sounds/grace-notification.mp3"
)
for file in "${required_files[@]}"; do
  [ ! -f "$file" ] && echo "FAIL: $file missing" && exit 1
done
echo "PASS: All audio files present"
```

---

### Manual Validation

**Sound Quality Assessment (4.5-MANUAL-001):**

**Procedure:**
1. Play each sound at 70% volume (default setting)
2. Evaluate against child-appropriateness criteria:
   - ✅ Soft, rounded tones (no harsh/sharp sounds)
   - ✅ Playful, bouncy character (ages 2-6 appropriate)
   - ✅ Warning chime is gentle, not jarring
   - ❌ No scary, aggressive, or startling sounds

**Checklist:**
- [ ] `click.mp3` - Playful pop (0.2s, bouncy)
- [ ] `transition.mp3` - Gentle whoosh (0.3-0.5s, reassuring)
- [ ] `warning-chime.mp3` - Pleasant bell/marimba (0.5-1.0s, NOT jarring)
- [ ] `grace-notification.mp3` - Peaceful chime (gentle notification)

**Tester:** Developer + QA reviewer
**Sign-off Required:** Yes

---

## Coverage Validation

### Acceptance Criteria Coverage Matrix

| AC | Description | Unit | Integration | E2E | Static | Manual | Status |
|----|-------------|------|-------------|-----|--------|--------|--------|
| AC1 | Click sound | ✅ | - | ✅ | - | - | ✅ Complete |
| AC2 | Transition sound | ✅ | - | ✅ | - | - | ✅ Complete |
| AC3 | Warning chime | ✅ | - | ✅ | - | - | ✅ Complete |
| AC4 | Enable/disable | ✅ | ✅ | ✅ | - | - | ✅ Complete |
| AC5 | Volume control | ✅ | ✅ | ✅ | - | - | ✅ Complete |
| AC6 | Load quickly | ✅ | - | - | ✅ | - | ✅ Complete |
| AC7 | File size <100KB | - | - | - | ✅ | - | ✅ Complete |
| AC8 | Child-appropriate | - | - | - | - | ✅ | ✅ Complete |
| AC9 | Graceful fallback | ✅ | ✅ | ✅ | - | - | ✅ Complete |
| AC10 | File location | - | - | - | ✅ | - | ✅ Complete |

**Coverage Status:** ✅ All 10 acceptance criteria have test coverage

### Coverage Gaps Analysis

**No gaps identified.** All acceptance criteria are covered by appropriate test levels.

**Coverage Strengths:**
- AC9 (graceful fallback) has comprehensive P0 coverage across unit, integration, and E2E
- AC5 (volume validation) includes P0 security tests (TIER 1 compliance)
- Multi-level coverage for critical ACs (AC1, AC4, AC5, AC9)

---

## Quality Gate Criteria

### Pass Criteria

✅ **All P0 tests must pass** (5 scenarios - graceful fallback + validation)
✅ **90%+ of P1 tests pass** (11/12 acceptable)
✅ **Static validation passes** (file size <100KB, correct directory)
✅ **Manual validation completed** (sound quality sign-off)
✅ **Coverage target met** (70%+ for audio-manager.js)

### Concerns Criteria

⚠️ **1-2 P1 tests fail** (non-critical features)
⚠️ **P2 tests have failures** (performance degradation)
⚠️ **Coverage 60-69%** (below target but acceptable)

### Fail Criteria

❌ **Any P0 test fails** (critical stability risk)
❌ **>2 P1 tests fail** (core functionality broken)
❌ **Static validation fails** (files >100KB or missing)
❌ **Coverage <60%** (insufficient test coverage)

---

## Test Maintenance Notes

### Test Stability Considerations

- **Audio mocking:** Mock Audio elements properly to avoid flaky tests
- **Timing issues:** Use `await` for async operations, avoid race conditions
- **Browser policies:** E2E tests may behave differently across browsers
- **Settings cache:** Clear module-level cache between tests (beforeEach)

### Future Test Evolution

**When audio features expand:**
- Add tests for new sound types
- Extend volume validation for new ranges
- Add tests for audio playlists (if feature added)

**When browser support changes:**
- Update autoplay policy tests
- Test new Audio API features
- Validate fallback paths for deprecated APIs

---

## Appendix: Test Scenario Quick Reference

### P0 Tests (Critical - 5 scenarios)
- `4.5-UNIT-010` - Audio play rejection handling
- `4.5-UNIT-011` - Audio loading error handling
- `4.5-INT-003` - Volume validation (0.0-1.0)
- `4.5-INT-004` - Invalid volume rejection
- `4.5-INT-005` - Settings fetch failure defaults
- `4.5-E2E-006` - App works with audio disabled
- `4.5-E2E-007` - App works with autoplay blocked

### P1 Tests (Core - 12 scenarios)
- `4.5-UNIT-001` to `4.5-UNIT-008` - Audio-manager.js functions
- `4.5-INT-001`, `4.5-INT-002` - Settings API
- `4.5-E2E-001` to `4.5-E2E-005` - User interactions

### P2 Tests (Secondary - 4 scenarios)
- `4.5-UNIT-009` - Preload mechanism
- `4.5-PERF-001` - Performance benchmark
- `4.5-STATIC-001` - File size validation
- `4.5-MANUAL-001` - Sound quality assessment

### P3 Tests (Nice-to-have - 1 scenario)
- `4.5-STATIC-002` - Directory structure

---

## Test Design Sign-Off

**Test Designer:** Quinn (Test Architect)
**Date:** 2025-11-04
**Review Status:** Ready for implementation
**Next Steps:** Execute P0 tests first, gate decision on results

---

**Document Version:** 1.0
**Last Updated:** 2025-11-04
**Related Documents:**
- Story specification: `docs/stories/4.5.audio-feedback-system.md`
- Test levels framework: `.bmad-core/data/test-levels-framework.md`
- Test priorities matrix: `.bmad-core/data/test-priorities-matrix.md`
