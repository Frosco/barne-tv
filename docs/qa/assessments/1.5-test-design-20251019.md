# Test Design: Story 1.5 - Channel Management

**Date:** 2025-10-19
**Designer:** Quinn (Test Architect)
**Story:** 1.5 Channel Management

## Executive Summary

Story 1.5 implements parent control over YouTube channel/playlist content sources. This is a **security-critical feature** requiring comprehensive TIER 1 safety testing due to:

- Input validation preventing SQL injection and XSS attacks
- Database integrity operations (cascade deletes)
- External API integration with retry/failure handling
- Parent authentication and access control

## Test Strategy Overview

- **Total test scenarios:** 52
- **Unit tests:** 35 (67%)
- **Integration tests:** 15 (29%)
- **E2E tests:** 2 (4%)
- **Priority distribution:** P0: 22 (42%), P1: 24 (46%), P2: 6 (12%)

### Test Level Rationale

Following the test levels framework:
- **Unit tests dominate** (67%) because this story involves significant business logic (URL parsing, retry logic, deduplication) that should be tested in isolation
- **Integration tests** (29%) validate database operations, API endpoint contracts, and cascade behaviors
- **E2E tests** (4%) are minimal, covering only critical user journeys (add/remove channel visible in UI)

### Risk-Based Priority Assignment

**P0 Critical (42%):**
- All TIER 1 safety tests (input validation, SQL injection, XSS prevention)
- Database integrity operations (cascade delete)
- Core functionality (add source, parse input, store data)
- Authentication/authorization checks

**P1 High (46%):**
- YouTube API retry logic and error handling
- Partial fetch scenarios
- User experience flows (real-time updates)
- Norwegian error messaging

**P2 Medium (12%):**
- UI polish (confirmation dialogs)
- Performance optimization validation
- API quota tracking

## Test Scenarios by Acceptance Criteria

### AC1: Admin page displays list of all added channels with thumbnails

| ID           | Level       | Priority | Test                                    | Justification                                      |
| ------------ | ----------- | -------- | --------------------------------------- | -------------------------------------------------- |
| 1.5-INT-001  | Integration | P1       | GET /admin/sources returns all sources  | API contract validation for data retrieval         |
| 1.5-INT-002  | Integration | P1       | Response includes all metadata fields   | Verify camelCase conversion and complete data      |
| 1.5-E2E-001  | E2E         | P1       | Channel list renders with thumbnails    | Critical user journey - visual confirmation of add |

**Coverage:** Complete. API contract + UI rendering verified.

---

### AC2: "Add Channel" form accepts YouTube channel URL or channel ID

| ID           | Level       | Priority | Test                                                     | Justification                                        |
| ------------ | ----------- | -------- | -------------------------------------------------------- | ---------------------------------------------------- |
| 1.5-UNIT-001 | Unit        | P0       | _parse_input() handles full channel URL                  | Core functionality - must support primary input type |
| 1.5-UNIT-002 | Unit        | P0       | _parse_input() handles channel ID (UC...)                | Core functionality - direct ID support               |
| 1.5-UNIT-003 | Unit        | P0       | _parse_input() handles youtube.com/c/ChannelName format  | Core functionality - vanity URL support              |
| 1.5-UNIT-004 | Unit        | P0       | _parse_input() handles full playlist URL                 | Core functionality - playlist support                |
| 1.5-UNIT-005 | Unit        | P0       | _parse_input() handles playlist ID (PL...)               | Core functionality - direct playlist ID              |
| 1.5-UNIT-006 | Unit        | P0       | _parse_input() validates input length (1-200 chars)      | TIER 1 Rule 5 - input validation security            |
| 1.5-UNIT-007 | Unit        | P0       | _parse_input() rejects empty input                       | TIER 1 Rule 5 - prevent invalid data                 |
| 1.5-UNIT-008 | Unit        | P0       | _parse_input() rejects oversized input (>200 chars)      | TIER 1 Rule 5 - buffer overflow prevention           |
| 1.5-UNIT-009 | Unit        | P0       | _parse_input() blocks SQL injection attempts             | TIER 1 Rule 5 - critical security test               |
| 1.5-UNIT-010 | Unit        | P0       | _parse_input() blocks XSS attempts                       | TIER 1 Rule 5 - critical security test               |
| 1.5-UNIT-011 | Unit        | P0       | _parse_input() rejects invalid URL formats               | Data integrity - graceful error handling             |
| 1.5-UNIT-012 | Unit        | P0       | _parse_input() raises ValidationError with Norwegian msg | User experience - localized error messages           |

**Coverage:** Comprehensive. All URL formats + complete TIER 1 input validation.

---

### AC3: System validates channel exists and fetches channel name/thumbnail

| ID           | Level       | Priority | Test                                              | Justification                                   |
| ------------ | ----------- | -------- | ------------------------------------------------- | ----------------------------------------------- |
| 1.5-UNIT-013 | Unit        | P1       | fetch_all_channel_videos() handles 404 not found  | Error handling - non-existent channel           |
| 1.5-UNIT-014 | Unit        | P1       | fetch_all_playlist_videos() handles 404 not found | Error handling - non-existent playlist          |
| 1.5-INT-003  | Integration | P1       | POST with non-existent channel returns error      | End-to-end validation failure handling          |
| 1.5-INT-004  | Integration | P1       | Error response includes Norwegian message         | User experience - localized error communication |

**Coverage:** Complete. Both unit-level error handling + integration verification.

---

### AC4: Channel stored in database with metadata

| ID           | Level       | Priority | Test                                             | Justification                                   |
| ------------ | ----------- | -------- | ------------------------------------------------ | ----------------------------------------------- |
| 1.5-UNIT-015 | Unit        | P0       | insert_content_source() creates record correctly | Database operation - data persistence           |
| 1.5-UNIT-016 | Unit        | P0       | insert_content_source() returns inserted row     | Service contract - return value validation      |
| 1.5-UNIT-017 | Unit        | P0       | bulk_insert_videos() inserts all videos          | Database operation - bulk insert correctness    |
| 1.5-UNIT-018 | Unit        | P0       | All timestamps use UTC (TIER 1 Rule 3)           | TIER 1 Rule 3 - time handling consistency       |
| 1.5-UNIT-019 | Unit        | P0       | All queries use SQL placeholders (TIER 1 Rule 6) | TIER 1 Rule 6 - SQL injection prevention        |
| 1.5-INT-005  | Integration | P0       | POST /admin/sources creates source in database   | Data persistence - full flow verification       |
| 1.5-INT-006  | Integration | P0       | Verify all metadata fields stored correctly      | Data integrity - field mapping validation       |
| 1.5-INT-007  | Integration | P0       | Videos linked to content_source_id correctly     | Foreign key relationship integrity              |

**Coverage:** Complete. Unit tests for DB functions + integration for full flow.

---

### AC5: "Remove" button next to each channel with confirmation dialog

| ID            | Level         | Priority | Test                                     | Justification                              |
| ------------- | ------------- | -------- | ---------------------------------------- | ------------------------------------------ |
| 1.5-UNIT-020  | Unit (Front)  | P2       | Confirmation dialog shown on remove      | UI behavior - prevent accidental deletion  |
| 1.5-UNIT-021  | Unit (Front)  | P2       | DELETE called when user confirms         | UI flow - confirmation acceptance          |
| 1.5-UNIT-022  | Unit (Front)  | P2       | DELETE not called when user cancels      | UI flow - confirmation cancellation        |
| 1.5-UNIT-023  | Unit (Front)  | P2       | Dialog displays channel name & count     | UX - informed decision for parent          |

**Coverage:** Complete frontend unit tests for confirmation flow.

---

### AC6: Removing channel also removes associated cached videos

| ID           | Level       | Priority | Test                                             | Justification                                     |
| ------------ | ----------- | -------- | ------------------------------------------------ | ------------------------------------------------- |
| 1.5-INT-008  | Integration | P0       | DELETE /admin/sources/{id} cascades to videos    | Data integrity - critical cascade operation       |
| 1.5-INT-009  | Integration | P0       | Verify video count before and after deletion     | Data integrity - validation of cascade behavior   |
| 1.5-INT-010  | Integration | P0       | Response includes videos_removed count           | Service contract - accurate reporting             |
| 1.5-UNIT-024 | Unit        | P0       | remove_source() queries video count before drop  | Business logic - reporting preparation            |

**Coverage:** Complete. CASCADE behavior validated at integration level + unit validation of count logic.

---

### AC7: Channel list updates in real-time after add/remove

| ID            | Level         | Priority | Test                                       | Justification                               |
| ------------- | ------------- | -------- | ------------------------------------------ | ------------------------------------------- |
| 1.5-UNIT-025  | Unit (Front)  | P1       | loadChannels() called after successful add | UI consistency - refresh after state change |
| 1.5-UNIT-026  | Unit (Front)  | P1       | loadChannels() called after successful del | UI consistency - refresh after state change |
| 1.5-UNIT-027  | Unit (Front)  | P1       | renderChannelTable() creates correct rows  | UI rendering - DOM manipulation validation  |
| 1.5-E2E-002   | E2E           | P1       | Channel appears after add operation        | User journey - visual confirmation          |

**Coverage:** Complete. Frontend unit tests + E2E for critical user journey.

---

### AC8: Error handling for invalid URLs or non-existent channels

| ID           | Level       | Priority | Test                                                     | Justification                                 |
| ------------ | ----------- | -------- | -------------------------------------------------------- | --------------------------------------------- |
| 1.5-UNIT-028 | Unit        | P0       | _parse_input() raises ValidationError (Norwegian)        | Error handling - localized messages           |
| 1.5-INT-011  | Integration | P1       | POST invalid URL returns 400 with Norwegian message      | API contract - error response format          |
| 1.5-INT-012  | Integration | P1       | POST non-existent channel returns appropriate error code | API contract - distinguish error types        |
| 1.5-UNIT-029 | Unit (Front) | P1       | Frontend displays error message from API response        | UX - error communication to parent            |

**Coverage:** Complete. Covered under AC2 (input validation) + AC3 (validation failure).

---

### AC9: Support for both channel URLs and playlist URLs

| ID           | Level | Priority | Test                                    | Justification               |
| ------------ | ----- | -------- | --------------------------------------- | --------------------------- |
| 1.5-INT-013  | Integration | P0 | POST with channel URL succeeds          | Core functionality - channel support |
| 1.5-INT-014  | Integration | P0 | POST with playlist URL succeeds         | Core functionality - playlist support |
| 1.5-INT-015  | Integration | P0 | Both create correct source_type in DB   | Data integrity - type distinction |

**Coverage:** Complete. Already covered extensively in AC2 unit tests + integration verification here.

---

### AC10: Initial fetch of videos triggered immediately after adding channel

| ID           | Level       | Priority | Test                                                   | Justification                                 |
| ------------ | ----------- | -------- | ------------------------------------------------------ | --------------------------------------------- |
| 1.5-UNIT-030 | Unit        | P1       | fetch_videos_with_retry() succeeds on first attempt    | Retry logic - happy path                      |
| 1.5-UNIT-031 | Unit        | P1       | fetch_videos_with_retry() succeeds after network error | Retry logic - resilience validation           |
| 1.5-UNIT-032 | Unit        | P1       | fetch_videos_with_retry() fails after 3 retries        | Retry logic - failure threshold               |
| 1.5-UNIT-033 | Unit        | P1       | fetch_videos_with_retry() fails immediately on 403     | Retry logic - quota exhaustion handling       |
| 1.5-UNIT-034 | Unit        | P1       | fetch_videos_with_retry() fails immediately on 404     | Retry logic - not found immediate response    |
| 1.5-UNIT-035 | Unit        | P2       | Exponential backoff timing (0s, 1s, 2s)                | Retry logic - backoff strategy validation     |
| 1.5-UNIT-036 | Unit        | P1       | _deduplicate_videos() removes duplicate IDs            | Data quality - prevent duplicate storage      |
| 1.5-UNIT-037 | Unit        | P2       | _deduplicate_videos() preserves first occurrence order | Data quality - consistent ordering            |
| 1.5-UNIT-038 | Unit        | P1       | Partial fetch sets fetch_complete=False                | State management - partial completion flag    |
| 1.5-UNIT-039 | Unit        | P1       | Complete fetch sets fetch_complete=True                | State management - success flag               |
| 1.5-UNIT-040 | Unit        | P1       | _fetch_video_details() parses duration with isodate    | Data transformation - duration parsing        |
| 1.5-UNIT-041 | Unit        | P1       | _fetch_video_details() extracts all metadata fields    | Data transformation - completeness            |

**Coverage:** Comprehensive unit tests for retry logic, deduplication, and video fetching.

---

## Additional Critical Scenarios

### Duplicate Source Prevention

| ID           | Level       | Priority | Test                                              | Justification                          |
| ------------ | ----------- | -------- | ------------------------------------------------- | -------------------------------------- |
| 1.5-UNIT-042 | Unit        | P0       | add_source() detects duplicate source_id          | Data integrity - prevent duplicates    |
| 1.5-UNIT-043 | Unit        | P0       | Duplicate raises ValidationError (Norwegian)      | Error handling - localized message     |
| 1.5-INT-016  | Integration | P0       | POST duplicate source returns 409 Conflict        | API contract - correct HTTP status     |

---

### Authentication & Authorization

| ID           | Level       | Priority | Test                                            | Justification                       |
| ------------ | ----------- | -------- | ----------------------------------------------- | ----------------------------------- |
| 1.5-INT-017  | Integration | P0       | GET /admin/sources requires authentication      | Security - access control           |
| 1.5-INT-018  | Integration | P0       | POST /admin/sources requires authentication     | Security - access control           |
| 1.5-INT-019  | Integration | P0       | DELETE /admin/sources/{id} requires auth        | Security - access control           |

---

### API Quota & Logging

| ID           | Level       | Priority | Test                                     | Justification                         |
| ------------ | ----------- | -------- | ---------------------------------------- | ------------------------------------- |
| 1.5-UNIT-044 | Unit        | P2       | log_api_call() records operation & cost  | Monitoring - quota tracking           |
| 1.5-INT-020  | Integration | P2       | API call logged after add_source()       | Monitoring - audit trail              |

---

### Frontend XSS Prevention

| ID           | Level       | Priority | Test                                             | Justification                           |
| ------------ | ----------- | -------- | ------------------------------------------------ | --------------------------------------- |
| 1.5-UNIT-045 | Unit (Front) | P0       | renderChannelTable() uses textContent not innerHTML | TIER 1 security - XSS prevention     |
| 1.5-UNIT-046 | Unit (Front) | P0       | Channel name with HTML entities displays safely  | TIER 1 security - XSS prevention     |

---

## Test Execution Strategy

### Execution Order (Fail Fast)

1. **P0 Unit Tests** (22 tests) - Run first, fail immediately on critical issues
   - Input validation (SQL injection, XSS)
   - Database operation correctness
   - Duplicate detection
   - UTC time and SQL placeholder usage

2. **P0 Integration Tests** (8 tests) - Validate critical flows
   - Authentication checks
   - Database cascade operations
   - Full add/remove flows

3. **P1 Unit Tests** (17 tests) - Core logic validation
   - Retry mechanisms
   - Error handling
   - Deduplication
   - Video fetching

4. **P1 Integration Tests** (7 tests) - API contracts
   - Error responses
   - Partial fetch handling
   - Norwegian messaging

5. **P1 E2E Tests** (2 tests) - User journeys
   - Add channel visible in UI
   - Remove channel disappears from UI

6. **P2 Tests** (6 tests) - Polish and performance
   - Confirmation dialogs
   - Quota logging
   - Performance optimization

### CI/CD Gates

- **Pre-commit:** P0 unit tests must pass (< 5 seconds)
- **PR validation:** All P0 + P1 tests must pass
- **Pre-deployment:** Full test suite including P2

### Coverage Targets

| Component               | Unit Coverage | Integration Coverage | Notes                          |
| ----------------------- | ------------- | -------------------- | ------------------------------ |
| content_source.py       | >90%          | N/A                  | TIER 1 critical - full coverage|
| db/queries.py (sources) | >90%          | N/A                  | Data integrity critical        |
| routes.py (admin)       | >80%          | >80%                 | API contract critical          |
| admin/channels.js       | >70%          | N/A                  | Frontend standard              |

---

## Risk Coverage Matrix

| Risk ID | Risk Description                     | Probability | Impact | Priority | Test Coverage                              |
| ------- | ------------------------------------ | ----------- | ------ | -------- | ------------------------------------------ |
| RISK-01 | SQL injection via channel input      | Medium      | High   | P0       | 1.5-UNIT-009                               |
| RISK-02 | XSS via malicious channel name       | Medium      | High   | P0       | 1.5-UNIT-010, 1.5-UNIT-045, 1.5-UNIT-046   |
| RISK-03 | Cascade delete fails (orphan videos) | Low         | High   | P0       | 1.5-INT-008, 1.5-INT-009                   |
| RISK-04 | Duplicate channels added             | Medium      | Medium | P0       | 1.5-UNIT-042, 1.5-UNIT-043, 1.5-INT-016    |
| RISK-05 | Partial fetch loses data             | Medium      | Medium | P1       | 1.5-UNIT-038, 1.5-UNIT-032                 |
| RISK-06 | YouTube API quota exhaustion         | High        | Medium | P1       | 1.5-UNIT-033                               |
| RISK-07 | Network failures during fetch        | High        | Low    | P1       | 1.5-UNIT-031, 1.5-UNIT-032                 |
| RISK-08 | Invalid URL crashes system           | Low         | Medium | P0       | 1.5-UNIT-006 to 1.5-UNIT-012               |
| RISK-09 | Non-authenticated access to admin    | Low         | High   | P0       | 1.5-INT-017, 1.5-INT-018, 1.5-INT-019      |

---

## Coverage Validation

### Acceptance Criteria Coverage

| AC  | Description                    | Unit Tests | Integration Tests | E2E Tests | Status   |
| --- | ------------------------------ | ---------- | ----------------- | --------- | -------- |
| 1   | Display channel list           | 0          | 2                 | 1         | Complete |
| 2   | Add channel form accepts input | 12         | 0                 | 0         | Complete |
| 3   | Validate channel exists        | 2          | 2                 | 0         | Complete |
| 4   | Store in database              | 5          | 3                 | 0         | Complete |
| 5   | Remove with confirmation       | 4          | 0                 | 0         | Complete |
| 6   | Cascade delete videos          | 1          | 3                 | 0         | Complete |
| 7   | Real-time UI updates           | 3          | 0                 | 1         | Complete |
| 8   | Error handling                 | 2          | 2                 | 0         | Complete |
| 9   | Support channels & playlists   | 0          | 3                 | 0         | Complete |
| 10  | Initial video fetch            | 12         | 0                 | 0         | Complete |

**Coverage Gaps:** None identified. All ACs have comprehensive test coverage.

### TIER 1 Safety Coverage

All TIER 1 safety rules validated:

- **Rule 3 (UTC Time):** 1.5-UNIT-018
- **Rule 5 (Input Validation):** 1.5-UNIT-006 through 1.5-UNIT-012
- **Rule 6 (SQL Placeholders):** 1.5-UNIT-019

### Duplicate Coverage Analysis

**Intentional overlaps (defense in depth):**
- Input validation tested at both unit (_parse_input) and integration (POST endpoint) levels
  - **Justification:** Critical security boundary - TIER 1 requirement
- Cascade delete tested at unit (DB query) and integration (full flow) levels
  - **Justification:** Data integrity critical - must verify at multiple layers

**No redundant coverage identified** - each test validates a distinct aspect or layer.

---

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (shift-left: 67% unit)
- [x] No duplicate coverage across levels (only intentional defense-in-depth)
- [x] Priorities align with business risk (42% P0 for security/integrity)
- [x] Test IDs follow naming convention (1.5-{LEVEL}-{SEQ})
- [x] Scenarios are atomic and independent
- [x] TIER 1 safety rules fully covered
- [x] Risk mitigation mapped to tests

---

## Implementation Notes

### Test File Organization

**Backend Unit Tests:**
- `tests/backend/services/test_content_source.py` - All content_source.py unit tests (UNIT-001 to UNIT-044)
- `tests/backend/db/test_queries_sources.py` - Database query unit tests (UNIT-015 to UNIT-019)
- `tests/backend/safety/test_tier1_safety_rules.py` - TIER 1 safety tests (UNIT-009, UNIT-010, UNIT-018, UNIT-019)

**Backend Integration Tests:**
- `tests/integration/test_admin_sources_api.py` - All admin sources endpoint tests (INT-001 to INT-020)

**Frontend Unit Tests:**
- `frontend/src/admin/channels.test.js` - All frontend unit tests (UNIT-020 to UNIT-029, UNIT-045, UNIT-046)

**E2E Tests:**
- `tests/e2e/test_channel_management.spec.js` - User journey tests (E2E-001, E2E-002)

### Mock Requirements

**YouTube API Mocking:**
- Mock `youtube.channels().list()` responses
- Mock `youtube.playlistItems().list()` responses
- Mock `youtube.videos().list()` responses
- Mock network errors for retry testing
- Mock 403/404 responses for error handling

**Database Mocking:**
- Use in-memory SQLite for integration tests (via conftest.py fixtures)
- No mocking for unit tests of DB functions (test against actual in-memory DB)

### Test Data Requirements

**Valid Test Inputs:**
- Channel URL: `https://www.youtube.com/channel/UCtest123`
- Channel ID: `UCtest123`
- Playlist URL: `https://www.youtube.com/playlist?list=PLtest456`
- Playlist ID: `PLtest456`

**Invalid Test Inputs (Security):**
- SQL injection: `UC123'; DROP TABLE videos; --`
- XSS: `UC<script>alert('xss')</script>`
- Oversized: 201 character string
- Empty: `""`
- Malformed: `not-a-valid-url`

---

## Appendix: Gate YAML Block

```yaml
test_design:
  date: 2025-10-19
  scenarios_total: 52
  by_level:
    unit: 35
    integration: 15
    e2e: 2
  by_priority:
    p0: 22
    p1: 24
    p2: 6
  coverage_gaps: []
  tier1_safety_coverage: complete
  risk_coverage:
    - RISK-01: SQL injection prevention (covered)
    - RISK-02: XSS prevention (covered)
    - RISK-03: Cascade delete integrity (covered)
    - RISK-04: Duplicate prevention (covered)
    - RISK-05: Partial fetch handling (covered)
    - RISK-06: Quota exhaustion (covered)
    - RISK-07: Network resilience (covered)
    - RISK-08: Invalid input handling (covered)
    - RISK-09: Authentication required (covered)
```

---

## Trace References

**For use by trace-requirements task:**

- Test design matrix: `docs/qa/assessments/1.5-test-design-20251019.md`
- P0 tests identified: 22
- TIER 1 safety tests: 4 (UNIT-009, UNIT-010, UNIT-018, UNIT-019)
- Total unique test scenarios: 52
- Risk coverage: 9 risks identified and mitigated

---

## Conclusion

This test design provides comprehensive coverage of Story 1.5 with a strong focus on security (TIER 1 compliance) and data integrity. The 67% unit test ratio ensures fast feedback and maintainability, while strategic integration and E2E tests validate critical user journeys and system boundaries.

All 10 acceptance criteria are fully covered with no identified gaps. The risk-based prioritization ensures critical security and data integrity tests (P0) are executed first, enabling fail-fast development practices.

**Recommended Next Steps:**
1. Implement P0 unit tests first (SQL injection, XSS, input validation)
2. Implement P0 integration tests (authentication, cascade deletes)
3. Implement P1 tests (retry logic, error handling)
4. Implement P2 tests (UI polish, performance)
5. Run `*trace 1.5` to map requirements to implemented tests
