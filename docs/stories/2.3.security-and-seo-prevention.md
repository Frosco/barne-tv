# Story 2.3: Security and SEO Prevention

## Status
Draft

## Story
**As a** parent,
**I want** the application to prevent search engine indexing and unauthorized access,
**so that** the application remains private and safe.

## Acceptance Criteria

1. robots.txt file created blocking all crawlers (User-agent: *, Disallow: /)
   - File location: `/opt/youtube-viewer/static/robots.txt`
   - Served by Nginx at `/robots.txt` endpoint
2. Meta tags added to all pages (noindex, nofollow, noarchive)
3. X-Robots-Tag HTTP header added to all responses (noindex, nofollow)
4. Google-specific meta tags to prevent indexing (googlebot: noindex)
5. No external analytics or tracking scripts included
6. Content Security Policy (CSP) header configured to restrict external resources:
   - `default-src 'self'`
   - `script-src 'self' https://www.youtube.com https://s.ytimg.com`
   - `style-src 'self' 'unsafe-inline'` (required for dynamic child UI styling)
   - `img-src 'self' https://i.ytimg.com data:`
   - `frame-src https://www.youtube.com` (YouTube IFrame Player)
   - `media-src 'self' https://www.youtube.com`
   - `connect-src 'self'`
   - `font-src 'self'`
   - `object-src 'none'`
   - `base-uri 'self'`
   - `form-action 'self'`
   - `frame-ancestors 'self'`
   - **Development Note:** CSP relaxed for Vite dev server (allows 'unsafe-eval' and WebSocket connections)
7. Child interface has no external links or navigation away from application
8. YouTube player API only loads necessary components
9. HTTPS enforced in production (HTTP redirects to HTTPS):
   - Let's Encrypt certificates via Certbot
   - TLS 1.2 and TLS 1.3 protocols only (no older versions)
   - Strong cipher suites: ECDHE-ECDSA-AES128-GCM-SHA256, ECDHE-RSA-AES128-GCM-SHA256, ECDHE-ECDSA-AES256-GCM-SHA384, ECDHE-RSA-AES256-GCM-SHA384
   - Automatic certificate renewal via systemd timer
10. Admin interface behind authentication (verify existing protection - no changes needed)
11. X-Frame-Options header set to SAMEORIGIN (prevents clickjacking attacks)
12. X-Content-Type-Options header set to nosniff (prevents MIME type sniffing)
13. X-XSS-Protection header set to "1; mode=block" (legacy browser XSS protection)
14. Strict-Transport-Security (HSTS) header configured:
    - max-age=31536000 (1 year)
    - includeSubDomains flag enabled
15. Referrer-Policy header set to strict-origin-when-cross-origin
16. Permissions-Policy header disables unnecessary browser features:
    - geolocation=()
    - microphone=()
    - camera=()
    - payment=()
    - usb=()
    - magnetometer=()
    - gyroscope=()
    - accelerometer=()
17. FastAPI TrustedHostMiddleware configured with ALLOWED_HOSTS from environment variable
18. FastAPI security headers middleware as defense-in-depth (redundant with Nginx but provides protection if Nginx bypassed)

## Tasks / Subtasks

- [ ] **Task 1: Create robots.txt file** (AC: 1)
  - [ ] Create file at `static/robots.txt` with content:
    ```
    User-agent: *
    Disallow: /
    ```
  - [ ] Verify file permissions (644)
  - [ ] Test robots.txt is served at `/robots.txt` endpoint
  - [ ] [Source: architecture/security-implementation.md#seo-and-crawler-prevention]

- [ ] **Task 2: Add security meta tags to base template** (AC: 2, 4)
  - [ ] Update `frontend/templates/base.html` `<head>` section
  - [ ] Add meta tag: `<meta name="robots" content="noindex, nofollow, noarchive">`
  - [ ] Add meta tag: `<meta name="googlebot" content="noindex, nofollow">`
  - [ ] Verify all pages inherit from base.html
  - [ ] [Source: architecture/security-implementation.md#seo-and-crawler-prevention]

- [ ] **Task 3: Configure Nginx security headers (production configuration)** (AC: 3, 6, 11, 12, 13, 14, 15, 16)
  - [ ] Document Nginx configuration changes in `docs/architecture/security-implementation.md`
  - [ ] Add X-Robots-Tag header: `add_header X-Robots-Tag "noindex, nofollow" always;`
  - [ ] Add X-Frame-Options header: `add_header X-Frame-Options "SAMEORIGIN" always;`
  - [ ] Add X-Content-Type-Options header: `add_header X-Content-Type-Options "nosniff" always;`
  - [ ] Add X-XSS-Protection header: `add_header X-XSS-Protection "1; mode=block" always;`
  - [ ] Add HSTS header: `add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;`
  - [ ] Add Referrer-Policy header: `add_header Referrer-Policy "strict-origin-when-cross-origin" always;`
  - [ ] Add Permissions-Policy header with disabled features (see AC 16 for exact values)
  - [ ] Configure CSP header with YouTube allowances (see Dev Notes for complete directive)
  - [ ] Add configuration note about development CSP relaxation for Vite
  - [ ] [Source: architecture/security-implementation.md#security-headers]

- [ ] **Task 4: Document HTTPS/TLS configuration for Epic 5 deployment** (AC: 9)
  - [ ] Document Let's Encrypt / Certbot setup in infrastructure docs
  - [ ] Document HTTP to HTTPS redirect configuration
  - [ ] Document TLS protocol versions (1.2, 1.3 only)
  - [ ] Document cipher suite configuration
  - [ ] Document automatic certificate renewal via systemd timer
  - [ ] Note: HTTPS configuration is Nginx-only, no FastAPI changes needed
  - [ ] Note: This task ONLY documents configuration for future deployment (Epic 5) - no Nginx changes in this story
  - [ ] [Source: architecture/security-implementation.md#https-tls-configuration]

- [ ] **Task 5: Add FastAPI security middleware (defense-in-depth)** (AC: 17, 18)
  - [ ] Update `backend/main.py` to add TrustedHostMiddleware
  - [ ] Configure allowed hosts from `ALLOWED_HOSTS` environment variable
  - [ ] Load ALLOWED_HOSTS from `backend/config.py`
  - [ ] Add custom security headers middleware for defense-in-depth:
    - [ ] X-Content-Type-Options: nosniff
    - [ ] X-Frame-Options: SAMEORIGIN
    - [ ] X-XSS-Protection: 1; mode=block
  - [ ] Document that CSP is Nginx-only (too complex for middleware)
  - [ ] Document that this is redundant with Nginx but provides protection if Nginx bypassed
  - [ ] [Source: architecture/security-implementation.md#fastapi-security-middleware]

- [ ] **Task 6: Write security header verification tests** (AC: All)
  - [ ] Create `tests/backend/security/test_security_headers.py`
  - [ ] Test robots.txt content is correct
  - [ ] Test robots.txt served at `/robots.txt` endpoint
  - [ ] Test child interface endpoints return security headers:
    - [ ] X-Content-Type-Options
    - [ ] X-Frame-Options
    - [ ] X-XSS-Protection
  - [ ] Test admin interface requires authentication (existing test)
  - [ ] Test TrustedHostMiddleware rejects invalid hosts
  - [ ] Test ALLOWED_HOSTS environment variable is loaded
  - [ ] Mock requests to verify headers are added by middleware
  - [ ] [Source: architecture/test-strategy-and-standards.md#security-test-suite]

- [ ] **Task 7: Document meta tag and external link audit** (AC: 5, 7, 8)
  - [ ] Audit base.html and child templates for external links (should be none)
  - [ ] Audit for analytics scripts (should be none)
  - [ ] Verify YouTube IFrame Player API loading is minimal (only necessary components)
  - [ ] Document findings in story completion notes
  - [ ] No code changes needed if audit passes
  - [ ] [Source: architecture/security-implementation.md#seo-and-crawler-prevention]

- [ ] **Task 8: Run quality checks and verify compliance** (AC: All)
  - [ ] Run backend tests: `uv run pytest tests/backend/ -v`
  - [ ] Run security tests: `uv run pytest tests/backend/security/ -v`
  - [ ] Check backend coverage: `uv run pytest --cov=backend --cov-report=html`
  - [ ] Verify security-related code coverage ≥85%
  - [ ] Run black formatter: `uv run black .`
  - [ ] Run ruff linter: `uv run ruff check .`
  - [ ] Verify no linting errors
  - [ ] [Source: architecture/coding-standards.md#quality-checks]

## Dev Notes

### Previous Story Insights

**From Story 2.2 (Video Playback):**
- All backend operations synchronous (no async/await per architecture)
- Norwegian user messages for any error scenarios
- Rate limiting already configured on endpoints (100/min child, 10/min admin)
- FastAPI middleware pattern established
- Testing pattern: pytest with FastAPI TestClient, fixtures in conftest.py
- Frontend uses progressive enhancement: HTML structure first, JS adds interactivity
- Security headers will complement existing authentication and rate limiting

**From Story 2.1 (Child Video Grid):**
- Base template structure in `frontend/templates/base.html`
- Child interface has no navigation elements or external links (already compliant)
- Templates use Jinja2 3.1.6
- Static files served from `static/` directory via Nginx

### Security Implementation Strategy

[Source: architecture/security-implementation.md]

**Two-Layer Security Approach:**

1. **Primary Layer (Nginx):** Production security headers, CSP, HTTPS termination
   - Nginx 1.24.0 handles SSL/TLS, static files, reverse proxy
   - Security headers configured in Nginx server block
   - CSP configured in Nginx (too complex for FastAPI middleware)
   - HTTPS enforcement via redirect (HTTP 80 → HTTPS 443)

2. **Defense-in-Depth Layer (FastAPI):** Redundant headers, host validation
   - FastAPI middleware adds subset of security headers
   - TrustedHostMiddleware validates Host header
   - Provides protection if Nginx is bypassed or misconfigured
   - Simpler headers only (X-Frame-Options, X-Content-Type-Options, X-XSS-Protection)

**Implementation Note:** Security headers are primarily configured in Nginx (production reverse proxy), with FastAPI middleware providing defense-in-depth.

### Security Header Specifications

[Source: architecture/security-implementation.md#security-headers]

**All Security Headers (Nginx Configuration):**

```nginx
# /etc/nginx/sites-available/youtube-viewer
# Add to server block for HTTPS

# Prevent clickjacking
add_header X-Frame-Options "SAMEORIGIN" always;

# Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# Enable XSS protection (legacy browsers)
add_header X-XSS-Protection "1; mode=block" always;

# Content Security Policy (CSP) - Production
# NOTE: In development with Vite dev server, CSP may need to be relaxed
add_header Content-Security-Policy "
    default-src 'self';
    script-src 'self' https://www.youtube.com https://s.ytimg.com;
    style-src 'self' 'unsafe-inline';
    img-src 'self' https://i.ytimg.com data:;
    frame-src https://www.youtube.com;
    media-src 'self' https://www.youtube.com;
    connect-src 'self';
    font-src 'self';
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'self';
" always;

# Referrer Policy
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions Policy (formerly Feature Policy)
add_header Permissions-Policy "
    geolocation=(),
    microphone=(),
    camera=(),
    payment=(),
    usb=(),
    magnetometer=(),
    gyroscope=(),
    accelerometer=()
" always;

# Prevent search engine indexing (privacy + child safety)
add_header X-Robots-Tag "noindex, nofollow" always;
```

**HSTS Header (Nginx):**
```nginx
# In HTTPS server block
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
```

**Development CSP Note:**

For Vite dev server (NOT for production), CSP may need to be relaxed:
```nginx
# Development location block (NOT for production)
location /dev {
    # More permissive CSP for Vite HMR
    add_header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-eval';  # Vite needs eval
        style-src 'self' 'unsafe-inline';
        connect-src 'self' ws: wss:;      # WebSocket for HMR
    " always;

    proxy_pass http://127.0.0.1:5173;  # Vite dev server
}
```

**CSP Rationale:**
- `'unsafe-inline'` in style-src: Required for dynamic child UI styling (changing colors based on state)
- `https://www.youtube.com` in script-src: YouTube IFrame Player API
- `https://s.ytimg.com` in script-src: YouTube player scripts
- `https://i.ytimg.com` in img-src: YouTube video thumbnails
- `https://www.youtube.com` in frame-src: YouTube IFrame Player embed
- `data:` in img-src: Allows data URIs for mascot images if needed

### FastAPI Security Middleware

[Source: architecture/security-implementation.md#fastapi-security-middleware]

**TrustedHostMiddleware Configuration:**

```python
# backend/main.py
from fastapi.middleware.trustedhost import TrustedHostMiddleware
from backend.config import ALLOWED_HOSTS

app = FastAPI()

# Trusted host protection (environment-specific)
app.add_middleware(
    TrustedHostMiddleware,
    allowed_hosts=ALLOWED_HOSTS  # From environment variable
)

# NOTE: CORS middleware not needed for this monolith architecture
# Frontend is served from same domain via Nginx, no cross-origin requests
```

**Custom Security Headers Middleware:**

```python
# backend/main.py

# Custom security headers middleware (redundant with Nginx but defense in depth)
@app.middleware("http")
async def add_security_headers(request: Request, call_next):
    response = await call_next(request)
    response.headers["X-Content-Type-Options"] = "nosniff"
    response.headers["X-Frame-Options"] = "SAMEORIGIN"
    response.headers["X-XSS-Protection"] = "1; mode=block"
    return response
```

**Why Not All Headers in FastAPI:**
- CSP is complex and best managed in Nginx configuration
- HSTS should only be set by HTTPS termination point (Nginx)
- Permissions-Policy is complex and best in Nginx
- Referrer-Policy can be Nginx-only
- X-Robots-Tag can be Nginx-only

**FastAPI provides:** Basic headers (X-Frame-Options, X-Content-Type-Options, X-XSS-Protection) and host validation

### Environment Configuration

[Source: architecture/security-implementation.md#environment-variable-security, architecture/tech-stack.md]

**Environment Variables:**

```python
# backend/config.py
import os
import logging

logger = logging.getLogger(__name__)

# Load critical environment variables
YOUTUBE_API_KEY = os.getenv('YOUTUBE_API_KEY')
DATABASE_PATH = os.getenv('DATABASE_PATH', '/opt/youtube-viewer/data/app.db')
ALLOWED_HOSTS = os.getenv('ALLOWED_HOSTS', 'localhost,127.0.0.1').split(',')

# Validate required variables
if not YOUTUBE_API_KEY:
    raise ValueError("YOUTUBE_API_KEY environment variable must be set")

# Log configuration (NEVER log the full API key)
logger.info(f"YouTube API initialized with key: {YOUTUBE_API_KEY[:8]}...")
logger.info(f"Database path: {DATABASE_PATH}")
logger.info(f"Allowed hosts: {ALLOWED_HOSTS}")
```

**Environment File (.env):**
```bash
# /opt/youtube-viewer/.env
# Permissions: 600 (read/write for owner only)

YOUTUBE_API_KEY=AIzaSyD...  # Full key here
DATABASE_PATH=/opt/youtube-viewer/data/app.db
ALLOWED_HOSTS=youtube-viewer.yourdomain.com

# Development environment (.env.local)
YOUTUBE_API_KEY=AIzaSyD...
DATABASE_PATH=./data/test.db
ALLOWED_HOSTS=localhost,127.0.0.1
```

### SEO and Crawler Prevention

[Source: architecture/security-implementation.md#seo-and-crawler-prevention]

**robots.txt File:**

```text
# /opt/youtube-viewer/static/robots.txt
User-agent: *
Disallow: /
```

**Nginx Configuration to Serve robots.txt:**

```nginx
# /etc/nginx/sites-available/youtube-viewer
location /robots.txt {
    alias /opt/youtube-viewer/static/robots.txt;
}
```

**Meta Tags in HTML Templates:**

```html
<!-- frontend/templates/base.html -->
<!DOCTYPE html>
<html lang="no">
<head>
    <meta name="robots" content="noindex, nofollow, noarchive">
    <meta name="googlebot" content="noindex, nofollow">
    <!-- rest of head -->
</head>
```

**Rationale:** Application should not be indexed by search engines for privacy and child safety reasons. This is a private family application, not a public service.

### File Locations

[Source: architecture/security-implementation.md, docs/stories/2.1.child-friendly-video-grid.md]

**Backend:**
- Middleware: `backend/main.py` (add TrustedHostMiddleware and security headers middleware)
- Config: `backend/config.py` (already exists, add ALLOWED_HOSTS import)

**Frontend:**
- Base template: `frontend/templates/base.html` (add meta tags)
- robots.txt: `static/robots.txt` (new file)

**Infrastructure:**
- Nginx config: `/etc/nginx/sites-available/youtube-viewer` (document changes, not modified in story)
- HTTPS config: Let's Encrypt via Certbot (document only, not modified in story)

**Tests:**
- Security tests: `tests/backend/security/test_security_headers.py` (new file)

### Testing Requirements

[Source: architecture/test-strategy-and-standards.md]

**Test Coverage Goals:**
- Overall Target: 85% code coverage
- Security-Related Code: 100% coverage required (middleware, config validation)

**Security Test Suite:**

```bash
# Run all security tests
uv run pytest tests/backend/security/ -v

# Run with coverage
uv run pytest tests/backend/ --cov=backend --cov-report=html
```

**Security Tests Verify:**
- robots.txt content is correct
- robots.txt served at `/robots.txt` endpoint
- Security headers present in responses (X-Frame-Options, X-Content-Type-Options, X-XSS-Protection)
- TrustedHostMiddleware validates Host header correctly
- ALLOWED_HOSTS environment variable loaded correctly
- Invalid hosts rejected with 400 error

**Test Structure:**

```python
# tests/backend/security/test_security_headers.py
"""
Security Header Verification Tests

Verify that security headers are correctly added to all responses
and that security configurations are properly enforced.
"""

import pytest
from fastapi.testclient import TestClient
from backend.main import app

def test_robots_txt_content(client):
    """Test robots.txt returns correct content."""
    response = client.get('/robots.txt')
    assert response.status_code == 200
    assert 'User-agent: *' in response.text
    assert 'Disallow: /' in response.text

def test_security_headers_present(client):
    """Test security headers are present in response."""
    response = client.get('/health')
    assert response.headers['X-Content-Type-Options'] == 'nosniff'
    assert response.headers['X-Frame-Options'] == 'SAMEORIGIN'
    assert response.headers['X-XSS-Protection'] == '1; mode=block'

def test_trusted_host_middleware_rejects_invalid_host(client):
    """Test TrustedHostMiddleware rejects requests with invalid Host header."""
    response = client.get('/health', headers={'Host': 'evil.com'})
    assert response.status_code == 400
```

### Technical Constraints

[Source: architecture/coding-standards.md]

**TIER 1 Safety Rules (Apply to Security Implementation):**
- **Input Validation:** ALLOWED_HOSTS must be validated (ensure valid domains, no injection)
- **SQL Placeholders:** Not applicable (no database queries in this story)
- **UTC Time:** Not applicable (no time operations in this story)

**TIER 2 Functionality Rules:**
- **Environment Variables via Config Module:** ALWAYS import ALLOWED_HOSTS from `backend.config`, never `os.getenv()` directly
- **Error Handling:** TrustedHostMiddleware failures should return 400 errors
- **API Response Format:** Not applicable (no API endpoints added)

**TIER 3 Code Quality Rules:**
- **All Backend Operations Synchronous:** Middleware uses `async def` (FastAPI requirement), but no async database operations
- **Norwegian User Messages:** Not applicable (security headers are HTTP headers, not user-facing)
- **Type Hints:** Use type hints for middleware functions

**Middleware Signature:**

```python
@app.middleware("http")
async def add_security_headers(request: Request, call_next):
    response = await call_next(request)
    # ... add headers
    return response
```

Note: FastAPI middleware MUST be async even though the application is all-synchronous. This is a FastAPI framework requirement, not a violation of the synchronous architecture rule.

### HTTPS and TLS Configuration (Documentation Only)

[Source: architecture/security-implementation.md#https-tls-configuration]

**This story documents but does NOT implement HTTPS/TLS configuration.** Nginx and Let's Encrypt setup is infrastructure deployment (Epic 5), not application code.

**Document the Following:**

1. **Let's Encrypt Certificate Installation:**
   ```bash
   # Certbot installation and setup
   sudo apt install certbot python3-certbot-nginx
   sudo certbot --nginx -d youtube-viewer.yourdomain.com
   ```

2. **Automatic Certificate Renewal:**
   - systemd timer enabled by certbot
   - Certificates auto-renew 30 days before expiry
   - Renewal command: `sudo certbot renew --dry-run` (test)

3. **TLS Configuration:**
   - Protocols: TLS 1.2 and TLS 1.3 only
   - Cipher suites: Strong ECDHE suites (see AC 9 for list)
   - Nginx configuration: `ssl_protocols TLSv1.2 TLSv1.3;`

4. **HTTP to HTTPS Redirect:**
   ```nginx
   server {
       listen 80;
       server_name youtube-viewer.yourdomain.com;
       return 301 https://$server_name$request_uri;
   }
   ```

**What This Story Delivers:** Documentation in `docs/architecture/infrastructure-and-deployment.md` about HTTPS configuration. No code changes in this story.

### External Links and Analytics Audit

[Source: Epic 2 Story 2.3 AC 5, 7, 8]

**Audit Scope:**
- Verify base.html has no external links
- Verify child templates have no navigation away from app
- Verify no analytics scripts (Google Analytics, etc.)
- Verify YouTube IFrame Player API loads minimal components

**Expected Results (No Changes Needed):**
- Child interface already has no navigation elements (Story 2.1)
- Base template does not include analytics scripts
- YouTube IFrame Player configuration already minimal (Story 2.2)

**If Audit Finds Issues:**
- Remove any external links from child interface
- Remove any analytics scripts
- Simplify YouTube player configuration

### Responsive Design Requirements

Not applicable for this story. Security headers and meta tags have no responsive design requirements.

### Project Structure Notes

**Note:** All middleware stays in single `backend/main.py` file per architecture. Do NOT create separate middleware modules.

**Note:** Nginx configuration changes are documented in this story but implemented during deployment (Epic 5).

### Norwegian User Messages

Not applicable for this story. Security headers are HTTP headers, not user-facing messages.

## Testing

[Source: architecture/test-strategy-and-standards.md#security-test-suite]

**Test Coverage:**
- Security middleware: 100% (safety-critical)
- Configuration loading: 100% (safety-critical)
- robots.txt serving: 100% (simple file serving)
- UI components: N/A (no UI in this story)

**Test Markers:**
```python
@pytest.mark.security  # For security-specific tests
```

**Running Tests:**
```bash
# Backend - all tests
uv run pytest tests/backend/ -v

# Backend - security tests only
uv run pytest tests/backend/security/ -v

# With coverage
uv run pytest tests/backend/ --cov=backend --cov-report=html
```

**Testing Frameworks:**
- Backend: pytest 8.4.2
- HTTP Testing: httpx 0.27.0 (FastAPI TestClient dependency)
- Mocking: pytest-mock 3.15.1

**Test File Structure:**
```
tests/
├── backend/
│   ├── conftest.py       # Test fixtures (existing)
│   └── security/
│       └── test_security_headers.py  # New file for this story
```

**Test Organization:**
- Test files mirror source structure
- Test functions: `test_<function_name>_<scenario>()` format
- Fixtures in `conftest.py` at appropriate level

**FastAPI TestClient Usage:**
```python
# tests/backend/conftest.py (fixture already exists)
@pytest.fixture
def client():
    """FastAPI test client."""
    return TestClient(app)

# tests/backend/security/test_security_headers.py
def test_security_headers_present(client):
    """Test security headers are present."""
    response = client.get('/health')
    assert response.headers['X-Content-Type-Options'] == 'nosniff'
    assert response.headers['X-Frame-Options'] == 'SAMEORIGIN'
    assert response.headers['X-XSS-Protection'] == '1; mode=block'
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-27 | 1.0 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

(To be populated by dev agent)

### Debug Log References

(To be populated by dev agent)

### Completion Notes List

(To be populated by dev agent)

### File List

(To be populated by dev agent)

## QA Results

(To be populated by QA agent)
