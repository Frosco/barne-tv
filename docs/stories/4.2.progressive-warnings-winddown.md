# Story 4.2: Progressive Warning System and Wind-Down Mode

## Status
Draft

## Story
**As a** child,
**I want** gentle warnings before time is up,
**so that** I'm not surprised when videos end.

## Acceptance Criteria

1. Warning appears when 10 minutes remaining threshold is crossed (first warning)
2. Warning message: "10 minutter igjen!" displayed prominently
3. Warning uses friendly, encouraging language
4. Two additional warnings: "5 minutter igjen!" at 5 minutes remaining, "2 minutter igjen!" at 2 minutes remaining
5. Wind-down mode activates when less than 10 minutes remaining (visual changes: softer colors, videos filtered to fit remaining time)
6. Mascot appears during warnings with encouraging messages
7. Warnings auto-dismiss after 3 seconds
8. If daily limit set below 10 minutes, only shows warnings for thresholds below the limit (e.g., 8 min limit shows only 5 min and 2 min warnings)
9. Warnings logged for parent review
10. Audio chime plays with warnings (if audio enabled in settings)
11. Frontend polls /api/limit/status every 30 seconds to check remaining time and update UI state
12. During wind-down mode (‚â§10 min remaining), video grid filtered to max_duration = minutes_remaining √ó 60 seconds
13. If no videos fit remaining time during wind-down, show all videos (better than empty grid)

## Tasks / Subtasks

- [ ] **Task 1: Add warning logging to database** (AC: 9)
  - [ ] Extend watch_history table to track warnings OR create separate warnings table
  - [ ] Decision: Use separate `limit_warnings` table for cleaner data model:
    ```sql
    CREATE TABLE limit_warnings (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        warning_type TEXT NOT NULL,  -- '10min', '5min', '2min'
        shown_at TEXT NOT NULL,      -- ISO 8601 UTC timestamp
        created_at TEXT NOT NULL DEFAULT (datetime('now'))
    );
    CREATE INDEX idx_warnings_date ON limit_warnings(DATE(shown_at));
    ```
  - [ ] Add migration in `backend/db/schema.sql`
  - [ ] Create function `queries.log_warning(warning_type: str, shown_at: str) -> None`
  - [ ] Use TIER 1 Rule 6: SQL placeholders
  - [ ] Use TIER 2 Rule 7: Context manager for database access
  - [ ] [Source: architecture/database-schema.md, architecture/coding-standards.md#tier-1-rule-6]

- [ ] **Task 2: Implement get_warnings_for_date() in queries.py** (AC: 9)
  - [ ] Create function `get_warnings_for_date(date: str, conn=None) -> list[dict]`
  - [ ] SELECT query: `SELECT * FROM limit_warnings WHERE DATE(shown_at) = ? ORDER BY shown_at DESC`
  - [ ] Return camelCase keys for frontend consistency
  - [ ] Use TIER 1 Rule 6: SQL placeholders
  - [ ] Use TIER 2 Rule 7: Context manager
  - [ ] [Source: architecture/coding-standards.md#tier-2-rule-12]

- [ ] **Task 3: Implement POST /api/warnings/log endpoint** (AC: 9)
  - [ ] Add route in `backend/routes.py`: `@app.post("/api/warnings/log")`
  - [ ] Request body: `{"warningType": "10min|5min|2min"}`
  - [ ] Call `queries.log_warning(warning_type, shown_at)` with UTC timestamp
  - [ ] Return JSON response:
    ```json
    {
      "success": true,
      "message": "Advarsel logget"
    }
    ```
  - [ ] No authentication required (child can log warnings)
  - [ ] Validate warning_type is one of ['10min', '5min', '2min']
  - [ ] Use TIER 1 Rule 3: UTC timestamp (`datetime.now(timezone.utc)`)
  - [ ] [Source: architecture/api-specification.md#child-interface-endpoints]

- [ ] **Task 4: Implement GET /admin/warnings endpoint** (AC: 9)
  - [ ] Add route in `backend/routes.py`: `@app.get("/admin/warnings")`
  - [ ] Use `require_auth(request)` for authentication (TIER 2 Rule 10)
  - [ ] Optional query param: `?date=YYYY-MM-DD` (defaults to today)
  - [ ] Call `queries.get_warnings_for_date(date)`
  - [ ] Return JSON response:
    ```json
    {
      "success": true,
      "date": "2025-01-03",
      "warnings": [
        {"warningType": "10min", "shownAt": "2025-01-03T14:20:00Z"},
        {"warningType": "5min", "shownAt": "2025-01-03T14:25:00Z"}
      ]
    }
    ```
  - [ ] [Source: architecture/api-specification.md#admin-interface-endpoints]

- [ ] **Task 5: Update /api/videos endpoint to support max_duration filtering** (AC: 12, 13)
  - [ ] Modify `backend/routes.py`: Add optional query param `?max_duration=180` (seconds)
  - [ ] Pass max_duration to `viewing_session.get_available_videos(max_duration=None)`
  - [ ] Update `viewing_session.get_available_videos()` to filter videos:
    ```python
    if max_duration is not None:
        videos = [v for v in videos if v['durationSeconds'] <= max_duration]
    ```
  - [ ] If filtered list empty, return original unfiltered list (AC 13: better than empty grid)
  - [ ] Add query validation: max_duration must be positive integer if provided
  - [ ] [Source: architecture/core-workflows.md#video-selection-logic]

- [ ] **Task 6: Create warning display component** (AC: 1, 2, 3, 4, 7)
  - [ ] Create module: `frontend/src/child/warning-display.js`
  - [ ] Export `showWarning(minutesRemaining)` function
  - [ ] Display warning overlay with message:
    - "10 minutter igjen!" for 10 min
    - "5 minutter igjen!" for 5 min
    - "2 minutter igjen!" for 2 min
  - [ ] Friendly, encouraging tone (use emoji or gentle styling)
  - [ ] Auto-dismiss after 3 seconds (AC 7)
  - [ ] Call POST /api/warnings/log when warning shown (AC 9)
  - [ ] Accessibility: ARIA live region for screen readers (aria-live="polite")
  - [ ] Accessibility: Focus management (don't trap focus, warning is informational only)
  - [ ] CSS: `.warning-overlay`, `.warning-overlay__message`, `.warning-overlay--active`
  - [ ] Use TIER 2 Rule 9: Handle API errors gracefully
  - [ ] Use TIER 3 Rule 14: Norwegian messages
  - [ ] [Source: architecture/coding-standards.md#css-standards]

- [ ] **Task 7: Implement warning threshold tracking in limit-tracker.js** (AC: 1, 4, 8)
  - [ ] Update `frontend/src/child/limit-tracker.js` to track warning thresholds
  - [ ] Store previous minutes remaining in memory
  - [ ] Detect threshold crossings: when minutes_remaining crosses 10‚Üí9, 5‚Üí4, 2‚Üí1
  - [ ] IMPORTANT: Threshold logic:
    ```javascript
    const thresholds = [10, 5, 2];
    // Show warning when crossing from above to at-or-below threshold
    if (prevMinutes > threshold && currentMinutes <= threshold) {
        showWarning(threshold);
    }
    ```
  - [ ] Handle edge case: If daily limit < 10 minutes (AC 8):
    - Filter thresholds to only those below the limit
    - Example: 8 min limit ‚Üí only show 5 min and 2 min warnings
  - [ ] Emit new event: `warningTriggered` with threshold value
  - [ ] Use TIER 3 Rule 15: In-memory state only (no localStorage)
  - [ ] [Source: architecture/state-management-pattern.md]

- [ ] **Task 8: Add wind-down mode styling** (AC: 5)
  - [ ] Update `frontend/src/main.css` with wind-down styles
  - [ ] Add CSS custom properties for wind-down mode:
    ```css
    --color-winddown-bg: #f0f4f8;      /* Softer blue-gray */
    --color-winddown-accent: #ffa726;  /* Warm orange accent */
    ```
  - [ ] Create wind-down mode classes:
    - `.video-grid--winddown` - Softer background, reduced contrast
    - `.video-card--winddown` - Slightly muted colors, gentle border
  - [ ] Apply classes when `currentState === "winddown"` from limit status
  - [ ] Accessibility: Maintain WCAG AA contrast ratios (4.5:1 minimum)
  - [ ] [Source: architecture/frontend-design-system.md#color-palette]

- [ ] **Task 9: Implement wind-down video filtering in child interface** (AC: 12, 13)
  - [ ] Update child video grid component to detect wind-down mode
  - [ ] When `currentState === "winddown"` from limit status:
    - Calculate `max_duration = minutesRemaining * 60`
    - Fetch videos with query param: `GET /api/videos?max_duration=${max_duration}`
  - [ ] Backend returns filtered videos (Task 5)
  - [ ] If backend returns empty array, fallback to all videos (AC 13)
  - [ ] Display count: "Viser videoer som passer tiden din" (Norwegian message)
  - [ ] Use TIER 2 Rule 9: Handle API errors
  - [ ] [Source: architecture/core-workflows.md#video-selection-logic]

- [ ] **Task 10: Stub audio chime integration** (AC: 10)
  - [ ] Create module: `frontend/src/child/audio-manager.js` (basic implementation)
  - [ ] Export `playWarningChime()` function (stub for now):
    ```javascript
    export function playWarningChime() {
        // TODO: Full implementation in Story 4.5 (Audio Feedback System)
        console.log('Warning chime (audio system pending Story 4.5)');
        return Promise.resolve();
    }
    ```
  - [ ] Call from `warning-display.js` when showing warning
  - [ ] Check settings: Only call if `audio_enabled === true`
  - [ ] Note: Full audio implementation deferred to Story 4.5
  - [ ] [Source: docs/prd/epic-4-time-limits-enhancements.md#story-4.5]

- [ ] **Task 11: Stub mascot integration** (AC: 6)
  - [ ] Update `frontend/src/child/warning-display.js` to show mascot placeholder
  - [ ] Add mascot image placeholder in warning overlay (use generic icon or emoji)
  - [ ] Display encouraging message alongside mascot:
    - 10 min: "Du har god tid igjen! üòä" (You have good time left!)
    - 5 min: "Snart er tiden ute, velg en kort video! üêª" (Soon time is up, choose a short video!)
    - 2 min: "Bare 2 minutter igjen! üïê" (Only 2 minutes left!)
  - [ ] Note: Full mascot character design deferred to Story 4.3
  - [ ] Accessibility: Add alt text for mascot image
  - [ ] [Source: docs/prd/epic-4-time-limits-enhancements.md#story-4.3]

- [ ] **Task 12: Write TIER 1 safety tests for warning logging** (AC: 9)
  - [ ] Create test file: `tests/backend/services/test_warning_logging.py`
  - [ ] Test: `test_log_warning_uses_sql_placeholders()`
    - [ ] Verify SQL injection prevention (TIER 1 Rule 6)
    - [ ] Attempt injection via warning_type parameter
    - [ ] Assert query uses placeholders
  - [ ] Test: `test_log_warning_uses_utc_timestamp()`
    - [ ] Verify UTC enforcement (TIER 1 Rule 3)
    - [ ] Mock timezone to non-UTC
    - [ ] Assert warning timestamp is UTC
  - [ ] Mark tests with `@pytest.mark.tier1` decorator
  - [ ] [Source: architecture/test-strategy-and-standards.md#tier-1-safety-tests]

- [ ] **Task 13: Write integration tests for warning endpoints** (AC: 9)
  - [ ] Create test file: `tests/backend/test_routes_warnings.py`
  - [ ] Test: `test_log_warning_creates_database_entry()`
    - [ ] POST /api/warnings/log with valid warning_type
    - [ ] Assert database contains new entry
  - [ ] Test: `test_log_warning_validates_warning_type()`
    - [ ] POST with invalid warning_type
    - [ ] Assert 400 Bad Request
  - [ ] Test: `test_get_warnings_requires_authentication()`
    - [ ] GET /admin/warnings without session
    - [ ] Assert 401 Unauthorized
  - [ ] Test: `test_get_warnings_returns_todays_warnings()`
    - [ ] Insert warnings for multiple dates
    - [ ] Assert only today's warnings returned
  - [ ] Use pytest fixtures from `tests/backend/conftest.py`
  - [ ] [Source: architecture/test-strategy-and-standards.md#integration-tests]

- [ ] **Task 14: Write integration tests for wind-down video filtering** (AC: 12, 13)
  - [ ] Create test file: `tests/backend/test_routes_winddown.py`
  - [ ] Test: `test_videos_filtered_by_max_duration()`
    - [ ] Insert videos with various durations (2, 5, 8, 12 minutes)
    - [ ] GET /api/videos?max_duration=360 (6 minutes)
    - [ ] Assert only videos ‚â§6 minutes returned
  - [ ] Test: `test_videos_fallback_when_none_fit()`
    - [ ] Insert only long videos (all >10 minutes)
    - [ ] GET /api/videos?max_duration=300 (5 minutes)
    - [ ] Assert all videos returned (AC 13: better than empty)
  - [ ] Test: `test_videos_without_max_duration_returns_all()`
    - [ ] GET /api/videos (no query param)
    - [ ] Assert all available videos returned
  - [ ] [Source: architecture/test-strategy-and-standards.md#integration-tests]

- [ ] **Task 15: Write frontend tests for warning display** (AC: 1, 2, 3, 4, 7)
  - [ ] Create test file: `frontend/src/child/warning-display.test.js`
  - [ ] Test: Warning displays correct message for each threshold (10, 5, 2 min)
  - [ ] Test: Warning auto-dismisses after 3 seconds
  - [ ] Test: Warning logs to backend API
  - [ ] Test: Warning includes mascot placeholder
  - [ ] Test: Audio chime called when warning shown
  - [ ] Use Vitest with happy-dom environment
  - [ ] Mock fetch API responses
  - [ ] Mock timers for 3-second auto-dismiss
  - [ ] [Source: architecture/test-strategy-and-standards.md#frontend-tests]

- [ ] **Task 16: Write frontend tests for threshold tracking** (AC: 1, 4, 8)
  - [ ] Create test file: `frontend/src/child/limit-tracker.test.js` (extend existing)
  - [ ] Test: Threshold crossing detection (10‚Üí9, 5‚Üí4, 2‚Üí1 minute transitions)
  - [ ] Test: No warning when staying above threshold
  - [ ] Test: No duplicate warnings for same threshold
  - [ ] Test: Threshold filtering when limit < 10 minutes (AC 8)
  - [ ] Test: `warningTriggered` event emitted with correct threshold
  - [ ] Use Vitest with happy-dom
  - [ ] [Source: architecture/test-strategy-and-standards.md#frontend-tests]

- [ ] **Task 17: Write frontend tests for wind-down mode** (AC: 5, 12, 13)
  - [ ] Create test file: `frontend/src/child/video-grid.test.js` (or extend existing)
  - [ ] Test: Wind-down CSS classes applied when state === "winddown"
  - [ ] Test: Video fetch includes max_duration param during wind-down
  - [ ] Test: Fallback to all videos when filtered list empty
  - [ ] Test: Wind-down message displayed
  - [ ] Use Vitest with happy-dom
  - [ ] Mock fetch API responses
  - [ ] [Source: architecture/test-strategy-and-standards.md#frontend-tests]

## Dev Notes

### Story Context

This story builds directly on **Story 4.1 (Time-Based Viewing Limits)** to add user-facing warning features and wind-down mode. Story 4.1 established the foundation:
- Backend: Daily limit calculation, state machine (`normal|winddown|grace|locked`)
- Frontend: Polling module (`limit-tracker.js`) that checks `/api/limit/status` every 30 seconds
- Event system: `limitStateChanged` event when state transitions

**Story 4.2 adds:**
1. **Warning system**: Detect minute thresholds (10, 5, 2 min) and show friendly alerts
2. **Wind-down mode**: Visual styling changes when ‚â§10 minutes remaining
3. **Smart video filtering**: Show only videos that fit remaining time during wind-down
4. **Warning logging**: Track warnings shown for parent review

### Previous Story Insights

**From Story 4.1 (Time-Based Viewing Limits):**

**Already Implemented:**
- ‚úÖ `backend/services/viewing_session.py:get_daily_limit()` - Returns current state including `"currentState": "normal|winddown|grace|locked"`
- ‚úÖ Wind-down detection logic exists:
  ```python
  if minutes_remaining > 10:
      current_state = "normal"
  elif minutes_remaining > 0:
      current_state = "winddown"  # ‚â§10 minutes remaining
  ```
- ‚úÖ `frontend/src/child/limit-tracker.js` - Polls `/api/limit/status` every 30 seconds
- ‚úÖ Event system: Emits `limitStateChanged` event when state changes
- ‚úÖ In-memory state management (no localStorage per TIER 3 Rule 15)
- ‚úÖ Page Visibility API optimization (pauses polling when tab hidden)
- ‚úÖ Error handling with exponential backoff (60s after 3 failures)

**Key Learnings:**
- AC 11 (frontend polling) is ALREADY COMPLETE from Story 4.1
- Wind-down state detection is ALREADY IMPLEMENTED in backend
- Event-based architecture is ready for warnings to hook into
- The polling module tracks previous state, so we can extend it to track previous minutes_remaining for threshold detection

**What Story 4.2 Must Add:**
- Threshold crossing detection (not just state detection)
- Warning display UI component
- Warning logging database and API
- Video filtering by max_duration (both backend and frontend)
- Wind-down styling (CSS changes)
- Mascot and audio stubs (full implementation in Stories 4.3 and 4.5)

[Source: docs/stories/4.1.time-based-viewing-limits.md#dev-agent-record]

### Existing Implementations from Story 4.1

**Polling Infrastructure (ALREADY IMPLEMENTED):**

File: `frontend/src/child/limit-tracker.js`

```javascript
export function initLimitTracker() {
    let pollInterval = null;
    let currentState = null;
    let failureCount = 0;

    async function pollLimitStatus() {
        try {
            const response = await fetch('/api/limit/status');
            if (!response.ok) {
                throw new Error('Failed to fetch limit status');
            }

            const data = await response.json();
            failureCount = 0;

            // Emit state change event if state changed
            if (data.currentState !== currentState) {
                currentState = data.currentState;
                document.dispatchEvent(new CustomEvent('limitStateChanged', {
                    detail: data
                }));
            }

            // Emit grace limit event
            if (data.currentState === 'grace') {
                document.dispatchEvent(new CustomEvent('graceLimitReached', {
                    detail: data
                }));
            }
        } catch (error) {
            console.error('Limit status poll failed:', error);
            failureCount++;
            if (failureCount >= 3) {
                // After 3 failures, switch to 60s interval
                clearInterval(pollInterval);
                pollInterval = setInterval(pollLimitStatus, 60000);
            }
        }
    }

    // Start polling every 30 seconds
    pollInterval = setInterval(pollLimitStatus, 30000);
    pollLimitStatus(); // Initial poll

    // Page Visibility API: pause when tab hidden
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
            clearInterval(pollInterval);
        } else {
            pollInterval = setInterval(pollLimitStatus, 30000);
            pollLimitStatus();
        }
    });
}
```

**Backend State Machine (ALREADY IMPLEMENTED):**

File: `backend/services/viewing_session.py`

```python
def get_daily_limit(conn=None) -> dict:
    """
    Get current daily limit state including minutes watched and current state.

    Returns:
        {
            "date": "2025-01-03",
            "minutesWatched": 15,
            "minutesRemaining": 15,
            "currentState": "normal|winddown|grace|locked",
            "resetTime": "2025-01-04T00:00:00Z"
        }
    """
    # ... existing implementation ...

    # State determination logic
    if minutes_remaining > 10:
        current_state = "normal"
    elif minutes_remaining > 0:
        current_state = "winddown"  # Wind-down mode active
    else:
        grace_consumed = check_grace_consumed(today, conn=conn)
        current_state = "locked" if grace_consumed else "grace"

    return {
        "date": today,
        "minutesWatched": minutes_watched,
        "minutesRemaining": minutes_remaining,
        "currentState": current_state,
        "resetTime": reset_time.isoformat()
    }
```

**What Story 4.2 Extends:**

1. **Extend limit-tracker.js** (Task 7):
   - Add `prevMinutesRemaining` tracking
   - Add threshold crossing detection (10‚Üí9, 5‚Üí4, 2‚Üí1)
   - Emit new `warningTriggered` event
   - Call warning display component

2. **Extend /api/videos endpoint** (Task 5):
   - Add optional `max_duration` query parameter
   - Filter videos in `get_available_videos()`

3. **Add warning database table** (Task 1):
   - New `limit_warnings` table for logging

[Source: frontend/src/child/limit-tracker.js, backend/services/viewing_session.py:80-92]

### Database Schema

**New Table: limit_warnings (Task 1)**

```sql
CREATE TABLE IF NOT EXISTS limit_warnings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    warning_type TEXT NOT NULL,  -- '10min', '5min', '2min'
    shown_at TEXT NOT NULL,      -- ISO 8601 UTC timestamp
    created_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_warnings_date ON limit_warnings(DATE(shown_at));
```

**Design Rationale:**
- Separate table (not extending watch_history) for cleaner data model
- warning_type enum: '10min', '5min', '2min' (easy to query specific warnings)
- shown_at: When warning was displayed to child (UTC)
- Index on DATE(shown_at) for efficient parent review queries

**Existing Tables (from Story 4.1):**

File: `backend/db/schema.sql`

```sql
CREATE TABLE IF NOT EXISTS watch_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    video_id TEXT NOT NULL,
    video_title TEXT NOT NULL,
    channel_name TEXT NOT NULL,
    watched_at TEXT NOT NULL,          -- ISO 8601 UTC timestamp
    completed INTEGER NOT NULL,        -- 0/1 flag
    manual_play INTEGER NOT NULL DEFAULT 0,   -- Parent "play again"
    grace_play INTEGER NOT NULL DEFAULT 0,    -- Grace video
    duration_watched_seconds INTEGER NOT NULL,
    created_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX idx_watch_history_date_flags
    ON watch_history(DATE(watched_at), manual_play, grace_play);

CREATE TABLE IF NOT EXISTS settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,  -- JSON-encoded values
    updated_at TEXT NOT NULL,
    created_at TEXT NOT NULL DEFAULT (datetime('now'))
);

-- Relevant settings
-- daily_limit_minutes: default 30
-- audio_enabled: default true
```

[Source: backend/db/schema.sql, architecture/database-schema.md]

### API Specifications

**New Endpoints:**

**POST /api/warnings/log (No authentication required)**

Request:
```json
{
  "warningType": "10min"
}
```

Response:
```json
{
  "success": true,
  "message": "Advarsel logget"
}
```

Validation:
- warningType must be one of: ['10min', '5min', '2min']
- Returns 400 Bad Request if invalid

**GET /admin/warnings (Requires authentication)**

Query params:
- `?date=YYYY-MM-DD` (optional, defaults to today)

Response:
```json
{
  "success": true,
  "date": "2025-01-03",
  "warnings": [
    {
      "warningType": "10min",
      "shownAt": "2025-01-03T14:20:00Z"
    },
    {
      "warningType": "5min",
      "shownAt": "2025-01-03T14:25:00Z"
    }
  ]
}
```

Error (401):
```json
{
  "error": "Unauthorized",
  "redirect": "/admin/login"
}
```

**Modified Endpoint:**

**GET /api/videos (No authentication required)**

NEW Query params:
- `?max_duration=300` (optional, integer seconds)

Behavior:
- If max_duration provided: Filter videos where `durationSeconds <= max_duration`
- If filtered list is empty: Return all videos (AC 13: better than empty grid)
- If max_duration not provided: Return all available videos (existing behavior)

Response format unchanged:
```json
{
  "videos": [
    {
      "videoId": "abc123",
      "title": "Video Title",
      "channelName": "Channel Name",
      "thumbnailUrl": "https://...",
      "durationSeconds": 240
    }
  ]
}
```

[Source: architecture/api-specification.md]

### State Machine

**Daily Limit State Transitions (from Story 4.1):**

```
normal (>10 min remaining)
  ‚Üì (time passes, crosses 10 min threshold)
winddown (‚â§10 min remaining)
  ‚Üì (limit reached)
grace (0 min remaining, grace available)
  ‚Üì (grace video watched OR declined)
locked (until midnight UTC)
  ‚Üì (midnight UTC)
normal (reset to full limit)
```

**Warning Threshold State Machine (NEW in Story 4.2):**

```
No warnings shown (>10 min remaining)
  ‚Üì (crosses 10 min threshold: 10‚Üí9 minutes)
10-minute warning shown
  ‚Üì (crosses 5 min threshold: 5‚Üí4 minutes)
5-minute warning shown
  ‚Üì (crosses 2 min threshold: 2‚Üí1 minutes)
2-minute warning shown
  ‚Üì (limit reached)
Grace or locked state
```

**Threshold Detection Logic:**

```javascript
// In limit-tracker.js (Task 7)
const THRESHOLDS = [10, 5, 2];

function detectThresholdCrossings(prevMinutes, currentMinutes, dailyLimit) {
    // Filter thresholds based on daily limit (AC 8)
    const activeThresholds = THRESHOLDS.filter(t => t < dailyLimit);

    for (const threshold of activeThresholds) {
        // Warning triggers when crossing FROM above TO at-or-below threshold
        if (prevMinutes > threshold && currentMinutes <= threshold) {
            return threshold;  // Crossed this threshold
        }
    }

    return null;  // No threshold crossed
}
```

**Edge Cases:**

1. **Daily limit < 10 minutes (AC 8):**
   - Example: 8-minute limit
   - Active thresholds: [5, 2] (10 filtered out)
   - First video starts ‚Üí immediately in winddown mode
   - Shows 5-min warning when 5‚Üí4 min remaining
   - Shows 2-min warning when 2‚Üí1 min remaining

2. **Daily limit between thresholds:**
   - Example: 7-minute limit
   - Active thresholds: [5, 2]
   - 10-minute warning never shown

3. **Very short daily limit:**
   - Example: 3-minute limit
   - Active thresholds: [2]
   - Only 2-minute warning shown

[Source: backend/services/viewing_session.py:80-92, docs/prd/epic-4-time-limits-enhancements.md]

### TIER 1 Safety Rules (CRITICAL - Cannot Violate)

**Rule 3: UTC Time for All Date Operations**

```python
# ‚úÖ CORRECT - Use UTC for warning timestamps
from datetime import datetime, timezone

def log_warning(warning_type: str) -> None:
    shown_at = datetime.now(timezone.utc).isoformat()
    with get_connection() as conn:
        conn.execute(
            "INSERT INTO limit_warnings (warning_type, shown_at) VALUES (?, ?)",
            (warning_type, shown_at)
        )

# ‚ùå WRONG - Naive datetime
shown_at = datetime.now().isoformat()  # Ambiguous timezone
```

**Why critical:** Warnings must align with UTC-based limit resets. Timezone bugs cause incorrect warning timing.

**Rule 6: SQL Parameters - Always Use Placeholders**

```python
# ‚úÖ CORRECT - Parameterized query
def log_warning(warning_type: str, shown_at: str, conn=None):
    with get_connection() as conn:
        conn.execute(
            "INSERT INTO limit_warnings (warning_type, shown_at) VALUES (?, ?)",
            (warning_type, shown_at)
        )

# ‚ùå WRONG - String formatting enables SQL injection
def log_warning(warning_type: str, shown_at: str, conn=None):
    with get_connection() as conn:
        conn.execute(
            f"INSERT INTO limit_warnings (warning_type, shown_at) VALUES ('{warning_type}', '{shown_at}')"
        )
    # Attacker input: "'; DROP TABLE limit_warnings; --"
```

**Why critical:** SQL injection could corrupt warning logs or compromise database.

**Rule 1: Always Filter Banned Videos (applies to Task 5 video filtering)**

```python
# ‚úÖ CORRECT - Filter banned videos during wind-down
def get_available_videos(max_duration: int = None, conn=None) -> list[dict]:
    query = """
        SELECT v.video_id, v.title, v.channel_name, v.thumbnail_url, v.duration_seconds
        FROM videos v
        WHERE v.available = 1
        AND NOT EXISTS (
            SELECT 1 FROM banned_videos b WHERE b.video_id = v.video_id
        )
    """
    if max_duration is not None:
        query += " AND v.duration_seconds <= ?"
        params = (max_duration,)
    else:
        params = ()

    with get_connection() as conn:
        videos = conn.execute(query, params).fetchall()

    # If filtering resulted in empty list, return all available videos (AC 13)
    if max_duration is not None and len(videos) == 0:
        return get_available_videos(max_duration=None, conn=conn)

    return videos

# ‚ùå WRONG - Forgot to filter banned videos during wind-down
# Child could see banned videos when time is low
```

**Why critical:** Banned videos must NEVER be shown, regardless of time remaining.

[Source: architecture/coding-standards.md#tier-1-child-safety-rules]

### TIER 2 Functionality Rules

**Rule 7: Database Access - Always Use Context Manager**

```python
# ‚úÖ CORRECT - Context manager ensures rollback on errors
def log_warning(warning_type: str, conn=None) -> None:
    shown_at = datetime.now(timezone.utc).isoformat()
    with get_connection() as conn:
        conn.execute(
            "INSERT INTO limit_warnings (warning_type, shown_at) VALUES (?, ?)",
            (warning_type, shown_at)
        )

# ‚ùå WRONG - Manual connection management
def log_warning(warning_type: str) -> None:
    conn = sqlite3.connect(DATABASE_PATH)
    shown_at = datetime.now(timezone.utc).isoformat()
    conn.execute(
        "INSERT INTO limit_warnings (warning_type, shown_at) VALUES (?, ?)",
        (warning_type, shown_at)
    )
    conn.close()  # What if exception happens before this?
```

**Rule 9: Frontend API Calls - Always Handle Errors**

```javascript
// ‚úÖ CORRECT - Error handling doesn't break user experience
async function logWarning(warningType) {
    try {
        const response = await fetch('/api/warnings/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ warningType })
        });
        if (!response.ok) {
            console.error('Failed to log warning');
        }
    } catch (error) {
        console.error('Warning log network error:', error);
        // Don't break warning display if logging fails
    }
}

// ‚ùå WRONG - Unhandled promise rejection crashes UI
async function logWarning(warningType) {
    await fetch('/api/warnings/log', {
        method: 'POST',
        body: JSON.stringify({ warningType })
    });
    // Crashes if network error or 500 response
}
```

**Rule 10: Session Validation - Use Helper Function**

```python
# ‚úÖ CORRECT - Use require_auth helper
@app.get("/admin/warnings")
async def get_warnings(request: Request, date: str = None):
    require_auth(request)  # Raises 401 if not authenticated
    if date is None:
        date = datetime.now(timezone.utc).date().isoformat()
    warnings = queries.get_warnings_for_date(date)
    return {"success": True, "date": date, "warnings": warnings}

# ‚ùå WRONG - Manual session checking
@app.get("/admin/warnings")
async def get_warnings(request: Request, date: str = None):
    if 'session_id' not in request.cookies:
        return {"error": "Unauthorized"}  # Wrong pattern, missing redirect
```

**Rule 12: API Response Format - Consistent Structure**

```python
# ‚úÖ CORRECT - Consistent success/error structure
@app.post("/api/warnings/log")
async def log_warning(request: Request):
    body = await request.json()
    warning_type = body.get('warningType')

    if warning_type not in ['10min', '5min', '2min']:
        return JSONResponse(
            status_code=400,
            content={
                "error": "InvalidWarningType",
                "message": "Ugyldig advarseltype"
            }
        )

    queries.log_warning(warning_type, datetime.now(timezone.utc).isoformat())
    return {"success": True, "message": "Advarsel logget"}

# ‚ùå WRONG - Inconsistent response structure
return {"logged": True}  # Frontend doesn't know if this is success or error
```

[Source: architecture/coding-standards.md#tier-2-functionality-rules]

### TIER 3 Code Quality Rules

**Rule 13: All Backend Operations Are Synchronous**

```python
# ‚úÖ CORRECT - Synchronous functions, FastAPI handles threading
def log_warning(warning_type: str, conn=None) -> None:
    shown_at = datetime.now(timezone.utc).isoformat()
    with get_connection() as conn:
        conn.execute(
            "INSERT INTO limit_warnings (warning_type, shown_at) VALUES (?, ?)",
            (warning_type, shown_at)
        )

# ‚ùå WRONG - No async/await in this project
async def log_warning(warning_type: str) -> None:
    # We're all-sync by design
```

**Rule 14: Norwegian User-Facing Messages**

```javascript
// ‚úÖ CORRECT - Norwegian messages for child
const WARNING_MESSAGES = {
    10: "10 minutter igjen!",
    5: "5 minutter igjen!",
    2: "2 minutter igjen!"
};

const ENCOURAGEMENT = {
    10: "Du har god tid igjen! üòä",
    5: "Snart er tiden ute, velg en kort video! üêª",
    2: "Bare 2 minutter igjen! üïê"
};

// ‚ùå WRONG - English user messages
const WARNING_MESSAGES = {
    10: "10 minutes left!",
    5: "5 minutes left!",
    2: "2 minutes left!"
};
```

**Rule 15: No localStorage/sessionStorage in Frontend**

```javascript
// ‚úÖ CORRECT - In-memory threshold tracking
let lastMinutesRemaining = null;
let shownWarnings = new Set();  // Track which warnings already shown this session

function trackThresholds(currentMinutes) {
    if (lastMinutesRemaining !== null) {
        // Detect crossings
        if (lastMinutesRemaining > 10 && currentMinutes <= 10 && !shownWarnings.has(10)) {
            showWarning(10);
            shownWarnings.add(10);
        }
    }
    lastMinutesRemaining = currentMinutes;
}

// ‚ùå WRONG - Browser storage not supported
localStorage.setItem('shownWarnings', JSON.stringify(shownWarnings));
```

[Source: architecture/coding-standards.md#tier-3-code-quality-rules]

### File Locations

**Backend Files:**
- Schema: `backend/db/schema.sql` (add limit_warnings table migration)
- Queries: `backend/db/queries.py` (add log_warning, get_warnings_for_date)
- Service: `backend/services/viewing_session.py` (update get_available_videos for max_duration)
- Routes: `backend/routes.py` (add POST /api/warnings/log, GET /admin/warnings, modify GET /api/videos)

**Frontend Files:**
- Warning display: `frontend/src/child/warning-display.js` (NEW - warning overlay component)
- Limit tracker: `frontend/src/child/limit-tracker.js` (EXTEND - add threshold detection)
- Audio manager: `frontend/src/child/audio-manager.js` (NEW - stub for Story 4.5)
- CSS: `frontend/src/main.css` (add wind-down mode styles)
- Child entry: `frontend/src/child.js` (import and init warning display)

**Test Files:**
- Backend TIER 1: `tests/backend/services/test_warning_logging.py` (NEW)
- Backend integration: `tests/backend/test_routes_warnings.py` (NEW)
- Backend integration: `tests/backend/test_routes_winddown.py` (NEW)
- Frontend warning: `frontend/src/child/warning-display.test.js` (NEW)
- Frontend tracker: `frontend/src/child/limit-tracker.test.js` (EXTEND existing)
- Frontend grid: `frontend/src/child/video-grid.test.js` (EXTEND or NEW)

[Source: architecture/source-tree.md]

### Component Specifications

**Warning Display Component (Task 6)**

File: `frontend/src/child/warning-display.js`

```javascript
/**
 * Warning Display Component
 * Shows friendly time warnings to child with auto-dismiss
 */

const WARNING_MESSAGES = {
    10: "10 minutter igjen!",
    5: "5 minutter igjen!",
    2: "2 minutter igjen!"
};

const ENCOURAGEMENT = {
    10: "Du har god tid igjen! üòä",
    5: "Snart er tiden ute, velg en kort video! üêª",
    2: "Bare 2 minutter igjen! üïê"
};

export function showWarning(minutesRemaining) {
    const message = WARNING_MESSAGES[minutesRemaining];
    const encouragement = ENCOURAGEMENT[minutesRemaining];

    // Create warning overlay
    const overlay = document.createElement('div');
    overlay.className = 'warning-overlay warning-overlay--active';
    overlay.setAttribute('role', 'alert');
    overlay.setAttribute('aria-live', 'polite');

    overlay.innerHTML = `
        <div class="warning-overlay__content">
            <div class="warning-overlay__mascot" role="img" aria-label="Maskot">
                üêª
            </div>
            <h2 class="warning-overlay__message">${message}</h2>
            <p class="warning-overlay__encouragement">${encouragement}</p>
        </div>
    `;

    document.body.appendChild(overlay);

    // Log warning to backend (AC 9)
    logWarningToBackend(`${minutesRemaining}min`);

    // Play audio chime if enabled (AC 10)
    playWarningChimeIfEnabled();

    // Auto-dismiss after 3 seconds (AC 7)
    setTimeout(() => {
        overlay.classList.remove('warning-overlay--active');
        setTimeout(() => overlay.remove(), 300); // Wait for CSS transition
    }, 3000);
}

async function logWarningToBackend(warningType) {
    try {
        await fetch('/api/warnings/log', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ warningType })
        });
    } catch (error) {
        console.error('Failed to log warning:', error);
        // Don't break warning display if logging fails
    }
}

async function playWarningChimeIfEnabled() {
    // Import audio manager (stub for now, full impl in Story 4.5)
    const { playWarningChime } = await import('./audio-manager.js');
    playWarningChime();
}
```

**Threshold Tracking Extension (Task 7)**

File: `frontend/src/child/limit-tracker.js` (extend existing)

```javascript
// ADD to existing limit-tracker.js from Story 4.1

const THRESHOLDS = [10, 5, 2];

export function initLimitTracker() {
    let pollInterval = null;
    let currentState = null;
    let failureCount = 0;

    // NEW: Track previous minutes and shown warnings
    let prevMinutesRemaining = null;
    let shownWarnings = new Set();  // Track which warnings shown this session
    let dailyLimitMinutes = null;

    async function pollLimitStatus() {
        try {
            const response = await fetch('/api/limit/status');
            if (!response.ok) {
                throw new Error('Failed to fetch limit status');
            }

            const data = await response.json();
            failureCount = 0;

            // Store daily limit for threshold filtering (AC 8)
            if (dailyLimitMinutes === null) {
                dailyLimitMinutes = data.minutesWatched + data.minutesRemaining;
            }

            // NEW: Detect threshold crossings
            if (prevMinutesRemaining !== null) {
                detectAndShowWarnings(
                    prevMinutesRemaining,
                    data.minutesRemaining,
                    dailyLimitMinutes
                );
            }

            prevMinutesRemaining = data.minutesRemaining;

            // Existing state change event
            if (data.currentState !== currentState) {
                currentState = data.currentState;
                document.dispatchEvent(new CustomEvent('limitStateChanged', {
                    detail: data
                }));
            }

            // Existing grace event
            if (data.currentState === 'grace') {
                document.dispatchEvent(new CustomEvent('graceLimitReached', {
                    detail: data
                }));
            }
        } catch (error) {
            console.error('Limit status poll failed:', error);
            failureCount++;
            if (failureCount >= 3) {
                clearInterval(pollInterval);
                pollInterval = setInterval(pollLimitStatus, 60000);
            }
        }
    }

    function detectAndShowWarnings(prevMinutes, currentMinutes, dailyLimit) {
        // Filter thresholds based on daily limit (AC 8)
        const activeThresholds = THRESHOLDS.filter(t => t < dailyLimit);

        for (const threshold of activeThresholds) {
            // Show warning when crossing FROM above TO at-or-below threshold
            if (prevMinutes > threshold &&
                currentMinutes <= threshold &&
                !shownWarnings.has(threshold)) {

                // Emit event
                document.dispatchEvent(new CustomEvent('warningTriggered', {
                    detail: { threshold, minutesRemaining: currentMinutes }
                }));

                // Show warning UI
                showWarning(threshold);

                // Mark as shown (prevent duplicates)
                shownWarnings.add(threshold);
            }
        }
    }

    // ... rest of existing implementation (polling setup, Page Visibility API, etc.)
}
```

**Wind-Down Styling (Task 8)**

File: `frontend/src/main.css` (add to existing file)

```css
/* Wind-Down Mode Styles */

:root {
    /* Add wind-down color palette */
    --color-winddown-bg: #f0f4f8;       /* Softer blue-gray background */
    --color-winddown-accent: #ffa726;   /* Warm orange accent */
    --color-winddown-text: #5a6c7d;     /* Muted text color */
}

/* Video grid in wind-down mode */
.video-grid--winddown {
    background-color: var(--color-winddown-bg);
    transition: background-color 0.5s ease;
}

/* Video cards in wind-down mode */
.video-card--winddown {
    border: 2px solid var(--color-winddown-accent);
    opacity: 0.9;
    transition: opacity 0.5s ease, border 0.5s ease;
}

.video-card--winddown:hover {
    opacity: 1;
    border-color: var(--color-accent);
}

/* Warning Overlay Styles */

.warning-overlay {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    opacity: 0;
    z-index: 1000;
    background-color: rgba(255, 255, 255, 0.98);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    text-align: center;
    min-width: 300px;
    max-width: 500px;
    transition: opacity 0.3s ease, transform 0.3s ease;
}

.warning-overlay--active {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}

.warning-overlay__content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.warning-overlay__mascot {
    font-size: 4rem;
    line-height: 1;
}

.warning-overlay__message {
    font-size: 2rem;
    font-weight: bold;
    color: var(--color-accent);
    margin: 0;
}

.warning-overlay__encouragement {
    font-size: 1.25rem;
    color: var(--color-winddown-text);
    margin: 0;
}

/* Accessibility: High contrast for WCAG AA compliance */
@media (prefers-contrast: high) {
    .warning-overlay__message {
        color: var(--color-text);
    }
    .warning-overlay__encouragement {
        color: var(--color-text);
    }
}
```

[Source: architecture/frontend-design-system.md#component-patterns]

### Testing Requirements

**Test Coverage Targets:**
- TIER 1 safety code: 100% coverage required
- Business logic: 90% coverage target
- UI components: 70% coverage acceptable

**Test Markers:**
```python
import pytest

@pytest.mark.tier1
def test_log_warning_uses_sql_placeholders():
    """TIER 1 Safety Test: Verify SQL injection prevention in warning logging."""
    # Test implementation
```

**Test Execution:**
```bash
# Backend - TIER 1 safety tests only
uv run pytest -m tier1 -v tests/backend/services/test_warning_logging.py

# Backend - all tests with coverage
uv run pytest tests/backend/ -v --cov=backend --cov-report=html

# Frontend - all tests
npm test

# Frontend - with coverage
npm run test:coverage
```

**Frontend Test Framework:**
- Vitest 3.2.4 with happy-dom 19.0.2
- Tests collocated with source files
- Mock fetch API for HTTP requests
- Mock timers for auto-dismiss testing

**Test Fixtures:**

Use existing fixtures from `tests/backend/conftest.py`:
- `test_db` - In-memory SQLite database
- `client` - FastAPI TestClient
- `auth_session` - Mock admin session cookie

**Test Data Patterns:**

```python
# Warning log test data
{
    "warning_type": "10min",
    "shown_at": "2025-01-03T14:20:00Z"
}

# Video data for duration filtering
{
    "video_id": "short_video",
    "title": "Short Video",
    "duration_seconds": 180  # 3 minutes
}

{
    "video_id": "long_video",
    "title": "Long Video",
    "duration_seconds": 720  # 12 minutes
}
```

[Source: architecture/test-strategy-and-standards.md]

### Technical Constraints

**Warning Threshold Behavior (AC 8):**
- Thresholds: [10, 5, 2] minutes (hardcoded, not configurable)
- If daily limit < 10 minutes, filter thresholds to only those below limit
- Example: 8-minute limit ‚Üí show only 5 and 2 minute warnings
- Example: 3-minute limit ‚Üí show only 2 minute warning
- Example: 1-minute limit ‚Üí no warnings (all thresholds filtered out)

**Wind-Down Filtering Logic (AC 12-13):**
- Activated when `currentState === "winddown"` (‚â§10 minutes remaining)
- Filter formula: `max_duration = minutes_remaining * 60` seconds
- If NO videos fit: Return ALL videos (better than empty grid per AC 13)
- Banned videos MUST still be filtered (TIER 1 Rule 1)

**Auto-Dismiss Timing (AC 7):**
- Warnings must auto-dismiss after exactly 3 seconds
- Use `setTimeout(callback, 3000)`
- CSS transition on dismiss for smooth UX (300ms fade out)

**Polling Dependency (AC 11):**
- Already implemented in Story 4.1
- Story 4.2 EXTENDS existing `limit-tracker.js`
- No changes to polling interval (remains 30s)

**Audio/Mascot Stubs (AC 6, 10):**
- Audio chime: Stub implementation in `audio-manager.js` (full impl in Story 4.5)
- Mascot: Use emoji placeholder (full design in Story 4.3)
- These stubs are ACCEPTABLE for Story 4.2 completion

**State Management:**
- In-memory only (no localStorage per TIER 3 Rule 15)
- Track `prevMinutesRemaining` for threshold crossing detection
- Track `shownWarnings` Set to prevent duplicate warnings per session
- Reset on page refresh (intentional, matches TIER 3 constraints)

[Source: architecture/coding-standards.md#tier-1-rule-3, docs/prd/epic-4-time-limits-enhancements.md]

### Edge Cases to Handle

**Scenario 1: Daily limit < 10 minutes (AC 8)**
- Example: Parent sets 8-minute limit
- Active warnings: [5, 2] (10 filtered out)
- Child starts first video ‚Üí immediately in winddown mode
- Shows 5-min warning when crossing 5‚Üí4 minutes
- Shows 2-min warning when crossing 2‚Üí1 minutes
- NEVER shows 10-min warning (threshold above limit)

**Scenario 2: Very short limit (e.g., 2 minutes)**
- Active warnings: [] (all thresholds filtered out)
- No warnings shown (all thresholds ‚â• limit)
- Wind-down mode active from first video
- Child goes directly to grace after 2 minutes

**Scenario 3: Warning during video playback**
- Child watching 10-minute video at 15 minutes remaining
- Time crosses 10-minute threshold during video
- Warning overlay appears ON TOP of video player
- Video continues playing underneath
- Warning auto-dismisses after 3 seconds

**Scenario 4: Multiple threshold crossings in one poll**
- Edge case: Poll interval 30s, but child used 9+ minutes between polls
- Example: Previous poll showed 11 min, current poll shows 1 min
- Thresholds crossed: 10 min AND 5 min AND 2 min
- Solution: Show all crossed warnings sequentially (10, then 5, then 2)
- OR: Show only the lowest crossed threshold (most urgent)
- **Decision: Show only lowest crossed threshold** (simpler UX, most urgent info)

**Scenario 5: Wind-down filtering returns no videos (AC 13)**
- Example: 3 minutes remaining, all videos are 5+ minutes
- Backend filters: No videos ‚â§180 seconds
- Backend returns: ALL videos (fallback behavior)
- Child sees: Full grid, can choose any video
- Rationale: Better to show all videos than empty grid (child confused)

**Scenario 6: Parent resets limit during wind-down**
- Child in wind-down mode (8 minutes remaining)
- Parent resets limit to full 30 minutes
- Next poll (within 30s): `minutesRemaining` jumps to 30
- Wind-down mode deactivates (state changes to "normal")
- Warning thresholds reset (`shownWarnings` cleared)
- Child can receive warnings again later

**Scenario 7: Browser tab hidden during warning**
- Warning shows at 10-minute threshold
- Child switches tab (Page Visibility API pauses polling)
- Warning auto-dismisses after 3 seconds (even if tab hidden)
- Child returns to tab ‚Üí sees normal interface (warning gone)
- Next threshold (5 min) will show normally

**Scenario 8: Network failure during warning log**
- Warning displays successfully
- POST /api/warnings/log fails (network error)
- Warning still shows to child (UX not affected)
- Warning not logged in database
- Parent may not see this warning in admin review
- Acceptable: Warning display is more important than logging

**Scenario 9: Duplicate warnings prevented**
- Poll at 10.5 minutes remaining ‚Üí no warning (above threshold)
- Poll at 10.0 minutes remaining ‚Üí warning shown
- Poll at 9.5 minutes remaining ‚Üí no warning (already shown threshold 10)
- `shownWarnings` Set prevents duplicate: `{10}`
- Child won't see 10-min warning again until page refresh

[Source: architecture/core-workflows.md#daily-limit-enforcement]

### Integration with Future Stories

**Story 4.3: Grace Video and Mascot Integration**
- Story 4.2 uses emoji placeholder for mascot (üêª)
- Story 4.3 will replace with actual mascot character design
- Warning overlay component designed for easy mascot image swap
- CSS class: `.warning-overlay__mascot` (change content, keep structure)

**Story 4.5: Audio Feedback System**
- Story 4.2 creates `audio-manager.js` stub
- Current implementation: `playWarningChime()` logs to console
- Story 4.5 will implement actual audio playback with Web Audio API
- Function signature remains unchanged (drop-in replacement)

**Story 4.4: Engagement-Based Smart Selection**
- Story 4.4 may modify video selection algorithm
- Wind-down filtering (Task 5) must be preserved
- Smart selection happens BEFORE wind-down filtering
- Order: Smart selection ‚Üí wind-down filtering ‚Üí banned filtering

[Source: docs/prd/epic-4-time-limits-enhancements.md]

### Security Considerations

**Input Validation:**
- Warning type: Must be one of ['10min', '5min', '2min']
- Date parameter: Validate ISO format YYYY-MM-DD
- Max duration: Must be positive integer if provided

**SQL Injection Prevention:**
- All queries use SQL placeholders (TIER 1 Rule 6)
- Validation before database operations
- Comprehensive TIER 1 tests verify placeholder usage

**Authentication:**
- POST /api/warnings/log: No auth (child can log warnings)
- GET /admin/warnings: Auth required (parent review)
- Use `require_auth(request)` helper (TIER 2 Rule 10)

**Error Handling:**
- Don't expose internal errors to frontend
- Log errors server-side for debugging
- Return generic Norwegian error messages

[Source: architecture/coding-standards.md#tier-1-rule-6, architecture/security-implementation.md]

### Performance Considerations

**Database Indexes:**
- New index: `idx_warnings_date` on `limit_warnings(DATE(shown_at))`
- Enables efficient parent review queries
- Minimal impact on INSERT performance (few warnings per day)

**Video Filtering Performance:**
- Wind-down filtering adds WHERE clause: `duration_seconds <= ?`
- Uses existing index on videos table
- Fallback query (all videos) only if filtered list empty

**Frontend Performance:**
- Warning overlay: Minimal DOM manipulation (single append)
- Auto-dismiss: Single setTimeout (garbage collected after dismiss)
- CSS transitions: Hardware-accelerated (transform, opacity)
- No polling interval changes (remains 30s from Story 4.1)

[Source: architecture/database-schema.md#key-design-decisions]

## Testing

### Test Strategy

**TIER 1 Safety Tests (100% Coverage Required):**

These tests verify critical child safety rules and MUST pass before deployment.

Location: `tests/backend/services/test_warning_logging.py`

Required tests:
1. `test_log_warning_uses_sql_placeholders()` - Verify SQL injection prevention (TIER 1 Rule 6)
2. `test_log_warning_uses_utc_timestamp()` - Verify UTC enforcement (TIER 1 Rule 3)
3. `test_winddown_filtering_includes_banned_filter()` - Verify banned videos excluded during wind-down (TIER 1 Rule 1)

Mark all tests with `@pytest.mark.tier1` decorator.

**Integration Tests:**

Location: `tests/backend/test_routes_warnings.py`

Required tests:
1. `test_log_warning_creates_database_entry()` - Full API response validation
2. `test_log_warning_validates_warning_type()` - Input validation
3. `test_get_warnings_requires_authentication()` - Auth enforcement
4. `test_get_warnings_returns_todays_warnings()` - Date filtering

Location: `tests/backend/test_routes_winddown.py`

Required tests:
1. `test_videos_filtered_by_max_duration()` - Video filtering logic
2. `test_videos_fallback_when_none_fit()` - AC 13 fallback behavior
3. `test_videos_without_max_duration_returns_all()` - Default behavior unchanged

**Frontend Tests:**

Location: `frontend/src/child/warning-display.test.js`

Required tests:
1. Warning displays correct message for each threshold
2. Warning auto-dismisses after 3 seconds
3. Warning logs to backend API
4. Warning includes mascot placeholder
5. Audio chime called when warning shown

Location: `frontend/src/child/limit-tracker.test.js` (extend existing)

Required tests:
1. Threshold crossing detection (10‚Üí9, 5‚Üí4, 2‚Üí1)
2. No warning when staying above threshold
3. No duplicate warnings for same threshold
4. Threshold filtering when limit < 10 minutes
5. `warningTriggered` event emitted

Location: `frontend/src/child/video-grid.test.js`

Required tests:
1. Wind-down CSS classes applied
2. Video fetch includes max_duration param
3. Fallback to all videos when filtered list empty

### Running Tests

```bash
# Backend TIER 1 safety tests only
uv run pytest -m tier1 -v tests/backend/services/

# All backend tests with coverage
uv run pytest tests/backend/ -v --cov=backend --cov-report=html

# Frontend tests
npm test

# Frontend tests with coverage
npm run test:coverage

# Run all tests (backend + frontend)
uv run pytest tests/backend/ -v && npm test
```

[Source: architecture/test-strategy-and-standards.md]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-11-01 | 0.1 | Initial story draft created | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

*To be filled during implementation*

### Debug Log References

*To be filled during implementation*

### Completion Notes

*To be filled during implementation*

### File List

*To be filled during implementation*

## QA Results

*To be filled by QA Agent after implementation*
